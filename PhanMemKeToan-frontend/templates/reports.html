{% extends "base.html" %}
{% block title %}B√°o c√°o{% endblock %}
{% block content %}

<!-- Th√™m Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2 class="page-title"><i class="fas fa-chart-line"></i> B√°o c√°o</h2>



<!-- Tabs: styled like Kh√°ch h√†ng/Nh√¢n vi√™n -->
<div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
  <button class="tab-btn active" id="revenueTab" onclick="switchReportTab('revenue')" style="padding: 12px 24px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 5px;">Doanh thu</button>
  <button class="tab-btn" id="debtTab" onclick="switchReportTab('debt')" style="padding: 12px 24px; border: none; background: white; color: #666; cursor: pointer; border-radius: 5px 5px 0 0;">C√¥ng n·ª£</button>
</div>

<!-- Revenue Report Section -->
<div id="revenueSection">
<div class="report-container" style="margin-top: 16px;">
  <div class="report-left">
    <!-- Bi·ªÉu ƒë·ªì c·ªôt -->
    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; width: 100%; max-width: 800px;">
    <div style="margin-bottom: 10px; text-align: center;">
        <label style="font-weight: 600; color: #1565c0; font-size: 18px;">B√°o c√°o doanh thu theo s·∫£n ph·∫©m</label>
      </div>
      <div style="width: 100%; height: 400px; position: relative;">
        <canvas id="revenueChart" style="width: 100% !important; height: 100% !important;"></canvas>
    </div>
    </div>
  </div>

  <div class="report-right">
    <h3><i class="fas fa-boxes"></i> Th·ªëng k√™ s·∫£n ph·∫©m</h3>
    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 18px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; min-width: 120px;">T·ª´ ng√†y</label>
          <input type="date" id="fromDate" value="{{ revenue_data.data.summary.date_range.from_date if revenue_data and revenue_data.data and revenue_data.data.summary else '' }}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; min-width: 120px;">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate" value="{{ revenue_data.data.summary.date_range.to_date if revenue_data and revenue_data.data and revenue_data.data.summary else '' }}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; min-width: 120px;">S·ªë l∆∞·ª£ng ƒë√£ b√°n</label>
          <input type="text" id="soldQuantity" value="{{ revenue_data.data.summary.total_quantity_sold if revenue_data and revenue_data.data and revenue_data.data.summary else '0' }}" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; min-width: 120px;">S·ªë l∆∞·ª£ng c√≤n l·∫°i</label>
          <input type="text" id="remainingQuantity" value="{{ revenue_data.data.summary.total_quantity_remaining if revenue_data and revenue_data.data and revenue_data.data.summary else '20' }}" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: bold; min-width: 120px;">Doanh thu</label>
          <input type="text" id="totalRevenue" value="{{ '{:,.0f}'.format(revenue_data.data.summary.total_revenue) if revenue_data and revenue_data.data and revenue_data.data.summary else '0' }} VND" readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
        </div>
        <div class="report-buttons" style="display: flex; gap: 12px; justify-content: center;">
          <button onclick="printReport()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">In b√°o c√°o</button>
        </div>
      </div>
  </div>
</div>

  <!-- B·∫£ng d·ªØ li·ªáu b√°o c√°o doanh thu -->
  <div class="data-table-container">
    <h3>D·ªØ li·ªáu b√°o c√°o doanh thu</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th style="text-align:center;">STT</th>
          <th style="text-align:center;">T√™n sp</th>
          <th style="text-align:center;">Nh√≥m sp</th>
          <th style="text-align:center;">T·ª´ ng√†y</th>
          <th style="text-align:center;">ƒê·∫øn ng√†y</th>
          <th style="text-align:center;">S·ªë l∆∞·ª£ng</th>
          <th style="text-align:center;">Doanh thu</th>
        </tr>
      </thead>
      <tbody id="reportDataTableBody">
        {% if revenue_data and revenue_data.data and revenue_data.data.product_data %}
          {% for product in revenue_data.data.product_data %}
          <tr>
            <td style="text-align:center;">{{ loop.index }}</td>
            <td style="text-align:center;">{{ product.ten_san_pham }}</td>
            <td style="text-align:center;">{{ product.nhom_san_pham }}</td>
            <td style="text-align:center;">{{ product.tu_ngay }}</td>
            <td style="text-align:center;">{{ product.den_ngay }}</td>
            <td style="text-align:center;">{{ product.so_luong_ban }}</td>
            <td style="text-align:center;">{{ '{:,.0f}'.format(product.doanh_thu) }} VND</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Debt Report Section -->
<div id="debtSection" style="display: none;">
  <div class="filter-bar" style="display: flex; align-items: flex-end; gap: 15px; flex-wrap: wrap;">
    <div class="filter-item">
      <label>T√™n KH</label>
      <input type="text" id="customerName" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
        </div>
    <div class="filter-item">
      <label>Tr·∫°ng th√°i</label>
      <select id="thanhToanFilter">
        <option value="">T·∫•t c·∫£</option>
        <option value="con_no">ƒêang n·ª£</option>
        <option value="het_no">H·∫øt n·ª£</option>
      </select>
    </div>
    <button class="clear-btn" onclick="clearDebtFilter()" style="width: 120px; height: 38px; padding: 8px 16px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 0; align-self: center;"><i class="fas fa-times"></i> X√≥a b·ªô l·ªçc</button>
  </div>

  <div class="data-table-container">
    <h3>B√°o c√°o c√¥ng n·ª£</h3>
    <table class="data-table">
                        <thead>
                    <tr>
                      <th style="text-align:center; width: 200px;">T√™n kh√°ch h√†ng</th>
                      <th style="text-align:center; width: 150px;">T·ªïng c√¥ng n·ª£</th>
                      <th style="text-align:center; width: 150px;">ƒê√£ thanh to√°n</th>
                                              <th style="text-align:center; width: 150px;">ƒêang n·ª£</th>
                      <th style="text-align:center; width: 120px;">Tr·∫°ng th√°i</th>
                      <th style="text-align:center; width: 120px;">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
      <tbody>
          <tr>
          <td colspan="6" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<!-- Modal s·ª≠a tr·∫°ng th√°i c√¥ng n·ª£ -->
<div id="edit-debt-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header" style="justify-content:center; background: linear-gradient(135deg, #007bff, #0056b3);">
      <h3 style="margin:0; color:white;">C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng n·ª£</h3>
    </div>
    <div class="modal-body" style="padding:20px;">
      <div style="margin-bottom: 15px;">
        <strong>Kh√°ch h√†ng:</strong> <span id="edit-debt-customer-name"></span>
      </div>
      <div style="margin-bottom: 15px;">
        <strong>T·ªïng c√¥ng n·ª£:</strong> <span id="edit-debt-total"></span>
      </div>
      <div style="margin-bottom: 15px;">
        <strong>ƒê√£ thanh to√°n:</strong> <span id="edit-debt-paid"></span>
      </div>
      <div style="margin-bottom: 15px;">
                                <strong>ƒêang n·ª£:</strong> <span id="edit-debt-remaining"></span>
      </div>
      <div style="margin-bottom: 20px;">
        <label><strong>ƒê√£ thanh to√°n:</strong></label>
        <input type="text" id="edit-debt-paid-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thanh to√°n (ƒë·ªÉ tr·ªëng n·∫øu ch∆∞a thanh to√°n)" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
    </div>
    <div class="modal-footer" style="padding: 15px 20px; text-align:center; border-top:1px solid #eee;">
      <button onclick="saveDebtChanges()" style="background:#28a745; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">L∆∞u</button>
      <button onclick="closeEditDebtModal()" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">H·ªßy</button>
    </div>
    </div>
  </div>

  <script>
function switchReportTab(tab) {
    const revenueBtn = document.getElementById('revenueTab');
    const debtBtn = document.getElementById('debtTab');
    const revenueSection = document.getElementById('revenueSection');
    const debtSection = document.getElementById('debtSection');
    if (tab === 'revenue') {
        revenueBtn.classList.add('active');
        revenueBtn.style.background = '#007bff';
        revenueBtn.style.color = '#fff';
        debtBtn.classList.remove('active');
        debtBtn.style.background = 'white';
        debtBtn.style.color = '#666';
        revenueSection.style.display = 'block';
        debtSection.style.display = 'none';
    } else if (tab === 'debt') {
        debtBtn.classList.add('active');
        debtBtn.style.background = '#007bff';
        debtBtn.style.color = '#fff';
        revenueBtn.classList.remove('active');
        revenueBtn.style.background = 'white';
        revenueBtn.style.color = '#666';
        revenueSection.style.display = 'none';
        debtSection.style.display = 'block';
        // Load d·ªØ li·ªáu c√¥ng n·ª£ khi chuy·ªÉn sang tab n√†y
        loadDebtReport();
    }
}

// H√†m t·∫°o b√°o c√°o
async function generateReport() {
    console.log('generateReport() called');
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    console.log('Dates:', fromDate, toDate);
    
    if (!fromDate || !toDate) {
        showErrorPopup('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian!');
        return;
    }
    
    if (new Date(toDate) < new Date(fromDate)) {
        showErrorPopup('Ng√†y k·∫øt th√∫c ph·∫£i l·ªõn h∆°n ng√†y b·∫Øt ƒë·∫ßu!');
        return;
    }
    
    const daysDiff = Math.ceil((new Date(toDate) - new Date(fromDate)) / (1000 * 60 * 60 * 24));
    if (daysDiff > 31) {
        showErrorPopup('Kho·∫£ng th·ªùi gian t·ªëi ƒëa l√† 31 ng√†y!');
        return;
      }

    try {
        const url = `{{ BACKEND_URL }}/api/reports/revenue-by-date?from_date=${fromDate}&to_date=${toDate}`;
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            renderChart(data.data);
            updateSummaryFields(data.data.summary);
            renderReportTable(data.data); // Render b·∫£ng d·ªØ li·ªáu
  } else {
            showErrorPopup('L·ªói: ' + (data.detail || 'Kh√¥ng th·ªÉ t·∫°o b√°o c√°o'));
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorPopup('L·ªói khi t·∫°o b√°o c√°o!');
    }
}

// H√†m render b·∫£ng b√°o c√°o (gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch)
function renderReportTable(reportData) {
    const tableBody = document.getElementById('reportDataTableBody');
    
    // X√≥a c√°c d√≤ng c≈©
    tableBody.innerHTML = '';
    
    // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m
    if (!reportData.product_data || reportData.product_data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
    }
    
    // Th√™m c√°c d√≤ng m·ªõi cho t·ª´ng s·∫£n ph·∫©m
    reportData.product_data.forEach((product, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center;">${index + 1}</td>
            <td style="text-align:center;">${product.ten_san_pham}</td>
            <td style="text-align:center;">${product.nhom_san_pham}</td>
            <td style="text-align:center;">${product.tu_ngay}</td>
            <td style="text-align:center;">${product.den_ngay}</td>
            <td style="text-align:center;">${product.so_luong_ban}</td>
                            <td style="text-align:center;">${product.doanh_thu.toLocaleString('en-US')} VND</td>
        `;
        tableBody.appendChild(tr);
    });
}

// H√†m c·∫≠p nh·∫≠t c√°c tr∆∞·ªùng t·ªïng
function updateSummaryFields(summary) {
            document.getElementById('soldQuantity').value = summary.total_quantity_sold.toLocaleString('en-US');
        document.getElementById('remainingQuantity').value = summary.total_quantity_remaining.toLocaleString('en-US');
        document.getElementById('totalRevenue').value = summary.total_revenue.toLocaleString('en-US') + ' VND';
}

// H√†m render bi·ªÉu ƒë·ªì c·ªôt
let currentChart = null;

// H√†m load d·ªØ li·ªáu t·ª´ backend v√† v·∫Ω bi·ªÉu ƒë·ªì
async function loadRevenueData() {
    try {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        

        console.log('üîÑ loadRevenueData called with dates:', fromDate, 'to', toDate);
        
        if (!fromDate || !toDate) {
            console.log('‚ö†Ô∏è Ch∆∞a ch·ªçn ng√†y, s·ª≠ d·ª•ng ng√†y h√¥m nay');
            return;
        }
        
        // Ki·ªÉm tra xem c√≥ c·∫ßn load d·ªØ li·ªáu kh√¥ng
        const currentSoldQuantity = document.getElementById('soldQuantity').value;
        const currentTotalRevenue = document.getElementById('totalRevenue').value;
        
        // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu v√† ng√†y kh√¥ng thay ƒë·ªïi, kh√¥ng c·∫ßn load l·∫°i
        if (currentSoldQuantity !== '0' && currentTotalRevenue !== '0 VND') {
            console.log('‚úÖ Data already exists, checking if dates changed...');
            
            // Ch·ªâ load l·∫°i n·∫øu ng√†y thay ƒë·ªïi
            const fromDateInput = document.getElementById('fromDate');
            const toDateInput = document.getElementById('toDate');
            
            if (fromDateInput.dataset.lastFromDate === fromDate && 
                toDateInput.dataset.lastToDate === toDate) {
                console.log('üìÖ Dates unchanged, skipping API call');
                return;
            }
        }
        
        console.log('üåê Fetching from backend:', `{{ BACKEND_URL }}/api/reports/revenue-by-date?from_date=${fromDate}&to_date=${toDate}`);
        
        const response = await fetch(`{{ BACKEND_URL }}/api/reports/revenue-by-date?from_date=${fromDate}&to_date=${toDate}`);
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', response.headers);
        
        const data = await response.json();
        console.log('üìä Revenue data received:', data);
        
        if (data.success && data.data) {
            console.log('‚úÖ Data loaded successfully, updating UI...');
            
            // C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng th·ªëng k√™
            const soldQuantity = data.data.summary.total_quantity_sold || '0';
            const remainingQuantity = data.data.summary.total_quantity_remaining || '0';
            const totalRevenue = data.data.summary.total_revenue || 0;
            
            console.log('üìà Summary data:', { soldQuantity, remainingQuantity, totalRevenue });
            
            document.getElementById('soldQuantity').value = soldQuantity;
            document.getElementById('remainingQuantity').value = remainingQuantity;
            document.getElementById('totalRevenue').value = `${totalRevenue.toLocaleString()} VND`;
            
            // L∆∞u ng√†y hi·ªán t·∫°i ƒë·ªÉ so s√°nh l·∫ßn sau
            document.getElementById('fromDate').dataset.lastFromDate = fromDate;
            document.getElementById('toDate').dataset.lastToDate = toDate;
            
            // V·∫Ω bi·ªÉu ƒë·ªì
            console.log('üé® Rendering chart...');
            renderChart(data.data);
            
            // C·∫≠p nh·∫≠t b·∫£ng d·ªØ li·ªáu
            console.log('üìã Updating report table...');
            updateReportTable(data.data.product_data || []);
            
            console.log('‚úÖ UI updated successfully');
        } else {
            console.error('‚ùå Failed to load revenue data:', data);
        }
    } catch (error) {
        console.error('üí• Error loading revenue data:', error);
    }
}

// H√†m l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì t·ª´ backend (template)
function getChartDataFromBackend() {
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ backend kh√¥ng
    const soldQuantity = document.getElementById('soldQuantity').value;
    const totalRevenue = document.getElementById('totalRevenue').value;
    
    if (soldQuantity === '0' && totalRevenue === '0 VND') {
        return null;
    }
    
    // T·∫°o d·ªØ li·ªáu bi·ªÉu ƒë·ªì t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    // Parse dates
    const startDate = new Date(fromDate);
    const endDate = new Date(toDate);
    
    // T·∫°o array ng√†y
    const dates = [];
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().split('T')[0]);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // T·∫°o d·ªØ li·ªáu bi·ªÉu ƒë·ªì
    const columns = dates.map(date => {
        const dateStr = new Date(date).toLocaleDateString('vi-VN');
        return {
            date: dateStr,
            date_key: date,
            revenue: 0, // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t n·∫øu c√≥ d·ªØ li·ªáu chi ti·∫øt
            quantity_sold: 0,
            quantity_remaining: parseInt(document.getElementById('remainingQuantity').value) || 0
        };
    });
    
    // N·∫øu c√≥ d·ªØ li·ªáu, c·∫≠p nh·∫≠t ng√†y c√≥ doanh thu
    if (parseInt(soldQuantity) > 0) {
        // Gi·∫£ s·ª≠ doanh thu t·∫≠p trung v√†o ng√†y cu·ªëi
        const lastColumn = columns[columns.length - 1];
        lastColumn.revenue = parseFloat(totalRevenue.replace(/[^0-9]/g, '')) || 0;
        lastColumn.quantity_sold = parseInt(soldQuantity) || 0;
    }
    
    return {
        columns: columns,
        product_data: [] // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t n·∫øu c√≥ d·ªØ li·ªáu chi ti·∫øt
    };
}

// H√†m c·∫≠p nh·∫≠t b·∫£ng d·ªØ li·ªáu
function updateReportTable(productData) {
    const tbody = document.getElementById('reportDataTableBody');
    
    if (!productData || productData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
    }
    
    let html = '';
    productData.forEach((product, index) => {
        html += `
            <tr>
                <td style="text-align:center;">${index + 1}</td>
                <td style="text-align:center;">${product.ten_san_pham || ''}</td>
                <td style="text-align:center;">${product.nhom_san_pham || ''}</td>
                <td style="text-align:center;">${product.tu_ngay || ''}</td>
                <td style="text-align:center;">${product.den_ngay || ''}</td>
                <td style="text-align:center;">${product.so_luong_ban || 0}</td>
                <td style="text-align:center;">${(product.doanh_thu || 0).toLocaleString()} VND</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Event listeners cho date inputs
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM Content Loaded - Reports page');
    
    // L∆∞u d·ªØ li·ªáu t·ª´ backend v√†o bi·∫øn global
    window.revenueDataFromBackend = null;
    console.log('üíæ Backend data variable initialized');
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ backend kh√¥ng
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    console.log('üìÖ From date input value:', fromDateInput.value);
    console.log('üìÖ To date input value:', toDateInput.value);
    
    // N·∫øu kh√¥ng c√≥ gi√° tr·ªã t·ª´ backend, set ng√†y m·∫∑c ƒë·ªãnh
    if (!fromDateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        fromDateInput.value = today;
        toDateInput.value = today;
        console.log('üìÖ Set default dates:', today);
    }
    
    // Ch·ªâ load d·ªØ li·ªáu t·ª´ API n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ backend
    const soldQuantity = document.getElementById('soldQuantity').value;
    const totalRevenue = document.getElementById('totalRevenue').value;
    
    if (soldQuantity === '0' && totalRevenue === '0 VND') {
        console.log('üîÑ No data from backend, loading from API...');
        loadRevenueData();
    } else {
        console.log('‚úÖ Data already loaded from backend, skipping API call');
        // V·∫Ω bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu t·ª´ backend n·∫øu c√≥
        const chartData = getChartDataFromBackend();
        if (chartData) {
            renderChart(chartData);
        }
        
        // N·∫øu c√≥ d·ªØ li·ªáu t·ª´ backend, c·∫≠p nh·∫≠t b·∫£ng d·ªØ li·ªáu
        if (window.revenueDataFromBackend && window.revenueDataFromBackend.data && window.revenueDataFromBackend.data.product_data) {
            updateReportTable(window.revenueDataFromBackend.data.product_data);
        }
    }
    
    // Event listeners cho date changes
    fromDateInput.addEventListener('change', loadRevenueData);
    toDateInput.addEventListener('change', loadRevenueData);
    
    console.log('‚úÖ Event listeners attached');
});

function renderChart(reportData) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
    if (currentChart) {
        currentChart.destroy();
    }
    
    // T·∫°o d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì t·ª´ reportData.columns
    const chartData = {
        labels: reportData.columns.map(col => col.date),
        revenue: reportData.columns.map(col => col.revenue),
        quantitySold: reportData.columns.map(col => col.quantity_sold),
        quantityRemaining: reportData.columns.map(col => col.quantity_remaining)
    };
    
    currentChart = new Chart(ctx, {
    type: 'bar',
    data: {
            labels: chartData.labels,
      datasets: [{
                label: 'Doanh thu (VND)',
                data: chartData.revenue,
                backgroundColor: 'rgba(0, 123, 255, 0.6)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'S·ªë l∆∞·ª£ng ƒë√£ b√°n',
                data: chartData.quantitySold,
                backgroundColor: 'rgba(40, 167, 69, 0.6)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Ng√†y'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Doanh thu (VND)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'S·ªë l∆∞·ª£ng'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return Math.round(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Bi·ªÉu ƒë·ªì doanh thu v√† s·ªë l∆∞·ª£ng theo ng√†y',
                    font: {
                        size: 16
                    }
                }
            }
        }
    });
}

// H√†m in b√°o c√°o
function printReport() {
    const reportTable = document.querySelector('.data-table');
    if (!reportTable || reportTable.rows.length <= 1) {
        showErrorPopup('Vui l√≤ng t·∫°o b√°o c√°o tr∆∞·ªõc khi in!');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>B√°o c√°o doanh thu</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                th { background-color: #007bff; color: white; }
                .summary { margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
            </style>
        </head>
        <body>
            <h2>B√°o c√°o doanh thu theo s·∫£n ph·∫©m</h2>
            <div class="summary">
                <p><strong>T·ª´ ng√†y:</strong> ${document.getElementById('fromDate').value}</p>
                <p><strong>ƒê·∫øn ng√†y:</strong> ${document.getElementById('toDate').value}</p>
                <p><strong>T·ªïng s·ªë l∆∞·ª£ng ƒë√£ b√°n:</strong> ${document.getElementById('soldQuantity').value}</p>
                <p><strong>S·ªë l∆∞·ª£ng c√≤n l·∫°i:</strong> ${document.getElementById('remainingQuantity').value}</p>
                <p><strong>T·ªïng doanh thu:</strong> ${document.getElementById('totalRevenue').value}</p>
            </div>
            ${reportTable.outerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Load d·ªØ li·ªáu c√¥ng n·ª£ t·ª´ API
async function loadDebtReport() {
    try {
        // L·∫•y ng√†y hi·ªán t·∫°i
        const today = new Date();
        const fromDate = today.toISOString().split('T')[0];
        const toDate = today.toISOString().split('T')[0];
        
        // S·ª≠ d·ª•ng API m·ªõi v·ªõi b·∫£ng debts
        const response = await fetch(`{{ BACKEND_URL }}/api/reports/debt-by-date?from_date=${fromDate}&to_date=${toDate}`);
        const data = await response.json();
        
        if (data.success) {
            renderDebtTable(data.data);
        } else {
            console.error('L·ªói khi t·∫£i b√°o c√°o c√¥ng n·ª£:', data.detail);
        }
    } catch (error) {
        console.error('L·ªói khi t·∫£i b√°o c√°o c√¥ng n·ª£:', error);
    }
}

// Render b·∫£ng c√¥ng n·ª£
function renderDebtTable(debtData) {
    const tbody = document.querySelector('#debtSection tbody');
    
    if (!debtData || debtData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    debtData.forEach((item, index) => {
        // T√≠nh to√°n s·ªë ti·ªÅn hi·ªÉn th·ªã trong c·ªôt "ƒê√£ thanh to√°n"
        // Ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa b·∫±ng t·ªïng n·ª£, kh√¥ng v∆∞·ª£t qu√°
        const displayPaidAmount = Math.min(parseFloat(item.paid_amount), parseFloat(item.total_debt));
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center;">${item.customer_name}</td>
            <td style="text-align:center;">${parseFloat(item.total_debt).toLocaleString('en-US')} VND</td>
            <td style="text-align:center;">${displayPaidAmount.toLocaleString('en-US')} VND</td>
            <td style="text-align:center;">${parseFloat(item.remaining_debt).toLocaleString('en-US')} VND</td>
            <td style="text-align:center;">
                <span style="color: ${item.remaining_debt > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">
                    ${item.remaining_debt > 0 ? 'ƒêang n·ª£' : 'H·∫øt n·ª£'}
                </span>
            </td>
            <td style="text-align:center;">
                <button onclick="editDebtStatus('${item.customer_name}')" style="background: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-edit"></i> S·ª≠a
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function autoSearchDebt() {
    const customerName = document.getElementById('customerName').value.toLowerCase();
    const thanhToanFilter = document.getElementById('thanhToanFilter').value;
    const rows = document.querySelectorAll('#debtSection tbody tr');
    rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const status = row.cells[4].textContent.toLowerCase();
        const nameMatch = !customerName || name.includes(customerName);
        let thanhToanMatch = true;
        if (thanhToanFilter === 'con_no') {
            thanhToanMatch = parseFloat(row.cells[3].textContent.replace(/[^0-9]/g, '')) > 0;
        } else if (thanhToanFilter === 'het_no') {
            thanhToanMatch = parseFloat(row.cells[3].textContent.replace(/[^0-9]/g, '')) === 0;
        }
        row.style.display = (nameMatch && thanhToanMatch) ? '' : 'none';
    });
}

// S·ª≠a tr·∫°ng th√°i c√¥ng n·ª£ c·ªßa kh√°ch h√†ng
function editDebtStatus(customerName) {
    // M·ªü modal ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n
    openEditDebtModal(customerName);
}

function clearDebtFilter() {
    document.getElementById('customerName').value = '';
    document.getElementById('thanhToanFilter').value = '';
    const rows = document.querySelectorAll('#debtSection tbody tr');
    rows.forEach(row => { row.style.display = ''; });
}

// M·ªü modal s·ª≠a tr·∫°ng th√°i c√¥ng n·ª£
function openEditDebtModal(customerName) {
    // T√¨m d·ªØ li·ªáu c·ªßa kh√°ch h√†ng n√†y
    const rows = document.querySelectorAll('#debtSection tbody tr');
    let customerData = null;
    
    rows.forEach(row => {
        if (row.cells[0].textContent === customerName) {
            customerData = {
                customer_name: row.cells[0].textContent,
                total_debt: parseFloat(row.cells[1].textContent.replace(/[^0-9]/g, '')),
                paid_amount: parseFloat(row.cells[2].textContent.replace(/[^0-9]/g, '')),
                remaining_debt: parseFloat(row.cells[3].textContent.replace(/[^0-9]/g, ''))
            };
        }
    });
    
    if (customerData) {
        // ƒêi·ªÅn th√¥ng tin v√†o modal
        document.getElementById('edit-debt-customer-name').textContent = customerData.customer_name;
        document.getElementById('edit-debt-total').textContent = customerData.total_debt.toLocaleString('en-US') + ' VND';
        
        // Hi·ªÉn th·ªã s·ªë ti·ªÅn ƒë√£ thanh to√°n (t·ªëi ƒëa b·∫±ng t·ªïng n·ª£)
        const displayPaidAmount = Math.min(customerData.paid_amount, customerData.total_debt);
        document.getElementById('edit-debt-paid').textContent = displayPaidAmount.toLocaleString('en-US') + ' VND';
        
        document.getElementById('edit-debt-remaining').textContent = customerData.remaining_debt.toLocaleString('en-US') + ' VND';
        
        // ƒê·ªÉ tr·ªëng input "ƒê√£ thanh to√°n" ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p s·ªë ti·ªÅn m·ªõi
        document.getElementById('edit-debt-paid-amount').value = '';
        
        // Hi·ªÉn th·ªã modal
        document.getElementById('edit-debt-modal').style.display = 'flex';
        
        // Kh√¥ng c·∫ßn l∆∞u d·ªØ li·ªáu ban ƒë·∫ßu v√¨ input s·∫Ω tr·ªëng
        window.originalEditDebtData = {
            paid_amount: 0
        };
        
        // L∆∞u d·ªØ li·ªáu ƒë·ªÉ s·ª≠ d·ª•ng khi l∆∞u
        window.currentEditDebtData = customerData;
        
        // ƒê√°nh d·∫•u r·∫±ng modal ƒë√£ ƒë∆∞·ª£c m·ªü v·ªõi d·ªØ li·ªáu
        window.modalHasData = true;
        
        // G·∫Øn event listener cho input "ƒê√£ thanh to√°n" sau khi c√≥ d·ªØ li·ªáu
        setupPaidAmountInputListener();
    }
}

// ƒê√≥ng modal s·ª≠a tr·∫°ng th√°i c√¥ng n·ª£
function closeEditDebtModal() {
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu trong input kh√¥ng
    const inputValue = document.getElementById('edit-debt-paid-amount').value.replace(/[^\d]/g, '');
    const currentPaidAmount = parseInt(inputValue) || 0;
    
    // N·∫øu c√≥ nh·∫≠p s·ªë ti·ªÅn (kh√°c 0), hi·ªÉn th·ªã x√°c nh·∫≠n
    if (currentPaidAmount > 0) {
        // D√πng popup x√°c nh·∫≠n ti√™u chu·∫©n thay cho confirm()
        showConfirmationPopup(
            'X√°c nh·∫≠n',
            'B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u. B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?',
            () => {
                document.getElementById('edit-debt-modal').style.display = 'none';
                resetEditDebtModal();
            },
            () => { /* Cancel: kh√¥ng l√†m g√¨ */ }
        );
    } else {
        // Kh√¥ng c√≥ thay ƒë·ªïi, tho√°t lu√¥n
        document.getElementById('edit-debt-modal').style.display = 'none';
        resetEditDebtModal();
    }
}

// Reset modal v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
function resetEditDebtModal() {
    document.getElementById('edit-debt-paid-amount').value = '';
    window.originalEditDebtData = null;
    window.currentEditDebtData = null;
    window.modalHasData = false;
    
    // X√≥a th√¥ng b√°o validation
    const validationMessage = document.getElementById('validation-message');
    if (validationMessage) {
        validationMessage.remove();
    }
}

// X·ª≠ l√Ω click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
document.addEventListener('DOMContentLoaded', function() {
    const editDebtModal = document.getElementById('edit-debt-modal');
    if (editDebtModal) {
        editDebtModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditDebtModal();
            }
        });
    }
    
            // X·ª≠ l√Ω input "ƒê√£ thanh to√°n" - ch·ªâ cho ph√©p nh·∫≠p s·ªë nguy√™n v√† t·ª± ƒë·ªông format d·∫•u ph·∫©y
    const paidAmountInput = document.getElementById('edit-debt-paid-amount');
    if (paidAmountInput) {
            // Debug: log th√¥ng tin ƒë·ªÉ ki·ªÉm tra
            console.log('Debug - currentEditDebtData:', window.currentEditDebtData);
            console.log('Debug - total_debt value:', window.currentEditDebtData ? window.currentEditDebtData.total_debt : 'undefined');
        // G·ªôp t·∫•t c·∫£ logic v√†o m·ªôt event listener input
        paidAmountInput.addEventListener('input', function(e) {
            // L·∫•y gi√° tr·ªã hi·ªán t·∫°i v√† lo·∫°i b·ªè d·∫•u ph·∫©y
            let value = this.value.replace(/[^\d]/g, '');
            
            // Ch·ªâ format l·∫°i d·∫•u ph·∫©y khi user ƒë√£ nh·∫≠p xong (kh√¥ng ph·∫£i khi ƒëang nh·∫≠p)
            if (value && value.length > 3) {
                const numericValue = parseInt(value);
                this.value = numericValue.toLocaleString('en-US');
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o validation real-time
            const currentAmount = parseInt(value) || 0;
            const totalDebt = window.currentEditDebtData ? window.currentEditDebtData.total_debt : 0;
            
            // T·∫°o ho·∫∑c c·∫≠p nh·∫≠t th√¥ng b√°o validation
            let validationMessage = document.getElementById('validation-message');
            if (!validationMessage) {
                validationMessage = document.createElement('div');
                validationMessage.id = 'validation-message';
                validationMessage.style.cssText = 'margin-top: 5px; font-size: 12px; padding: 5px; border-radius: 3px;';
                this.parentNode.appendChild(validationMessage);
            }
            
            // Ki·ªÉm tra totalDebt c√≥ h·ª£p l·ªá kh√¥ng
            if (!totalDebt || isNaN(totalDebt) || totalDebt <= 0) {
                validationMessage.innerHTML = `‚ùå L·ªói: Kh√¥ng th·ªÉ l·∫•y th√¥ng tin t·ªïng n·ª£`;
                validationMessage.style.backgroundColor = '#f8d7da';
                validationMessage.style.color = '#721c24';
                validationMessage.style.border = '1px solid #f5c6cb';
                return;
            }
            
            // T√≠nh to√°n t·ªïng s·ªë ti·ªÅn ƒë√£ thanh to√°n sau khi nh·∫≠p (ƒë√£ tr·∫£ tr∆∞·ªõc ƒë√≥ + v·ª´a nh·∫≠p)
            const previouslyPaidAmount = window.currentEditDebtData ? window.currentEditDebtData.paid_amount : 0;
            const totalPaidAfterInput = previouslyPaidAmount + currentAmount;
            
            // T√≠nh s·ªë ti·ªÅn c√≤n n·ª£ sau khi nh·∫≠p
            const remainingDebtAfterInput = totalDebt - totalPaidAfterInput;
            
            if (totalPaidAfterInput > totalDebt) {
                // V∆∞·ª£t qu√° t·ªïng c√¥ng n·ª£ ‚Üí Ti·ªÅn th·ª´a
                const excessAmount = totalPaidAfterInput - totalDebt;
                validationMessage.innerHTML = `üí∞ Ti·ªÅn th·ª´a: <strong>${excessAmount.toLocaleString('en-US')} VND</strong><br>üí≥ ƒêang n·ª£: <strong>0 VND</strong>`;
                validationMessage.style.backgroundColor = '#fff3cd';
                validationMessage.style.color = '#856404';
                validationMessage.style.border = '1px solid #ffeaa7';
            } else if (totalPaidAfterInput === totalDebt) {
                // Thanh to√°n ƒë·ªß ‚Üí H·∫øt n·ª£
                validationMessage.innerHTML = `‚úÖ Thanh to√°n ƒë·ªß! Kh√°ch h√†ng s·∫Ω h·∫øt n·ª£<br>üí≥ ƒêang n·ª£: <strong>0 VND</strong>`;
                validationMessage.style.backgroundColor = '#d4edda';
                validationMessage.style.color = '#155724';
                validationMessage.style.border = '1px solid #c3e6cb';
            } else if (currentAmount > 0) {
                // Ch∆∞a thanh to√°n ƒë·ªß ‚Üí C√≤n n·ª£
                validationMessage.innerHTML = `üí≥ ƒêang n·ª£: <strong>${remainingDebtAfterInput.toLocaleString('en-US')} VND</strong>`;
                validationMessage.style.backgroundColor = '#e2e3e5';
                validationMessage.style.color = '#383d41';
                validationMessage.style.border = '1px solid #d6d8db';
            } else {
                validationMessage.innerHTML = '';
            }
        });
        
        // X·ª≠ l√Ω khi focus v√†o input - KH√îNG l√†m g√¨, gi·ªØ nguy√™n d·∫•u ph·∫©y
        paidAmountInput.addEventListener('focus', function() {
            // Kh√¥ng l√†m g√¨ khi focus, gi·ªØ nguy√™n gi√° tr·ªã hi·ªán t·∫°i v·ªõi d·∫•u ph·∫©y
        });
        
        // X·ª≠ l√Ω khi blur kh·ªèi input - format l·∫°i v·ªõi d·∫•u ph·∫©y
        paidAmountInput.addEventListener('blur', function() {
            const value = this.value.replace(/[^\d]/g, '');
            if (value) {
                const numericValue = parseInt(value);
                this.value = numericValue.toLocaleString('en-US');
            }
            // Kh√¥ng x√≥a gi√° tr·ªã n·∫øu user ch∆∞a nh·∫≠p g√¨
        });
        
        // NgƒÉn ch·∫∑n nh·∫≠p k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
        paidAmountInput.addEventListener('keypress', function(e) {
            // Ch·ªâ cho ph√©p s·ªë v√† m·ªôt s·ªë ph√≠m ƒëi·ªÅu h∆∞·ªõng
            const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 
                               'Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            
            if (!allowedKeys.includes(e.key) && !/^\d$/.test(e.key)) {
                e.preventDefault();
            }
        });
        
        // Th√™m maxlength ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ th·ªÉ nh·∫≠p s·ªë d√†i
        paidAmountInput.setAttribute('maxlength', '20');
        
        // Th√™m pattern ƒë·ªÉ ch·ªâ cho ph√©p s·ªë v√† d·∫•u ph·∫©y
        paidAmountInput.setAttribute('pattern', '[0-9,]*');
    }
});

// L∆∞u thay ƒë·ªïi c√¥ng n·ª£
async function saveDebtChanges() {
    // L·∫•y gi√° tr·ªã t·ª´ input v√† lo·∫°i b·ªè d·∫•u ph·∫©y ƒë·ªÉ parse th√†nh s·ªë
    const inputValue = document.getElementById('edit-debt-paid-amount').value.replace(/[^\d]/g, '');
    const newPaidAmount = parseInt(inputValue) || 0;
    const originalPaidAmount = window.originalEditDebtData ? window.originalEditDebtData.paid_amount : 0;
    const totalDebt = window.currentEditDebtData.total_debt;
    const customerName = window.currentEditDebtData.customer_name;
    
    if (newPaidAmount < 0) {
        showErrorPopup('S·ªë ti·ªÅn ƒë√£ thanh to√°n kh√¥ng th·ªÉ √¢m!');
        return;
    }
    
    // X·ª≠ l√Ω logic c·∫≠p nh·∫≠t
    if (newPaidAmount === originalPaidAmount) {
        showErrorPopup('Kh√¥ng c√≥ thay ƒë·ªïi n√†o!');
        return;
    }
    
    // T√≠nh t·ªïng s·ªë ti·ªÅn ƒë√£ thanh to√°n sau khi nh·∫≠p (ƒë√£ tr·∫£ tr∆∞·ªõc ƒë√≥ + v·ª´a nh·∫≠p)
    const previouslyPaidAmount = window.currentEditDebtData ? window.currentEditDebtData.paid_amount : 0;
    const totalPaidAfterInput = previouslyPaidAmount + newPaidAmount;
    
    // Ki·ªÉm tra n·∫øu t·ªïng s·ªë ti·ªÅn ƒë√£ thanh to√°n v∆∞·ª£t qu√° t·ªïng c√¥ng n·ª£
    if (totalPaidAfterInput > totalDebt) {
        const excessAmount = totalPaidAfterInput - totalDebt;
        
        // Hi·ªÉn th·ªã popup x√°c nh·∫≠n t√πy ch·ªânh thay v√¨ confirm()
        showConfirmationPopup(
            'X√°c nh·∫≠n thanh to√°n v∆∞·ª£t m·ª©c',
            `T·ªïng s·ªë ti·ªÅn ƒë√£ thanh to√°n (${totalPaidAfterInput.toLocaleString('en-US')} VND) v∆∞·ª£t qu√° t·ªïng c√¥ng n·ª£ (${totalDebt.toLocaleString('en-US')} VND).`,
            `C·∫ßn th·ªëi l·∫°i: ${excessAmount.toLocaleString('en-US')} VND`,
            async () => {
                // Callback khi user x√°c nh·∫≠n - th·ª±c hi·ªán l∆∞u d·ªØ li·ªáu
                await saveDebtDataToBackend(newPaidAmount, customerName, totalDebt, excessAmount);
            },
            () => {
                // Callback khi user h·ªßy - kh√¥ng l√†m g√¨
                console.log('User cancelled excess payment confirmation');
            }
        );
        return; // D·ª´ng h√†m ·ªü ƒë√¢y, ch·ªù user x√°c nh·∫≠n
    }
    
    // N·∫øu kh√¥ng v∆∞·ª£t qu√°, l∆∞u tr·ª±c ti·∫øp
    await saveDebtDataToBackend(newPaidAmount, customerName, totalDebt, 0);
}

// H√†m l∆∞u d·ªØ li·ªáu c√¥ng n·ª£ v√†o backend
async function saveDebtDataToBackend(newPaidAmount, customerName, totalDebt, excessAmount = 0) {
    try {
        // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n
        const response = await fetch(`{{ BACKEND_URL }}/api/reports/payment-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
                    body: JSON.stringify({
            customer_name: customerName,
            paid_amount: newPaidAmount + (window.currentEditDebtData ? window.currentEditDebtData.paid_amount : 0)
        })
        });
        
        const result = await response.json();
        console.log('Backend response:', result); // Debug log
        
        if (result.success) {
            // L·∫•y d·ªØ li·ªáu t·ª´ result.data
            const remainingDebt = result.data && result.data.remaining_debt !== undefined ? result.data.remaining_debt : 0;
            console.log('Remaining debt:', remainingDebt); // Debug log
            
            if (excessAmount > 0) {
                // Hi·ªÉn th·ªã popup th√†nh c√¥ng khi v∆∞·ª£t qu√°
                showSuccessMessage(
                    'C·∫≠p nh·∫≠t c√¥ng n·ª£ th√†nh c√¥ng',
                    `üí∞ S·ªë ti·ªÅn thanh to√°n: ${newPaidAmount.toLocaleString('en-US')} VND`,
                    `üí∏ C·∫ßn th·ªëi l·∫°i: ${excessAmount.toLocaleString('en-US')} VND`,
                    `üí≥ ƒêang n·ª£: 0 VND`,
                    `‚úÖ Tr·∫°ng th√°i: H·∫øt n·ª£`
                );
            } else if (remainingDebt === 0) {
                // Hi·ªÉn th·ªã popup th√†nh c√¥ng khi thanh to√°n ƒë·ªß
                showSuccessMessage(
                    'C·∫≠p nh·∫≠t c√¥ng n·ª£ th√†nh c√¥ng',
                    `üí∞ S·ªë ti·ªÅn thanh to√°n: ${newPaidAmount.toLocaleString('en-US')} VND`,
                    `üí≥ ƒêang n·ª£: 0 VND`,
                    `‚úÖ Tr·∫°ng th√°i: H·∫øt n·ª£`
                );
            } else {
                // Hi·ªÉn th·ªã popup th√†nh c√¥ng khi c√≤n n·ª£
                showSuccessMessage(
                    'C·∫≠p nh·∫≠t c√¥ng n·ª£ th√†nh c√¥ng',
                    `üí∞ S·ªë ti·ªÅn thanh to√°n: ${newPaidAmount.toLocaleString('en-US')} VND`,
                    `üí≥ ƒêang n·ª£: ${remainingDebt.toLocaleString('en-US')} VND`,
                    `üìä Tr·∫°ng th√°i: C√≤n n·ª£`
                );
            }
            
            document.getElementById('edit-debt-modal').style.display = 'none';
            resetEditDebtModal();
            
            // Chuy·ªÉn v·ªÅ tab C√¥ng n·ª£ v√† reload d·ªØ li·ªáu
            switchReportTab('debt');
            setTimeout(() => {
                loadDebtReport();
            }, 100);
        } else {
            showErrorPopup('L·ªói: ' + (result.detail || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n'));
        }
    } catch (error) {
        console.error('Error:', error);
        showErrorPopup('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n!');
    }
}

// Function to get today's date in YYYY-MM-DD format
function getTodayDateString() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Auto search listeners
document.addEventListener('DOMContentLoaded', function(){
  console.log('DOMContentLoaded triggered');
  
  // Set default dates to today (real time) - PRIORITY 1
  function setDefaultDates() {
    try {
      const todayStr = getTodayDateString();
      
      console.log('Setting default dates:', todayStr);
      
      const fromDateInput = document.getElementById('fromDate');
      const toDateInput = document.getElementById('toDate');
      
      if (fromDateInput && toDateInput) {
        fromDateInput.value = todayStr;
        toDateInput.value = todayStr;
        console.log('‚úÖ Default dates set successfully');
        return true;
      } else {
        console.error('‚ùå Date input elements not found');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error setting default dates:', error);
      return false;
    }
  }
  
  // Initialize page
  function initializePage() {
    // Set default dates first
    const datesSet = setDefaultDates();
    
    // Set up event listeners
  document.getElementById('customerName').addEventListener('input', autoSearchDebt);
  document.getElementById('thanhToanFilter').addEventListener('change', autoSearchDebt);
    
    // Switch to revenue tab
  switchReportTab('revenue');
  
    // Auto generate report if dates were set successfully
    if (datesSet) {
  console.log('Calling generateReport()');
      setTimeout(() => {
  generateReport();
      }, 100); // Small delay to ensure DOM is ready
    }
  
  // Add event listeners for date changes to auto-update summary fields
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    if (fromDateInput) {
      fromDateInput.addEventListener('change', function() {
        console.log('From date changed to:', this.value);
    if (document.getElementById('toDate').value) {
      generateReport();
    }
  });
    }
  
    if (toDateInput) {
      toDateInput.addEventListener('change', function() {
        console.log('To date changed to:', this.value);
    if (document.getElementById('fromDate').value) {
      generateReport();
    }
  });
    }
  }
  
  // Initialize the page
  initializePage();
  
  // Fallback: Try to set dates again after a short delay
  setTimeout(() => {
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    if (fromDateInput && !fromDateInput.value) {
      const todayStr = getTodayDateString();
      fromDateInput.value = todayStr;
      console.log('üîÑ Fallback: Set fromDate to', todayStr);
    }
    
    if (toDateInput && !toDateInput.value) {
      const todayStr = getTodayDateString();
      toDateInput.value = todayStr;
      console.log('üîÑ Fallback: Set toDate to', todayStr);
    }
  }, 500);
});

// H√†m hi·ªÉn th·ªã popup th√†nh c√¥ng
function showSuccessMessage(title, ...details) {
    // T·∫°o popup container
    const popup = document.createElement('div');
    popup.id = 'success-popup';
    popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    // T·∫°o popup content
    const popupContent = document.createElement('div');
    popupContent.style.cssText = `
        background: #fff;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // T·∫°o ti√™u ƒë·ªÅ
    const titleElement = document.createElement('h3');
    titleElement.textContent = title;
    titleElement.style.cssText = `
        color: #28a745;
        margin: 0 0 20px 0;
        font-size: 24px;
        font-weight: bold;
    `;
    
    // T·∫°o n·ªôi dung chi ti·∫øt
    const content = document.createElement('div');
    content.style.cssText = `
        margin: 20px 0;
        text-align: left;
        line-height: 1.6;
    `;
    
    details.forEach(detail => {
        const detailDiv = document.createElement('div');
        detailDiv.style.cssText = `
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        `;
        detailDiv.innerHTML = detail;
        content.appendChild(detailDiv);
    });
    
    // T·∫°o n√∫t x√°c nh·∫≠n
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'X√°c nh·∫≠n';
    confirmBtn.style.cssText = `
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
    `;
    
    confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.background = '#218838';
    });
    
    confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.background = '#28a745';
    });
    
    confirmBtn.addEventListener('click', () => {
        document.body.removeChild(popup);
    });
    
    // Th√™m CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
    
    // Gh√©p c√°c ph·∫ßn t·ª≠
    popupContent.appendChild(titleElement);
    popupContent.appendChild(content);
    popupContent.appendChild(confirmBtn);
    popup.appendChild(popupContent);
    
    // Hi·ªÉn th·ªã popup
    document.body.appendChild(popup);
}

// H√†m hi·ªÉn th·ªã popup x√°c nh·∫≠n
function showConfirmationPopup(title, ...messagesAndCallbacks) {
    // Extract onConfirm and onCancel from the end of the array
    const onCancel = messagesAndCallbacks.pop(); // Last argument is onCancel
    const onConfirm = messagesAndCallbacks.pop(); // Second to last is onConfirm
    const messages = messagesAndCallbacks; // Remaining are messages
    
    // T·∫°o popup container
    const popup = document.createElement('div');
    popup.id = 'confirmation-popup';
    popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    // T·∫°o popup content
    const popupContent = document.createElement('div');
    popupContent.style.cssText = `
        background: #fff;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // T·∫°o ti√™u ƒë·ªÅ
    const titleElement = document.createElement('h3');
    titleElement.textContent = title;
    titleElement.style.cssText = `
        color: #007bff;
        margin: 0 0 20px 0;
        font-size: 24px;
        font-weight: bold;
    `;
    
    // T·∫°o n·ªôi dung tin nh·∫Øn
    const messageContainer = document.createElement('div');
    messageContainer.style.cssText = `
        margin-bottom: 20px;
        color: #333;
    `;
    
    messages.forEach(msg => {
        const messageElement = document.createElement('p');
        messageElement.textContent = msg;
        messageElement.style.cssText = `
            font-size: 16px;
            line-height: 1.5;
            margin: 10px 0;
            text-align: center;
        `;
        messageContainer.appendChild(messageElement);
    });
    
    // T·∫°o n√∫t x√°c nh·∫≠n
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'X√°c nh·∫≠n';
    confirmBtn.style.cssText = `
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-right: 10px;
        transition: background 0.3s;
    `;
    
    // T·∫°o n√∫t h·ªßy
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'H·ªßy';
    cancelBtn.style.cssText = `
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
    `;
    
    // Th√™m hover effects
    confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.background = '#218838';
    });
    
    confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.background = '#28a745';
    });
    
    cancelBtn.addEventListener('mouseenter', () => {
        cancelBtn.style.background = '#5a6268';
    });
    
    cancelBtn.addEventListener('mouseleave', () => {
        cancelBtn.style.background = '#6c757d';
    });
    
    // Th√™m event listeners
    confirmBtn.addEventListener('click', () => {
        document.body.removeChild(popup);
        if (onConfirm) onConfirm();
    });
    
    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(popup);
        if (onCancel) onCancel();
    });
    
    // Gh√©p c√°c ph·∫ßn t·ª≠
    popupContent.appendChild(titleElement);
    popupContent.appendChild(messageContainer);
    popupContent.appendChild(confirmBtn);
    popupContent.appendChild(cancelBtn);
    popup.appendChild(popupContent);
    
    // Hi·ªÉn th·ªã popup
    document.body.appendChild(popup);
}

// H√†m hi·ªÉn th·ªã popup l·ªói
function showErrorPopup(message) {
    // T·∫°o popup container
    const popup = document.createElement('div');
    popup.id = 'error-popup';
    popup.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    // T·∫°o popup content
    const popupContent = document.createElement('div');
    popupContent.style.cssText = `
        background: #fff;
        border-radius: 10px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // T·∫°o icon l·ªói
    const errorIcon = document.createElement('div');
    errorIcon.innerHTML = '‚ùå';
    errorIcon.style.cssText = `
        font-size: 48px;
        margin-bottom: 20px;
    `;
    
    // T·∫°o ti√™u ƒë·ªÅ
    const title = document.createElement('h3');
    title.textContent = 'L·ªói';
    title.style.cssText = `
        color: #dc3545;
        margin: 0 0 20px 0;
        font-size: 24px;
        font-weight: bold;
    `;
    
    // T·∫°o n·ªôi dung l·ªói
    const content = document.createElement('div');
    content.textContent = message;
    content.style.cssText = `
        margin: 20px 0;
        color: #6c757d;
        line-height: 1.5;
    `;
    
    // T·∫°o n√∫t x√°c nh·∫≠n
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'X√°c nh·∫≠n';
    confirmBtn.style.cssText = `
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
    `;
    
    confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.background = '#c82333';
    });
    
    confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.background = '#dc3545';
    });
    
    confirmBtn.addEventListener('click', () => {
        document.body.removeChild(popup);
    });
    
    // Gh√©p c√°c ph·∫ßn t·ª≠
    popupContent.appendChild(errorIcon);
    popupContent.appendChild(title);
    popupContent.appendChild(content);
    popupContent.appendChild(confirmBtn);
    popup.appendChild(popupContent);
    
    // Hi·ªÉn th·ªã popup
    document.body.appendChild(popup);
}
</script>

{% endblock %}
    