{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω kho h√†ng{% endblock %}
{% block content %}

<h2 class="page-title"><i class="fas fa-warehouse"></i> Qu·∫£n l√Ω kho h√†ng</h2>

<div class="filter-bar">
  <div class="filter-item">
    <label>M√£ kho</label>
    <select id="filter-warehouse-code" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <option value="" disabled selected hidden>T·∫•t c·∫£ m√£ kho</option>
      {% for warehouse in warehouses %}
        <option value="{{ warehouse.ma_kho }}">{{ warehouse.ma_kho }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-item">
    <label>T√™n kho</label>
    <select id="filter-warehouse-name" style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <option value="" disabled selected hidden>T·∫•t c·∫£ t√™n kho</option>
      {% for warehouse in warehouses %}
        <option value="{{ warehouse.ten_kho }}">{{ warehouse.ten_kho }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-item">
    <label>Nh√≥m s·∫£n ph·∫©m</label>
    <select id="filter-group" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <option value="">T·∫•t c·∫£ nh√≥m</option>
      {% set uniq = namespace(groups=[]) %}
      {% for w in warehouses %}
        {% if w.nhom_san_pham and w.nhom_san_pham not in uniq.groups %}
          {% set _ = uniq.groups.append(w.nhom_san_pham) %}
        {% endif %}
      {% endfor %}
      {% if uniq.groups %}
        {% for g in uniq.groups %}
          <option value="{{ g }}">{{ g }}</option>
        {% endfor %}
      {% else %}
        <option value="" disabled>Kh√¥ng c√≥ nh√≥m</option>
      {% endif %}
    </select>
  </div>
  <div class="filter-item">
    <label>Tr·∫°ng th√°i</label>
    <select id="filter-status" style="width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      <option value="" disabled selected hidden>T·∫•t c·∫£</option>
      <option value="C√≤n h√†ng">C√≤n h√†ng</option>
      <option value="H·∫øt h√†ng">H·∫øt h√†ng</option>
    </select>
  </div>
  <button class="clear-btn" onclick="clearWarehouseFilters()" style="width: 120px; height: 38px; padding: 8px 16px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 0; align-self: center;"><i class="fas fa-times"></i> X√≥a b·ªô l·ªçc</button>
</div>

<div class="toolbar">
  <button onclick="showAddWarehouseModal()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
    <i class="fas fa-plus"></i> Th√™m kho h√†ng
  </button>
  <div style="margin-left:auto; text-align:right;">
    <div class="toolbar-totals" style="color:#000; font-weight:bold; font-size:14px; display:flex; align-items:center; gap:20px;">
      <span class="toolbar-total">T·ªïng: {{ warehouses|length if warehouses else 0 }} kho h√†ng</span>
      <span aria-hidden="true">|</span>
      <span class="toolbar-summary">T·ªïng nh√≥m s·∫£n ph·∫©m: <strong id="summary-groups">0</strong> nh√≥m</span>
      <span aria-hidden="true">|</span>
      <span class="toolbar-quantity">T·ªïng s·ªë l∆∞·ª£ng: <strong id="summary-quantity">0</strong></span>
    </div>
  </div>
</div>

<table class="product-table">
  <thead>
    <tr>
      <th style="text-align:center;">STT</th>
      <th style="text-align:center;">M√£ Kho</th>
      <th style="text-align:center;">T√™n kho</th>
      <th style="text-align:center;">ƒêi·ªán tho·∫°i</th>
      <th style="text-align:center;">ƒê·ªãa ch·ªâ</th>
      <th style="text-align:center;">Nh√≥m s·∫£n ph·∫©m</th>
      <th style="text-align:center;">S·ªë l∆∞·ª£ng</th>
      <th style="text-align:center;">Tr·∫°ng th√°i</th>
      <th style="text-align:center;">M√¥ t·∫£</th>
      <th style="text-align:center; width: 120px;">H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody>
    {% if warehouses %}
      {% for warehouse in warehouses %}
      
      <tr>
        <td style="text-align:center;">{{ loop.index }}</td>
        <td style="text-align:center;">{{ warehouse.ma_kho }}</td>
        <td style="text-align:center;">{{ warehouse.ten_kho }}</td>
        <td style="text-align:center;">{{ warehouse.dien_thoai or '' }}</td>
        <td style="text-align:center;">{{ warehouse.dia_chi }}</td>
        <td style="text-align:center;">{{ warehouse.nhom_san_pham or 'Ch∆∞a c√≥ nh√≥m' }}</td>
        <td style="text-align:center;">{{ warehouse.so_luong_sp or 0 }}</td>
        <td style="text-align:center;">{{ warehouse.trang_thai or 'C√≤n h√†ng' }}</td>
        <td style="text-align:center;">{{ warehouse.mo_ta or '' }}</td>
        <td style="text-align:center; padding: 5px;">
          <div style="display: flex; justify-content: center; gap: 1px;">
            <button class="btn-delete-warehouse" data-id="{{ warehouse.id }}" data-ma="{{ warehouse.ma_kho }}" data-qty="{{ warehouse.so_luong_sp or 0 }}" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; min-width: 50px; display: flex; align-items: center; justify-content: center;">X√≥a</button>
          </div>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="10" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<!-- Modal C·∫£nh b√°o (ki·ªÉu H√¨nh 1) -->
<div id="warehouseWarnModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:640px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd, #0a58ca); color:#fff; display:flex; justify-content:center; align-items:center;">
      <h3 style="margin:0; color:#fff; text-align:center; width:100%;">C·∫£nh b√°o</h3>
    </div>
    <div class="modal-body" style="text-align:center; padding:24px 12px 12px;">
      <div style="font-size:64px; color:#ffc107; line-height:1;">&#9888;</div>
      <p id="warehouseWarnMessage" style="margin-top:16px; font-size:16px; color:#333;">Kh√¥ng th·ªÉ x√≥a nh√≥m s·∫£n ph·∫©m n√†y v√¨ c√≤n h√†ng!</p>
    </div>
    <div class="modal-footer" style="display:flex; justify-content:center; align-items:center; padding: 8px 0 16px;">
      <button onclick="closeWarehouseWarnModal()" class="btn-confirm" style="background:#0d6efd;">OK</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeWarehouseWarnModal()"></div>
  
</div>

<!-- Modal X√°c nh·∫≠n x√≥a (ki·ªÉu H√¨nh 2) -->
<div id="warehouseDeleteModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:520px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #b02a37); color:#fff;">
      <h3 style="margin:0;">X√°c nh·∫≠n x√≥a</h3>
      <span class="close" onclick="closeWarehouseDeleteConfirmModal()" style="color:#fff;">&times;</span>
    </div>
    <div class="modal-body" style="text-align:center;">
      <p id="warehouseDeleteMessage" style="margin: 10px 0 0;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho h√†ng n√†y?</p>
    </div>
    <div class="modal-footer" style="justify-content:center; gap:10px;">
      <button id="confirmDeleteWarehouseBtn" class="btn-confirm" style="background:#dc3545;">X√≥a</button>
      <button onclick="closeWarehouseDeleteConfirmModal()" class="btn-cancel">H·ªßy</button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeWarehouseDeleteConfirmModal()"></div>
  
</div>

<!-- D√≤ng t·ªïng d∆∞·ªõi b·∫£ng -->
<div class="bottom-totals" style="margin-top: 10px; display:flex; justify-content:flex-end;">
  <div style="color:#000; font-weight:bold; font-size:14px; display:flex; align-items:center; gap:20px;">
    <span class="bt-total">T·ªïng: {{ warehouses|length if warehouses else 0 }} kho h√†ng</span>
    <span aria-hidden="true">|</span>
    <span> T·ªïng nh√≥m s·∫£n ph·∫©m: <strong id="bt-groups">0</strong> nh√≥m</span>
    <span aria-hidden="true">|</span>
    <span> T·ªïng s·ªë l∆∞·ª£ng: <strong id="bt-quantity">0</strong></span>
  </div>
  
</div>

{% if success_message %}
<div class="modal">
  <p>{{ success_message }}</p>
  <a href="{{ url_for('dashboard') }}" style="display:inline-block;padding:8px 16px;border-radius:4px;background:#6c757d;color:#fff;text-decoration:none;">ƒê√≥ng</a>
</div>
{% endif %}

<!-- Modal th√™m kho h√†ng -->
<div id="addWarehouseModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000;">
  <div class="modal-backdrop" onclick="attemptCloseAddWarehouseModal()" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); cursor:pointer;"></div>
  <div class="modal-content" style="position:relative; background:white; margin:50px auto; max-width:800px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:1;">
    <div class="modal-header" style="background: linear-gradient(135deg, #007bff, #0056b3); padding: 20px; border-radius: 12px 12px 0 0; display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; text-align:center; flex:1; color:#fff;">Th√™m kho h√†ng m·ªõi</h3>
      <span class="close" onclick="attemptCloseAddWarehouseModal()" style="color:#fff;">&times;</span>
    </div>
    <form id="addWarehouseForm">
      <div class="form-row">
        <div class="form-group">
          <label>M√£ kho*</label>
          <input type="text" id="warehouseCodeInput" placeholder="Nh·∫≠p m√£ kho" required>
        </div>
        <div class="form-group">
          <label>T√™n kho*</label>
          <input type="text" id="warehouseNameInput" placeholder="Nh·∫≠p t√™n kho" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ƒêi·ªán tho·∫°i</label>
          <input type="text" id="warehousePhoneInput" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" inputmode="numeric" maxlength="10">
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ*</label>
          <input type="text" id="warehouseAddressInput" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ kho" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nh√≥m SP</label>
          <select id="warehouseGroupInput">
            <option value="">Ch·ªçn nh√≥m s·∫£n ph·∫©m</option>
            <!-- Debug: Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng product_groups -->
            <!-- DEBUG: product_groups count: {{ product_groups|length if product_groups else 0 }} -->
            {% if product_groups %}
              {% for group in product_groups %}
                <!-- DEBUG: group data: {{ group }} -->
                <option value="{{ group.ten_nhom }}" data-qty="{{ group.so_luong or 0 }}">{{ group.ten_nhom }}</option>
              {% endfor %}
            {% else %}
              <!-- DEBUG: Kh√¥ng c√≥ product_groups -->
              <option value="" disabled>Kh√¥ng c√≥ nh√≥m s·∫£n ph·∫©m</option>
            {% endif %}
          </select>
        </div>
        <div class="form-group">
          <label>S·ªë l∆∞·ª£ng SP</label>
          <input type="text" id="warehouseQuantity" placeholder="T·ª± ƒë·ªông t√≠nh theo nh√≥m s·∫£n ph·∫©m" readonly style="background: #f8f9fa; color: #6c757d;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Tr·∫°ng th√°i</label>
          <input type="text" id="warehouseStatusSelect" placeholder="T·ª± ƒë·ªông t√≠nh theo s·∫£n ph·∫©m" readonly style="background: #f8f9fa; color: #6c757d;">
        </div>
      </div>
      <div class="form-group">
        <label>M√¥ t·∫£</label>
        <textarea id="warehouseDescription" placeholder="Nh·∫≠p m√¥ t·∫£ kho h√†ng"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="save-btn">L∆∞u kho h√†ng</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal X√°c nh·∫≠n tho√°t kho h√†ng -->
<div id="confirmExitWarehouseModal" class="modal confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000;">
  <div class="modal-backdrop" onclick="closeConfirmExitWarehouseModal()" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); cursor:pointer;"></div>
  <div class="modal-content" style="position:relative; background:white; margin:100px auto; max-width:400px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:1;">
    <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd, #0a58ca); padding: 20px; border-radius: 8px 8px 0 0; display:flex; align-items:center; justify-content:center;">
      <h3 style="margin:0; color:#fff; text-align:center; font-size:18px;">X√°c nh·∫≠n</h3>
    </div>
    <div class="modal-body" style="text-align:center; padding: 30px 20px;">
      <p style="margin:0; color:#333; font-size:16px;">B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?</p>
    </div>
    <div class="modal-footer" style="display:flex; justify-content:center; gap:15px; padding: 0 20px 20px;">
      <button onclick="confirmExitWarehouse()" class="btn-confirm" style="background:#dc3545; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; min-width:80px;">Tho√°t</button>
      <button onclick="cancelExitWarehouse()" class="btn-cancel" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; min-width:80px;">·ªû l·∫°i</button>
    </div>
  </div>
</div>

<script>
// H√†m chu·∫©n h√≥a vƒÉn b·∫£n ti·∫øng Vi·ªát ƒë·ªÉ t√¨m ki·∫øm
function normalizeVietnameseText(text) {
    if (!text) return "";
    
    // Mapping d·∫•u ti·∫øng Vi·ªát sang kh√¥ng d·∫•u
    const vietnameseMap = {
        '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
        'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
        '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
        '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
        '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
        '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
        '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
        '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
        '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
        '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
        '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
        '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
        'ƒë': 'd',
        '√Ä': 'A', '√Å': 'A', '·∫¢': 'A', '√É': 'A', '·∫†': 'A',
        'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫≤': 'A', '·∫¥': 'A', '·∫∂': 'A',
        '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫®': 'A', '·∫™': 'A', '·∫¨': 'A',
        '√à': 'E', '√â': 'E', '·∫∫': 'E', '·∫º': 'E', '·∫∏': 'E',
        '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÇ': 'E', '·ªÑ': 'E', '·ªÜ': 'E',
        '√å': 'I', '√ç': 'I', '·ªà': 'I', 'ƒ®': 'I', '·ªä': 'I',
        '√í': 'O', '√ì': 'O', '·ªé': 'O', '√ï': 'O', '·ªå': 'O',
        '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªî': 'O', '·ªñ': 'O', '·ªò': 'O',
        '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ªû': 'O', '·ª†': 'O', '·ª¢': 'O',
        '√ô': 'U', '√ö': 'U', '·ª¶': 'U', '≈®': 'U', '·ª§': 'U',
        '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª¨': 'U', '·ªÆ': 'U', '·ª∞': 'U',
        '·ª≤': 'Y', '√ù': 'Y', '·ª∂': 'Y', '·ª∏': 'Y', '·ª¥': 'Y',
        'ƒê': 'D'
    };
    
    // Thay th·∫ø d·∫•u ti·∫øng Vi·ªát
    let normalized = text;
    for (const [accented, plain] of Object.entries(vietnameseMap)) {
        normalized = normalized.replace(new RegExp(accented, 'g'), plain);
    }
    
    // Chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
    normalized = normalized.toLowerCase().trim();
    
    return normalized;
}

// H√†m t√¨m ki·∫øm linh ho·∫°t - h·ªó tr·ª£ t√¨m ki·∫øm d√≠nh li·ªÅn v√† t√°ch r·ªùi
function flexibleSearch(searchText, targetText) {
    if (!searchText || !targetText) return false;
    
    // Chu·∫©n h√≥a c·∫£ hai vƒÉn b·∫£n
    const normalizedSearch = normalizeVietnameseText(searchText);
    const normalizedTarget = normalizeVietnameseText(targetText);
    
    // 1. T√¨m ki·∫øm tr·ª±c ti·∫øp (bao g·ªìm c·∫£ d√≠nh li·ªÅn)
    if (normalizedTarget.includes(normalizedSearch)) {
        return true;
    }
    
    // 2. T√¨m ki·∫øm khi t√°ch t·ª´ (n·∫øu searchText c√≥ th·ªÉ t√°ch th√†nh nhi·ªÅu t·ª´)
    const searchWords = normalizedSearch.split(/\s+/).filter(word => word.length > 0);
    if (searchWords.length > 1) {
        // N·∫øu c√≥ nhi·ªÅu t·ª´, ki·ªÉm tra xem t·∫•t c·∫£ t·ª´ c√≥ xu·∫•t hi·ªán trong target kh√¥ng
        return searchWords.every(word => normalizedTarget.includes(word));
    }
    
    // 3. T√¨m ki·∫øm khi gh√©p t·ª´ (n·∫øu searchText c√≥ th·ªÉ l√† t·ª´ gh√©p)
    if (normalizedSearch.length > 3) {
        // Th·ª≠ t√°ch th√†nh c√°c t·ª´ c√≥ th·ªÉ c√≥
        const possibleCombinations = generatePossibleCombinations(normalizedSearch);
        for (const combination of possibleCombinations) {
            if (normalizedTarget.includes(combination)) {
                return true;
            }
        }
    }
    
    // 4. T√¨m ki·∫øm fuzzy - ki·ªÉm tra ƒë·ªô t∆∞∆°ng t·ª±
    if (calculateSimilarity(normalizedSearch, normalizedTarget) > 0.7) {
        return true;
    }
    
    return false;
}

// H√†m t·∫°o c√°c t·ªï h·ª£p t·ª´ c√≥ th·ªÉ c√≥ t·ª´ m·ªôt chu·ªói d√≠nh li·ªÅn
function generatePossibleCombinations(text) {
    const combinations = [];
    
    // Th√™m ch√≠nh n√≥
    combinations.push(text);
    
    // Th√™m c√°c bi·∫øn th·ªÉ c√≥ th·ªÉ c√≥
    if (text.length > 4) {
        // Th·ª≠ ch√®n kho·∫£ng tr·∫Øng ·ªü c√°c v·ªã tr√≠ kh√°c nhau
        for (let i = 2; i < text.length - 1; i++) {
            const part1 = text.substring(0, i);
            const part2 = text.substring(i);
            combinations.push(part1 + ' ' + part2);
        }
    }
    
    // Th√™m c√°c bi·∫øn th·ªÉ thay th·∫ø k√Ω t·ª± t∆∞∆°ng t·ª±
    const similarChars = {
        'd': ['d', 'ƒë'],
        'ƒë': ['d', 'ƒë'],
        'i': ['i', 'y'],
        'y': ['i', 'y'],
        'u': ['u', '∆∞'],
        '∆∞': ['u', '∆∞'],
        'o': ['o', '√¥', '∆°'],
        '√¥': ['o', '√¥', '∆°'],
        '∆°': ['o', '√¥', '∆°'],
        'a': ['a', 'ƒÉ', '√¢'],
        'ƒÉ': ['a', 'ƒÉ', '√¢'],
        '√¢': ['a', 'ƒÉ', '√¢'],
        'e': ['e', '√™'],
        '√™': ['e', '√™']
    };
    
    // T·∫°o bi·∫øn th·ªÉ v·ªõi c√°c k√Ω t·ª± t∆∞∆°ng t·ª±
    for (const [char, alternatives] of Object.entries(similarChars)) {
        if (text.includes(char)) {
            for (const alt of alternatives) {
                if (alt !== char) {
                    combinations.push(text.replace(new RegExp(char, 'g'), alt));
                }
            }
        }
    }
    
    return combinations;
}

// H√†m t√≠nh ƒë·ªô t∆∞∆°ng t·ª± gi·ªØa hai chu·ªói (Levenshtein distance)
function calculateSimilarity(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLength = Math.max(str1.length, str2.length);
    const similarity = 1 - (matrix[str2.length][str1.length] / maxLength);
    return similarity;
}

function filterWarehouses() {
    const warehouseCodeFilter = normalizeVietnameseText(document.getElementById('filter-warehouse-code')?.value || '');
    const warehouseNameFilter = normalizeVietnameseText(document.getElementById('filter-warehouse-name')?.value || '');
    const groupFilter = normalizeVietnameseText(document.getElementById('filter-group')?.value || '');
    const statusFilter = document.getElementById('filter-status')?.value?.toLowerCase() || '';
    
    const rows = document.querySelectorAll('.product-table tbody tr');
    let visibleCount = 0;
    
    rows.forEach((row) => {
        // Ki·ªÉm tra null tr∆∞·ªõc khi truy c·∫≠p textContent
        const codeCell = row.querySelector('td:nth-child(2)');
        const nameCell = row.querySelector('td:nth-child(3)');
        const groupCell = row.querySelector('td:nth-child(6)');
        const statusCell = row.querySelector('td:nth-child(8)');
        
        // B·ªè qua n·∫øu kh√¥ng t√¨m th·∫•y c√°c cell c·∫ßn thi·∫øt
        if (!codeCell || !nameCell || !groupCell || !statusCell) {
            console.warn('‚ö†Ô∏è B·ªè qua row kh√¥ng c√≥ ƒë·ªß cell:', row);
            return;
        }
        
        const warehouseCode = normalizeVietnameseText(codeCell.textContent || '');
        const warehouseName = normalizeVietnameseText(nameCell.textContent || '');
        const groupName = normalizeVietnameseText(groupCell.textContent || '');
        const status = (statusCell.textContent || '').toLowerCase();
        
        const codeMatch = !warehouseCodeFilter || warehouseCodeFilter === '' || flexibleSearch(warehouseCodeFilter, warehouseCode);
        const nameMatch = !warehouseNameFilter || warehouseNameFilter === '' || flexibleSearch(warehouseNameFilter, warehouseName);
        const groupMatch = !groupFilter || flexibleSearch(groupFilter, groupName);
        const statusMatch = !statusFilter || statusFilter === '' || status.includes(statusFilter);
        
        if (codeMatch && nameMatch && groupMatch && statusMatch) {
            row.style.display = '';
            visibleCount++;
            const sttCell = row.querySelector('td:nth-child(1)');
            if (sttCell) { sttCell.textContent = visibleCount; }
        } else {
            row.style.display = 'none';
        }
    });
    
    // C·∫≠p nh·∫≠t t·ªïng s·ªë kho h√†ng
    const totalSpan = document.querySelector('.toolbar .toolbar-total');
    if (totalSpan) { totalSpan.textContent = `T·ªïng: ${visibleCount} kho h√†ng`; }
    const btTotal = document.querySelector('.bottom-totals .bt-total');
    if (btTotal) { btTotal.textContent = `T·ªïng: ${visibleCount} kho h√†ng`; }
    
    // C·∫≠p nh·∫≠t t·ªïng nh√≥m v√† s·ªë l∆∞·ª£ng d·ª±a tr√™n d·ªØ li·ªáu hi·ªÉn th·ªã
    let totalGroups = 0;
    let totalQuantity = 0;
    const visibleGroups = new Set();
    
    rows.forEach((row) => {
        if (row.style.display !== 'none') {
            const groupCell = row.querySelector('td:nth-child(6)');
            const quantityCell = row.querySelector('td:nth-child(7)');
            
            if (groupCell && quantityCell) {
                const groupName = (groupCell.textContent || '').trim();
                const quantity = parseInt(quantityCell.textContent || '0', 10) || 0;
                
                if (groupName && groupName !== 'Ch∆∞a c√≥ nh√≥m') {
                    visibleGroups.add(groupName);
                    totalQuantity += quantity;
                }
            }
        }
    });
    
    totalGroups = visibleGroups.size;
    
    // C·∫≠p nh·∫≠t t·ªïng nh√≥m v√† s·ªë l∆∞·ª£ng
    const summaryGroups = document.getElementById('summary-groups');
    const summaryQuantity = document.getElementById('summary-quantity');
    if (summaryGroups) { summaryGroups.textContent = totalGroups; }
    if (summaryQuantity) { summaryQuantity.textContent = totalQuantity; }
    const btGroups = document.getElementById('bt-groups');
    const btQuantity = document.getElementById('bt-quantity');
    if (btGroups) { btGroups.textContent = totalGroups; }
    if (btQuantity) { btQuantity.textContent = totalQuantity; }
    
    console.log(`üîç Filter ho√†n th√†nh: ${visibleCount} kho h√†ng hi·ªÉn th·ªã, ${totalGroups} nh√≥m, ${totalQuantity} s·∫£n ph·∫©m`);
}

function clearWarehouseFilters() {
    // Ki·ªÉm tra null tr∆∞·ªõc khi reset
    const codeFilter = document.getElementById('filter-warehouse-code');
    const nameFilter = document.getElementById('filter-warehouse-name');
    const groupFilter = document.getElementById('filter-group');
    const statusFilter = document.getElementById('filter-warehouse-status');
    
    if (codeFilter) codeFilter.selectedIndex = 0; // Reset v·ªÅ placeholder "T·∫•t c·∫£ m√£ kho"
    if (nameFilter) nameFilter.selectedIndex = 0; // Reset v·ªÅ placeholder "T·∫•t c·∫£ t√™n kho"
    if (groupFilter) groupFilter.value = '';
    if (statusFilter) statusFilter.selectedIndex = 0; // Reset v·ªÅ placeholder "T·∫•t c·∫£"
    
    filterWarehouses();
    
    // C·∫≠p nh·∫≠t t·ªïng s·ªë kho h√†ng
    const totalSpan = document.querySelector('.toolbar .toolbar-total');
    const btTotal = document.querySelector('.bottom-totals .bt-total');
    
    if (totalSpan) {
        const allRows = document.querySelectorAll('.product-table tbody tr');
        let totalCount = 0;
        allRows.forEach((row) => { 
            if (!row.querySelector('td[colspan]')) totalCount++; 
        });
        totalSpan.textContent = `T·ªïng: ${totalCount} kho h√†ng`;
    }
    
    if (btTotal) {
        const allRows = document.querySelectorAll('.product-table tbody tr');
        let totalCount = 0;
        allRows.forEach((row) => { 
            if (!row.querySelector('td[colspan]')) totalCount++; 
        });
        btTotal.textContent = `T·ªïng: ${totalCount} kho h√†ng`;
    }
    
    // Reset t·ªïng nh√≥m v√† s·ªë l∆∞·ª£ng v·ªÅ gi√° tr·ªã ban ƒë·∫ßu
    const summaryGroups = document.getElementById('summary-groups');
    const summaryQuantity = document.getElementById('summary-quantity');
    const btGroups = document.getElementById('bt-groups');
    const btQuantity = document.getElementById('bt-quantity');
    
    if (summaryGroups && summaryQuantity) {
        const allRows = document.querySelectorAll('.product-table tbody tr');
        let totalGroups = 0;
        let totalQuantity = 0;
        const allGroups = new Set();
        
        allRows.forEach((row) => {
            if (!row.querySelector('td[colspan]')) {
                const groupCell = row.querySelector('td:nth-child(6)');
                const quantityCell = row.querySelector('td:nth-child(7)');
                
                if (groupCell && quantityCell) {
                    const groupName = (groupCell.textContent || '').trim();
                    const quantity = parseInt(quantityCell.textContent || '0', 10) || 0;
                    
                    if (groupName && groupName !== 'Ch∆∞a c√≥ nh√≥m') {
                        allGroups.add(groupName);
                        totalQuantity += quantity;
                    }
                }
            }
        });
        
        const groupsCount = allGroups.size;
        const qty = totalQuantity;
        summaryGroups.textContent = groupsCount;
        summaryQuantity.textContent = qty;
        if (btGroups) btGroups.textContent = groupsCount;
        if (btQuantity) btQuantity.textContent = qty;
    }
    
    console.log('üîÑ ƒê√£ x√≥a b·ªô l·ªçc v√† reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu');
}

document.addEventListener('DOMContentLoaded', function() {
    // Debug: Ki·ªÉm tra d·ªØ li·ªáu product_groups
    console.log('üîç Debug product_groups data:');
    console.log('  - product_groups variable:', typeof product_groups !== 'undefined' ? product_groups : 'undefined');
    console.log('  - product_groups length:', typeof product_groups !== 'undefined' ? product_groups.length : 'N/A');
    
    // Debug: Ki·ªÉm tra dropdown warehouseGroupInput
    const warehouseGroupSelect = document.getElementById('warehouseGroupInput');
    if (warehouseGroupSelect) {
        console.log('  - warehouseGroupInput found:', warehouseGroupSelect);
        console.log('  - warehouseGroupInput options count:', warehouseGroupSelect.options.length);
        console.log('  - warehouseGroupInput options:');
        for (let i = 0; i < warehouseGroupSelect.options.length; i++) {
            const option = warehouseGroupSelect.options[i];
            console.log(`    Option ${i}: value="${option.value}", text="${option.text}", data-qty="${option.getAttribute('data-qty')}"`);
        }
    } else {
        console.log('  - ‚ùå warehouseGroupInput NOT found!');
    }
    
    document.getElementById('filter-warehouse-code').addEventListener('change', filterWarehouses);
    document.getElementById('filter-warehouse-name').addEventListener('change', filterWarehouses);
    document.getElementById('filter-group').addEventListener('change', filterWarehouses);
    document.getElementById('filter-status').addEventListener('change', filterWarehouses);
    
    // T√≠nh to√°n t·ªïng ban ƒë·∫ßu khi trang load
    filterWarehouses();
});

// D·ªØ li·ªáu s·ªë l∆∞·ª£ng theo nh√≥m ƒë∆∞·ª£c ƒë√≠nh k√®m tr√™n option qua data-qty

function showAddWarehouseModal() {
    document.getElementById('addWarehouseForm').reset();
    // M·∫∑c ƒë·ªãnh r·ªóng t·∫•t c·∫£ input ƒë·ªÉ ng∆∞·ªùi d√πng t·ª± nh·∫≠p
    document.getElementById('warehouseCodeInput').value = '';
    document.getElementById('warehouseNameInput').value = '';
    document.getElementById('warehousePhoneInput').value = '';
    document.getElementById('warehouseAddressInput').value = '';
    document.getElementById('warehouseGroupInput').value = '';
    document.getElementById('warehouseQuantity').value = '';
    document.getElementById('warehouseStatusSelect').value = '';
    document.getElementById('warehouseDescription').value = '';
    const modal = document.getElementById('addWarehouseModal');
    modal.style.display = 'flex';
    modal.classList.add('show');
}

function closeAddWarehouseModal() { 
    const modal = document.getElementById('addWarehouseModal'); 
    modal.style.display = 'none'; 
    modal.classList.remove('show'); 
}

// Ki·ªÉm tra form tr·ªëng
function isAddWarehouseFormEmpty(){
    const code = document.getElementById('warehouseCodeInput').value.trim();
    const name = document.getElementById('warehouseNameInput').value.trim();
    const phone = document.getElementById('warehousePhoneInput').value.trim();
    const addr = document.getElementById('warehouseAddressInput').value.trim();
    const group = document.getElementById('warehouseGroupInput').value.trim();
    const qty = document.getElementById('warehouseQuantity').value.trim();
    const status = document.getElementById('warehouseStatusSelect').value.trim();
    const desc = document.getElementById('warehouseDescription').value.trim();
    return !code && !name && !phone && !addr && !group && !qty && !status && !desc;
}

// C·ªë g·∫Øng ƒë√≥ng modal: n·∫øu form tr·ªëng th√¨ ƒë√≥ng ngay, n·∫øu c√≥ d·ªØ li·ªáu th√¨ h·ªèi x√°c nh·∫≠n
function attemptCloseAddWarehouseModal(){
    if (isAddWarehouseFormEmpty()){
        closeAddWarehouseModal();
    } else {
        showConfirmExitWarehouseModal();
    }
}

function showConfirmExitWarehouseModal() { 
    const modal = document.getElementById('confirmExitWarehouseModal'); 
    modal.style.display = 'flex'; 
    modal.classList.add('show'); 
}

function closeConfirmExitWarehouseModal() { 
    const modal = document.getElementById('confirmExitWarehouseModal'); 
    modal.style.display = 'none'; 
    modal.classList.remove('show'); 
}

function cancelExitWarehouse() { 
    closeConfirmExitWarehouseModal(); 
}

function confirmExitWarehouse() { 
    closeAddWarehouseModal(); 
    closeConfirmExitWarehouseModal(); 
}

// ================== X√≥a kho: C·∫£nh b√°o v√† X√°c nh·∫≠n ==================
// Modal c·∫£nh b√°o: kh√¥ng th·ªÉ x√≥a v√¨ c√≤n h√†ng
function showWarehouseWarnModal(message){
    const modal = document.getElementById('warehouseWarnModal');
    const msg = document.getElementById('warehouseWarnMessage');
    if (msg) msg.textContent = message;
    modal.style.display = 'flex';
    modal.classList.add('show');
}
function closeWarehouseWarnModal(){
    const modal = document.getElementById('warehouseWarnModal');
    modal.style.display = 'none';
    modal.classList.remove('show');
}

// Modal x√°c nh·∫≠n x√≥a: ch·ªâ hi·ªán khi s·ªë l∆∞·ª£ng = 0
function showWarehouseDeleteConfirmModal(warehouseId, maKho){
    const modal = document.getElementById('warehouseDeleteModal');
    const msg = document.getElementById('warehouseDeleteMessage');
    if (msg) msg.textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho h√†ng "${maKho}"?`;
    const btn = document.getElementById('confirmDeleteWarehouseBtn');
    if (btn){ btn.setAttribute('data-id', warehouseId); btn.setAttribute('data-ma', maKho); }
    modal.style.display = 'flex';
    modal.classList.add('show');
}
function closeWarehouseDeleteConfirmModal(){
    const modal = document.getElementById('warehouseDeleteModal');
    modal.style.display = 'none';
    modal.classList.remove('show');
}

function deleteWarehouse(warehouseId, maKho) {
    const doDelete = () => {
        console.log(`üóëÔ∏è B·∫Øt ƒë·∫ßu x√≥a kho h√†ng: ${maKho} (ID: ${warehouseId})`);
        
        const backendUrl = '{{ BACKEND_URL }}';
        console.log('üåê S·ª≠ d·ª•ng backend URL:', backendUrl);
        
        const apiUrl = `${backendUrl}/api/warehouses/${warehouseId}`;
        console.log('üåê G·ªçi API DELETE:', apiUrl);
        
        fetch(apiUrl, { 
            method: 'DELETE', 
            headers: { 'Content-Type': 'application/json' } 
        })
        .then(response => {
            console.log('üì° Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => { 
            console.log('‚úÖ Response data:', data);
            if (data.success) { 
                if (window.showSuccessModal) { 
                    showSuccessModal('X√≥a kho h√†ng th√†nh c√¥ng!', function(){ location.reload(); }); 
                } else { 
                    if (window.showSuccessModal) { showSuccessModal('‚úÖ X√≥a kho h√†ng th√†nh c√¥ng!'); } else { alert('‚úÖ X√≥a kho h√†ng th√†nh c√¥ng!'); }
                    location.reload(); 
                } 
            } else { 
                if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: ' + (data.message || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói')); } else { alert('‚ùå L·ªói: ' + (data.message || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói')); } 
            } 
        })
        .catch(err => { 
            console.error('‚ùå L·ªói khi x√≥a kho h√†ng:', err);
            if (err.message.includes('404')) {
                if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: API endpoint kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra backend!'); } else { alert('‚ùå L·ªói: API endpoint kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra backend!'); }
            } else if (err.message.includes('Failed to fetch')) {
                if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!'); } else { alert('‚ùå L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!'); }
            } else {
                if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: ' + err.message); } else { alert('‚ùå L·ªói: ' + err.message); }
            }
        });
    };
    if (window.openPopup) {
        window.openPopup('confirm', `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho h√†ng "${maKho}"?`, doDelete);
    } else {
        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho h√†ng "${maKho}"?`)) { doDelete(); }
    }
 }

// Submit th√™m kho h√†ng (g·ªçi FastAPI)
document.getElementById('addWarehouseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('üöÄ B·∫Øt ƒë·∫ßu th√™m kho h√†ng m·ªõi...');
    
    // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
    const maKho = document.getElementById('warehouseCodeInput')?.value?.trim();
    const tenKho = document.getElementById('warehouseNameInput')?.value?.trim();
    const diaChi = document.getElementById('warehouseAddressInput')?.value?.trim();
    
    if (!maKho || !tenKho || !diaChi) {
        if (window.showErrorModal) { showErrorModal('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (M√£ kho, T√™n kho, ƒê·ªãa ch·ªâ)!'); } else { alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (M√£ kho, T√™n kho, ƒê·ªãa ch·ªâ)!'); }
        return;
    }
    
    const payload = {
        ma_kho: maKho,
        ten_kho: tenKho,
        dia_chi: diaChi,
        dien_thoai: document.getElementById('warehousePhoneInput')?.value?.trim() || '',
        so_luong_sp: parseInt(document.getElementById('warehouseQuantity')?.value || '0', 10) || 0,
        trang_thai: document.getElementById('warehouseStatusSelect')?.value || 'C√≤n h√†ng',
        nhom_san_pham: document.getElementById('warehouseGroupInput')?.value || '',
        mo_ta: document.getElementById('warehouseDescription')?.value?.trim() || '',
    };
    
    console.log('üìã Payload g·ª≠i ƒëi:', payload);
    
    // S·ª≠ d·ª•ng backend URL t·ª´ config
    const backendUrl = '{{ BACKEND_URL }}';
    console.log('üåê S·ª≠ d·ª•ng backend URL:', backendUrl);
    
    const apiUrl = `${backendUrl}/api/warehouses/`;
    console.log('üåê G·ªçi API:', apiUrl);
    
    fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Response data:', data);
        if (data.success || data.id) {
            if (window.showSuccessModal) {
                showSuccessModal('Th√™m kho h√†ng th√†nh c√¥ng!', function(){ location.reload(); });
            } else {
                if (window.showSuccessModal) { showSuccessModal('‚úÖ Th√™m kho h√†ng th√†nh c√¥ng!'); } else { alert('‚úÖ Th√™m kho h√†ng th√†nh c√¥ng!'); }
                location.reload();
            }
        } else {
            const errorMsg = data.detail || data.message || data.error || 'Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªói';
            if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: ' + errorMsg); } else { alert('‚ùå L·ªói: ' + errorMsg); }
        }
    })
    .catch(err => {
        console.error('‚ùå L·ªói khi th√™m kho h√†ng:', err);
        if (err.message.includes('404')) {
            if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: API endpoint kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra backend!'); } else { alert('‚ùå L·ªói: API endpoint kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra backend!'); }
        } else if (err.message.includes('Failed to fetch')) {
            if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!'); } else { alert('‚ùå L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!'); }
        } else {
            if (window.showErrorModal) { showErrorModal('‚ùå L·ªói: ' + err.message); } else { alert('‚ùå L·ªói: ' + err.message); }
        }
    });
});

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† tr·∫°ng th√°i theo nh√≥m ƒë∆∞·ª£c ch·ªçn
(function(){
  const sel = document.getElementById('warehouseGroupInput');
  if (!sel) return;
  sel.addEventListener('change', function(){
    const opt = this.options[this.selectedIndex];
    const qtyFromGroup = parseInt(opt?.getAttribute('data-qty') || '0', 10);
    const qtyEl = document.getElementById('warehouseQuantity');
    qtyEl.value = String(qtyFromGroup);
    const statusEl = document.getElementById('warehouseStatusSelect');
    statusEl.value = qtyFromGroup > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng';
  });
})();

// R√†ng bu·ªôc nh·∫≠p ƒëi·ªán tho·∫°i: b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† ƒë·ªß 10 s·ªë
document.addEventListener('DOMContentLoaded', function(){
  const phoneInput = document.getElementById('warehousePhoneInput');
  if (!phoneInput) return;
  function validatePhone(){
    phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '');
    const isValid = /^0\d{9}$/.test(phoneInput.value);
    phoneInput.style.borderColor = (isValid || phoneInput.value === '') ? '#ced4da' : '#dc3545';
    phoneInput.style.boxShadow = (isValid || phoneInput.value === '') ? '' : '0 0 0 0.2rem rgba(220,53,69,.25)';
    return isValid;
  }
  phoneInput.addEventListener('input', validatePhone);

  // T·ª± ƒë·ªông ch√®n s·ªë 0 khi ng∆∞·ªùi d√πng nh·∫•p/focus v√†o √¥ ƒëi·ªán tho·∫°i
  phoneInput.addEventListener('focus', function(){
    const onlyDigits = phoneInput.value.replace(/[^0-9]/g, '');
    if (onlyDigits.length === 0) {
      phoneInput.value = '0';
    } else if (!onlyDigits.startsWith('0')) {
      phoneInput.value = '0' + onlyDigits.substring(0, 9);
    } else {
      phoneInput.value = onlyDigits.substring(0, 10);
    }
    // ƒê·∫∑t con tr·ªè ·ªü cu·ªëi v√† re-validate
    try { phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length); } catch(_) {}
    validatePhone();
  });

  const form = document.getElementById('addWarehouseForm');
  if (form){
    form.addEventListener('submit', function(e){
      if (!validatePhone()){
        e.preventDefault();
        phoneInput.focus();
      }
    });
  }
  
  // √Åp d·ª•ng ph√¢n quy·ªÅn cho trang warehouse
  if (window.checkUserPermissions) {
    window.checkUserPermissions();
  }
});

// Th√™m n√∫t x√≥a c√≥ ƒëi·ªÅu ki·ªán (ch·ªâ x√≥a khi h·∫øt h√†ng)
document.addEventListener('click', function(e){
  const btn = e.target.closest('.btn-delete-warehouse');
  if (!btn) return;
  const qty = parseInt(btn.dataset.qty || '0', 10);
  const id = btn.dataset.id;
  const ma = btn.dataset.ma;
  if (qty > 0){
    // Hi·ªán modal c·∫£nh b√°o nh∆∞ h√¨nh 1
    showWarehouseWarnModal(`Kh√¥ng th·ªÉ x√≥a nh√≥m s·∫£n ph·∫©m n√†y v√¨ c√≤n ${qty} s·∫£n ph·∫©m trong kho!`);
    return;
  }
  // Hi·ªán modal x√°c nh·∫≠n nh∆∞ h√¨nh 2
  showWarehouseDeleteConfirmModal(id, ma);
});

// Debug functions (ch·ªâ trong development)
if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
  window.debugWarehouse = {
    checkElements: () => {
      console.log('üîç Debug c√°c element trong warehouse.html:');
      
      const elements = {
        'filter-warehouse-code': document.getElementById('filter-warehouse-code'),
        'filter-warehouse-name': document.getElementById('filter-warehouse-name'),
        'filter-group': document.getElementById('filter-group'),
        'filter-status': document.getElementById('filter-status'),
        'warehouseCodeInput': document.getElementById('warehouseCodeInput'),
        'warehouseNameInput': document.getElementById('warehouseNameInput'),
        'warehousePhoneInput': document.getElementById('warehousePhoneInput'),
        'warehouseAddressInput': document.getElementById('warehouseAddressInput'),
        'warehouseGroupInput': document.getElementById('warehouseGroupInput'),
        'warehouseQuantity': document.getElementById('warehouseQuantity'),
        'warehouseStatusSelect': document.getElementById('warehouseStatusSelect'),
        'warehouseDescription': document.getElementById('warehouseDescription')
      };
      
      Object.entries(elements).forEach(([name, element]) => {
        if (element) {
          console.log(`  ‚úÖ ${name}: t·ªìn t·∫°i`);
        } else {
          console.log(`  ‚ùå ${name}: KH√îNG t·ªìn t·∫°i`);
        }
      });
      
      // Ki·ªÉm tra b·∫£ng
      const table = document.querySelector('.product-table');
      const tbody = table?.querySelector('tbody');
      const rows = tbody?.querySelectorAll('tr');
      
      console.log(`  üìä B·∫£ng: ${table ? 't·ªìn t·∫°i' : 'KH√îNG t·ªìn t·∫°i'}`);
      console.log(`  üìã Tbody: ${tbody ? 't·ªìn t·∫°i' : 'KH√îNG t·ªìn t·∫°i'}`);
      console.log(`  üìù S·ªë rows: ${rows ? rows.length : 0}`);
      
      if (rows) {
        rows.forEach((row, index) => {
          const cells = row.querySelectorAll('td');
          console.log(`    Row ${index}: ${cells.length} cells`);
        });
      }
        },
    
    checkBackendUrl: () => {
      const backendUrl = '{{ BACKEND_URL }}';
      console.log('üåê Backend URL:', backendUrl);
      console.log('üîó API Warehouses URL:', `${backendUrl}/api/warehouses/`);
      console.log('‚úÖ Backend URL ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh t·ª´ config');
    }
  };
  
  console.log('üîß Debug functions available:');
  console.log('  - window.debugWarehouse.checkElements() (ki·ªÉm tra c√°c element)');
  
  console.log('  - window.debugWarehouse.checkBackendUrl() (ki·ªÉm tra backend URL)');
}

// X·ª≠ l√Ω n√∫t x√°c nh·∫≠n x√≥a trong modal x√°c nh·∫≠n
document.addEventListener('click', function(e){
  const confirmBtn = e.target.closest('#confirmDeleteWarehouseBtn');
  if (!confirmBtn) return;
  const id = confirmBtn.getAttribute('data-id');
  const ma = confirmBtn.getAttribute('data-ma');
  fetch(`{{ BACKEND_URL }}/api/warehouses/${id}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
    .then(r=>r.json())
    .then(data=>{ 
      if (data.success){ 
        closeWarehouseDeleteConfirmModal();
        if (window.showSuccessModal){ 
          showSuccessModal('X√≥a kho h√†ng th√†nh c√¥ng!', function(){ location.reload(); }); 
        } else { 
          location.reload(); 
        }
      } else { 
        if (window.showErrorModal) { showErrorModal('L·ªói: ' + (data.message||'')); } else { alert('L·ªói: ' + (data.message||'')); } 
      } 
    })
    .catch(()=> { if (window.showErrorModal) { showErrorModal('C√≥ l·ªói x·∫£y ra khi x√≥a kho h√†ng!'); } else { alert('C√≥ l·ªói x·∫£y ra khi x√≥a kho h√†ng!'); } });
});
</script>

{% endblock %}
