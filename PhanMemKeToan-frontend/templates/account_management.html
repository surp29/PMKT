{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω t√†i kho·∫£n{% endblock %}

{% block content %}
<div class="container">
    <h2 class="page-title">Qu·∫£n l√Ω t√†i kho·∫£n</h2>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="customers">Kh√°ch h√†ng</button>
        <button class="tab-btn" data-tab="employees">Nh√¢n vi√™n</button>
    </div>

    <!-- Customer Tab Content -->
    <div id="customers" class="tab-content active">
        <!-- Search Form -->
        <div class="filter-bar">
            <div class="filter-item">
                <label>T√™n kh√°ch h√†ng</label>
                <input type="text" id="customer-name" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
            </div>
            <div class="filter-item">
                <label>Email</label>
                <input type="email" id="customer-email" placeholder="Nh·∫≠p email">
            </div>
            
            <button class="search-btn btn-secondary" onclick="clearCustomerFilters()"><i class="fas fa-sync"></i> X√≥a b·ªô l·ªçc</button>
        </div>

        <!-- Customer Table -->
        <div class="table-container">
            <div class="toolbar">
                <button class="add-btn" onclick="openAddCustomerModal()"><i class="fas fa-plus"></i> Th√™m kh√°ch h√†ng</button>
                <span id="customer-total-count" style="margin-left:auto; color: #000; font-weight: 500;">T·ªïng: 0</span>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n kh√°ch h√†ng</th>
                        <th>Tk n·ª£</th>
                        <th>Tk c√≥</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>ƒê·ªãa ch·ªâ</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="customer-table-body">
                    <tr><td colspan="9" class="searching">ƒêang t·∫£i d·ªØ li·ªáu kh√°ch h√†ng...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Employee Tab Content -->
    <div id="employees" class="tab-content">
        <!-- Search Form -->
        <div class="filter-bar">
            <div class="filter-item">
                <label>M√£ nh√¢n vi√™n</label>
                <input type="text" id="employee-code" placeholder="Nh·∫≠p m√£ NV">
            </div>
            <div class="filter-item">
                <label>T√™n nh√¢n vi√™n</label>
                <input type="text" id="employee-name" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n">
            </div>
            
            <button class="search-btn btn-secondary" onclick="clearEmployeeFilters()"><i class="fas fa-sync"></i> X√≥a b·ªô l·ªçc</button>
        </div>

        <!-- Employee Table -->
        <div class="table-container">
            <div class="toolbar">
                <button class="add-btn" onclick="openAddEmployeeModal()" id="add-employee-btn"><i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n</button>
                <span id="employee-total-count" style="margin-left:auto; color: #000; font-weight: 500;">T·ªïng: 0</span>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ NV</th>
                        <th>T√™n nh√¢n vi√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ch·ª©c v·ª•</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="employee-table-body">
                    <tr><td colspan="8" class="searching">ƒêang t·∫£i d·ªØ li·ªáu nh√¢n vi√™n...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal th√™m kh√°ch h√†ng -->
<div id="addCustomerModal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h3 style="color: white; text-align: center; width: 100%; margin: 0;">Th√™m kh√°ch h√†ng m·ªõi</h3>
			<span class="close" onclick="attemptCloseAddCustomerModal()">&times;</span>
		</div>
		<form id="addCustomerForm">
			<div class="form-row">
				<div class="form-group">
					<label>T√™n kh√°ch h√†ng*</label>
					<input type="text" id="customerName" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" required>
				</div>
				<div class="form-group">
					<label>Email</label>
					<input type="email" id="customerEmail" placeholder="Nh·∫≠p email">
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label>S·ªë ƒëi·ªán tho·∫°i</label>
					<input type="tel" id="customerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" inputmode="numeric" maxlength="10" pattern="^0\d{9}$" required>
				</div>
				<div class="form-group">
					<label>ƒê·ªãa ch·ªâ</label>
					<input type="text" id="customerAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label>Tk n·ª£</label>
					<input type="text" id="customerTkNo" placeholder="Nh·∫≠p TK n·ª£">
				</div>
				<div class="form-group">
					<label>Tk c√≥</label>
					<input type="text" id="customerTkCo" placeholder="Nh·∫≠p TK c√≥">
				</div>
			</div>

			<div class="form-actions">
				<button type="submit" class="save-btn">L∆∞u kh√°ch h√†ng</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal th√™m nh√¢n vi√™n -->
<div id="addEmployeeModal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h3 style="color: white; text-align: center; width: 100%; margin: 0;">Th√™m nh√¢n vi√™n m·ªõi</h3>
			<span class="close" onclick="attemptCloseAddEmployeeModal()">&times;</span>
		</div>
		<form id="addEmployeeForm">
			<div class="form-row">
				<div class="form-group">
					<label>T√™n ƒëƒÉng nh·∫≠p*</label>
					<input type="text" id="employeeUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
				</div>
				<div class="form-group">
					<label>M·∫≠t kh·∫©u*</label>
					<input type="password" id="employeePassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label>H·ªç t√™n*</label>
					<input type="text" id="employeeName" placeholder="Nh·∫≠p h·ªç t√™n" required>
				</div>
				<div class="form-group">
					<label>Email</label>
					<input type="email" id="employeeEmail" placeholder="Nh·∫≠p email">
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label>S·ªë ƒëi·ªán tho·∫°i</label>
					<input type="tel" id="employeePhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" inputmode="numeric" maxlength="10" pattern="^0\d{9}$">
				</div>
				<div class="form-group">
					<label>Ch·ª©c v·ª•</label>
					<input type="text" id="employeePosition" placeholder="Nh·∫≠p ch·ª©c v·ª•">
				</div>
			</div>

			<div class="form-actions">
				<button type="submit" class="save-btn">L∆∞u nh√¢n vi√™n</button>
			</div>
		</form>
	</div>
</div>

 <!-- Edit Customer Modal -->
 <div id="editCustomerModal" class="modal">
     <div class="modal-content">
                    <div class="modal-header">
               <h2 style="color: white; text-align: center; width: 100%; margin: 0;">S·ª≠a th√¥ng tin kh√°ch h√†ng</h2>
               <!-- Removed close icon per requirement -->
           </div>
         <div class="modal-body">
             <form id="editCustomerForm">
                 <input type="hidden" id="edit-customer-id">
                                                  <div class="form-row">
                     <div class="form-group">
                         <label for="edit-customer-name">T√™n kh√°ch h√†ng *</label>
                         <input type="text" id="edit-customer-name" required>
                     </div>
                 </div>
                 <div class="form-row">
                     <div class="form-group">
                         <label for="edit-customer-tk-no">Tk n·ª£</label>
                         <input type="text" id="edit-customer-tk-no" placeholder="Nh·∫≠p Tk n·ª£">
                     </div>
                     <div class="form-group">
                         <label for="edit-customer-tk-co">Tk c√≥</label>
                         <input type="text" id="edit-customer-tk-co" placeholder="Nh·∫≠p Tk c√≥">
                     </div>
                 </div>
                 <div class="form-row">
                     <div class="form-group">
                         <label for="edit-customer-email">Email</label>
                         <input type="email" id="edit-customer-email">
                     </div>
                     <div class="form-group">
                         <label for="edit-customer-phone">S·ªë ƒëi·ªán tho·∫°i</label>
                         <input type="tel" id="edit-customer-phone" inputmode="numeric" maxlength="10" pattern="^0\d{9}$">
                     </div>
                 </div>
                 <div class="form-group">
                     <label for="edit-customer-address">ƒê·ªãa ch·ªâ</label>
                     <textarea id="edit-customer-address" rows="3"></textarea>
                 </div>
                                 <div class="form-group">
                    <label for="edit-customer-status">Tr·∫°ng th√°i</label>
                    <select id="edit-customer-status">
                        <option value="true">Ho·∫°t ƒë·ªông</option>
                        <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
             </form>
         </div>
         <div class="modal-footer">
             <button class="btn btn-cancel" onclick="closeModal('editCustomerModal')">H·ªßy</button>
             <button class="btn btn-success" onclick="updateCustomer()">
                 <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
             </button>
         </div>
     </div>
 </div>

      <!-- Edit Employee Modal -->
   <div id="editEmployeeModal" class="modal">
       <div class="modal-content">
                     <div class="modal-header">
              <h2 style="color: white; text-align: center; width: 100%; margin: 0;">S·ª≠a th√¥ng tin nh√¢n vi√™n</h2>
              <!-- Removed close icon per requirement -->
          </div>
          <div class="modal-body">
              <form id="editEmployeeForm">
                  <input type="hidden" id="edit-employee-id">
                  <div class="form-row">
                       <div class="form-group required">
                          <label for="edit-employee-username">T√™n ƒëƒÉng nh·∫≠p *</label>
                          <input type="text" id="edit-employee-username" required>
                      </div>
                      <div class="form-group">
                          <label for="edit-employee-password">M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                          <input type="password" id="edit-employee-password">
                      </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group">
                          <label for="edit-employee-name">T√™n nh√¢n vi√™n</label>
                          <input type="text" id="edit-employee-name">
                      </div>
                      <div class="form-group">
                          <label for="edit-employee-email">Email</label>
                          <input type="email" id="edit-employee-email">
                      </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group">
                          <label for="edit-employee-phone">S·ªë ƒëi·ªán tho·∫°i</label>
                          <input type="tel" id="edit-employee-phone" inputmode="numeric" maxlength="10" pattern="^0\d{9}$">
                      </div>
                      <div class="form-group">
                          <label for="edit-employee-position">Ch·ª©c v·ª•</label>
                          <input type="text" id="edit-employee-position">
                      </div>
                  </div>
                  <div class="form-group">
                      <label for="edit-employee-status">Tr·∫°ng th√°i</label>
                      <select id="edit-employee-status">
                          <option value="true">Ho·∫°t ƒë·ªông</option>
                          <option value="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
                      </select>
                  </div>
              </form>
          </div>
          <div class="modal-footer">
               <button class="btn btn-cancel" onclick="closeModal('editEmployeeModal')">H·ªßy</button>
               <button class="btn btn-success" onclick="updateEmployee()">
                   <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
               </button>
           </div>
      </div>
  </div>

     <!-- Success Notification Modal -->
   <div id="successNotificationModal" class="modal">
       <div class="modal-content notification-modal">
           <div class="modal-header">
               <h2 style="color: white; text-align: center; width: 100%; margin: 0;">Th√†nh c√¥ng</h2>
           </div>
           <div class="modal-body">
               <div class="success-message">
                   <i class="fas fa-check-circle"></i>
                   <p id="successMessage">C·∫≠p nh·∫≠t th√†nh c√¥ng!</p>
               </div>
           </div>
       </div>
   </div>

    <!-- Generic Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content notification-modal">
            <div class="modal-header">
                <h2 style="color: white; text-align: center; width: 100%; margin: 0;">Th√¥ng b√°o</h2>
            </div>
            <div class="modal-body">
                <div class="success-message">
                    <p id="alertMessage">Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content notification-modal">
            <div class="modal-header">
                <h2 style="color: white; text-align: center; width: 100%; margin: 0;">X√°c nh·∫≠n</h2>
            </div>
            <div class="modal-body">
                <div class="success-message">
                    <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirm()">H·ªßy</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- Confirm Exit Modal (for clicking outside edit customer form) -->
    <div id="confirmExitModal" class="modal">
        <div class="modal-content notification-modal">
            <div class="modal-header">
                <h2 style="color: white; text-align: center; width: 100%; margin: 0;">X√°c nh·∫≠n</h2>
            </div>
            <div class="modal-body">
                <div class="success-message">
                    <p>B·∫°n mu·ªën tho√°t hay kh√¥ng?</p>
                </div>
            </div>
                         <div class="modal-footer" style="display: flex; justify-content: space-between;">
                 <button class="btn btn-cancel" id="confirmExitStayBtn">·ªû l·∫°i</button>
                 <button class="btn btn-danger" id="confirmExitLeaveBtn">Tho√°t</button>
             </div>
        </div>
    </div>

<script>
// S·ª≠ d·ª•ng global permission t·ª´ base.html ƒë·ªÉ tr√°nh tr√πng l·∫∑p g√¢y xung ƒë·ªôt
// Ghi ch√∫: c√°c quy·ªÅn ƒë∆∞·ª£c cung c·∫•p qua window.userPermissions, window.checkUserPermissions, window.applyPermissionsToUI

// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            
            // Remove active class from all tabs
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            btn.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load data for the active tab
            if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'employees') {
                loadEmployees();
            }
        });
    });

    // Ki·ªÉm tra quy·ªÅn v√† √°p d·ª•ng ph√¢n quy·ªÅn (d√πng global t·ª´ base.html)
    if (window.checkUserPermissions) { window.checkUserPermissions(); }

    // Load initial data for both tabs
    loadCustomers();
    loadEmployees();
    
    // √Åp d·ª•ng ph√¢n quy·ªÅn cho b·∫£ng nh√¢n vi√™n sau khi load d·ªØ li·ªáu
    setTimeout(() => {
        if (!(window.userPermissions && window.userPermissions.canManageEmployees)) {
            const employeeActionButtons = document.querySelectorAll('#employees .btn');
            employeeActionButtons.forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }, 100);

    // Add form submission event listeners
    document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
        console.log('üìù Form submit event triggered');
        e.preventDefault();
        // Validate phone: 10 digits, starts with 0
        const phoneInput = document.getElementById('customerPhone');
        if (phoneInput){
            phoneInput.value = (phoneInput.value||'').replace(/[^0-9]/g,'');
            if (!/^0\d{9}$/.test(phoneInput.value)){
                if (window.showErrorModal) { showErrorModal('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0'); } else { alert('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0'); }
                phoneInput.focus();
                return;
            }
        }
        saveCustomer();
    });
    
    document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEmployee();
    });

    // Initialize auto-search with debounce for filters
    function debounce(fn, delay){
        let t; 
        return function(){ 
            clearTimeout(t); 
            const args=arguments, ctx=this; 
            t=setTimeout(function(){ fn.apply(ctx,args); }, delay||300); 
        }; 
    }
    
    // Customers
    const cName = document.getElementById('customer-name');
    const cEmail = document.getElementById('customer-email');
    if (cName) cName.addEventListener('input', debounce(searchCustomers, 300));
    if (cEmail) cEmail.addEventListener('input', debounce(searchCustomers, 300));
    
    // Employees
    const eCode = document.getElementById('employee-code');
    const eName = document.getElementById('employee-name');
    if (eCode) eCode.addEventListener('input', debounce(searchEmployees, 300));
    if (eName) eName.addEventListener('input', debounce(searchEmployees, 300));

    // Realtime phone validation styling (10 digits, starts with 0)
    function attachPhoneValidation(input){
        if (!input) return;
        function sanitizeAndValidate(){
            input.value = (input.value||'').replace(/[^0-9]/g,'');
            const ok = /^0\d{9}$/.test(input.value);
            input.style.borderColor = (ok || input.value==='') ? '#ced4da' : '#dc3545';
            input.style.boxShadow = (ok || input.value==='') ? '' : '0 0 0 0.2rem rgba(220,53,69,.25)';
        }
        input.addEventListener('input', sanitizeAndValidate);
        input.addEventListener('blur', sanitizeAndValidate);
        sanitizeAndValidate();
        // Auto-prepend '0' on focus
        input.addEventListener('focus', function(){
            let digits = (input.value||'').replace(/[^0-9]/g,'');
            if (digits.length === 0){
                digits = '0';
            } else if (!digits.startsWith('0')){
                digits = '0' + digits.substring(0,9);
            } else {
                digits = digits.substring(0,10);
            }
            input.value = digits;
            try { input.setSelectionRange(input.value.length, input.value.length); } catch(_) {}
            sanitizeAndValidate();
        });
    }
    attachPhoneValidation(document.getElementById('customerPhone'));
    attachPhoneValidation(document.getElementById('edit-customer-phone'));
    attachPhoneValidation(document.getElementById('employeePhone'));
    attachPhoneValidation(document.getElementById('edit-employee-phone'));
});

// Customer functions
function loadCustomers() {
    fetch(`{{ BACKEND_URL }}/api/accounts/`)
        .then(response => response.json())
        .then(data => {
            const customers = Array.isArray(data) ? data : (data.data || []);
            displayCustomers(customers);
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
}

// H√†m chu·∫©n h√≥a vƒÉn b·∫£n ti·∫øng Vi·ªát ƒë·ªÉ t√¨m ki·∫øm
function normalizeVietnameseText(text) {
    if (!text) return "";
    
    // Mapping d·∫•u ti·∫øng Vi·ªát sang kh√¥ng d·∫•u
    const vietnameseMap = {
        '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
        'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
        '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
        '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
        '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
        '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
        '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
        '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
        '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
        '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
        '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
        '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
        'ƒë': 'd',
        '√Ä': 'A', '√Å': 'A', '·∫¢': 'A', '√É': 'A', '·∫†': 'A',
        'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫≤': 'A', '·∫¥': 'A', '·∫∂': 'A',
        '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫®': 'A', '·∫™': 'A', '·∫¨': 'A',
        '√à': 'E', '√â': 'E', '·∫∫': 'E', '·∫º': 'E', '·∫∏': 'E',
        '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÇ': 'E', '·ªÑ': 'E', '·ªÜ': 'E',
        '√å': 'I', '√ç': 'I', '·ªà': 'I', 'ƒ®': 'I', '·ªä': 'I',
        '√í': 'O', '√ì': 'O', '·ªé': 'O', '√ï': 'O', '·ªå': 'O',
        '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªî': 'O', '·ªñ': 'O', '·ªò': 'O',
        '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ªû': 'O', '·ª†': 'O', '·ª¢': 'O',
        '√ô': 'U', '√ö': 'U', '·ª¶': 'U', '≈®': 'U', '·ª§': 'U',
        '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª¨': 'U', '·ªÆ': 'U', '·ª∞': 'U',
        '·ª≤': 'Y', '√ù': 'Y', '·ª∂': 'Y', '·ª∏': 'Y', '·ª¥': 'Y',
        'ƒê': 'D'
    };
    
    // Thay th·∫ø d·∫•u ti·∫øng Vi·ªát
    let normalized = text;
    for (const [accented, plain] of Object.entries(vietnameseMap)) {
        normalized = normalized.replace(new RegExp(accented, 'g'), plain);
    }
    
    // Chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
    normalized = normalized.toLowerCase().trim();
    
    return normalized;
}

// H√†m t√¨m ki·∫øm linh ho·∫°t - h·ªó tr·ª£ t√¨m ki·∫øm d√≠nh li·ªÅn v√† t√°ch r·ªùi
function flexibleSearch(searchText, targetText) {
    if (!searchText || !targetText) return false;
    
    // Chu·∫©n h√≥a c·∫£ hai vƒÉn b·∫£n
    const normalizedSearch = normalizeVietnameseText(searchText);
    const normalizedTarget = normalizeVietnameseText(targetText);
    
    // 1. T√¨m ki·∫øm tr·ª±c ti·∫øp (bao g·ªìm c·∫£ d√≠nh li·ªÅn)
    if (normalizedTarget.includes(normalizedSearch)) {
        return true;
    }
    
    // 2. T√¨m ki·∫øm khi t√°ch t·ª´ (n·∫øu searchText c√≥ th·ªÉ t√°ch th√†nh nhi·ªÅu t·ª´)
    const searchWords = normalizedSearch.split(/\s+/).filter(word => word.length > 0);
    if (searchWords.length > 1) {
        // N·∫øu c√≥ nhi·ªÅu t·ª´, ki·ªÉm tra xem t·∫•t c·∫£ t·ª´ c√≥ xu·∫•t hi·ªán trong target kh√¥ng
        return searchWords.every(word => normalizedTarget.includes(word));
    }
    
    // 3. T√¨m ki·∫øm khi gh√©p t·ª´ (n·∫øu searchText c√≥ th·ªÉ l√† t·ª´ gh√©p)
    if (normalizedSearch.length > 3) {
        // Th·ª≠ t√°ch th√†nh c√°c t·ª´ c√≥ th·ªÉ c√≥
        const possibleCombinations = generatePossibleCombinations(normalizedSearch);
        for (const combination of possibleCombinations) {
            if (normalizedTarget.includes(combination)) {
                return true;
            }
        }
    }
    
    // 4. T√¨m ki·∫øm fuzzy - ki·ªÉm tra ƒë·ªô t∆∞∆°ng t·ª±
    if (calculateSimilarity(normalizedSearch, normalizedTarget) > 0.7) {
        return true;
    }
    
    return false;
}

// H√†m t·∫°o c√°c t·ªï h·ª£p t·ª´ c√≥ th·ªÉ c√≥ t·ª´ m·ªôt chu·ªói d√≠nh li·ªÅn
function generatePossibleCombinations(text) {
    const combinations = [];
    
    // Th√™m ch√≠nh n√≥
    combinations.push(text);
    
    // Th√™m c√°c bi·∫øn th·ªÉ c√≥ th·ªÉ c√≥
    if (text.length > 4) {
        // Th·ª≠ ch√®n kho·∫£ng tr·∫Øng ·ªü c√°c v·ªã tr√≠ kh√°c nhau
        for (let i = 2; i < text.length - 1; i++) {
            const part1 = text.substring(0, i);
            const part2 = text.substring(i);
            combinations.push(part1 + ' ' + part2);
        }
    }
    
    // Th√™m c√°c bi·∫øn th·ªÉ thay th·∫ø k√Ω t·ª± t∆∞∆°ng t·ª±
    const similarChars = {
        'd': ['d', 'ƒë'],
        'ƒë': ['d', 'ƒë'],
        'i': ['i', 'y'],
        'y': ['i', 'y'],
        'u': ['u', '∆∞'],
        '∆∞': ['u', '∆∞'],
        'o': ['o', '√¥', '∆°'],
        '√¥': ['o', '√¥', '∆°'],
        '∆°': ['o', '√¥', '∆°'],
        'a': ['a', 'ƒÉ', '√¢'],
        'ƒÉ': ['a', 'ƒÉ', '√¢'],
        '√¢': ['a', 'ƒÉ', '√¢'],
        'e': ['e', '√™'],
        '√™': ['e', '√™']
    };
    
    // T·∫°o bi·∫øn th·ªÉ v·ªõi c√°c k√Ω t·ª± t∆∞∆°ng t·ª±
    for (const [char, alternatives] of Object.entries(similarChars)) {
        if (text.includes(char)) {
            for (const alt of alternatives) {
                if (alt !== char) {
                    combinations.push(text.replace(new RegExp(char, 'g'), alt));
                }
            }
        }
    }
    
    return combinations;
}

// H√†m t√≠nh ƒë·ªô t∆∞∆°ng t·ª± gi·ªØa hai chu·ªói (Levenshtein distance)
function calculateSimilarity(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLength = Math.max(str1.length, str2.length);
    const similarity = 1 - (matrix[str2.length][str1.length] / maxLength);
    return similarity;
}

function searchCustomers() {
    const name = normalizeVietnameseText(document.getElementById('customer-name').value);
    const email = normalizeVietnameseText(document.getElementById('customer-email').value);

    console.log('üîç Searching customers with:', { name, email });

    // Hi·ªÉn th·ªã loading indicator
    const tbody = document.getElementById('customer-table-body');
    tbody.innerHTML = '<tr><td colspan="9" class="searching">ƒêang t√¨m ki·∫øm...</td></tr>';

    if (!name && !email) {
        // N·∫øu r·ªóng, t·∫£i to√†n b·ªô danh s√°ch
        console.log('üîÑ No search criteria, loading all customers');
        loadCustomers();
        return;
    }

    // Client-side filtering gi·ªëng nh∆∞ orders.html
    console.log('üîç Performing client-side search...');
    
    // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng hi·ªán t·∫°i ho·∫∑c t·ª´ API
    fetch(`{{ BACKEND_URL }}/api/accounts/`)
        .then(response => response.json())
        .then(data => {
            const customers = Array.isArray(data) ? data : (data.data || []);
            console.log(`üìä Found ${customers.length} customers in database`);
            
            // L·ªçc d·ªØ li·ªáu theo ti√™u ch√≠ t√¨m ki·∫øm
            const filteredCustomers = customers.filter(customer => {
                let match = true;
                
                // Ki·ªÉm tra t√™n kh√°ch h√†ng - s·ª≠ d·ª•ng t√¨m ki·∫øm linh ho·∫°t
                if (name) {
                    const customerName = normalizeVietnameseText(customer.ten_tk || '');
                    if (!flexibleSearch(name, customerName)) {
                        match = false;
                    }
                }
                
                // Ki·ªÉm tra email - s·ª≠ d·ª•ng t√¨m ki·∫øm linh ho·∫°t
                if (email) {
                    const customerEmail = normalizeVietnameseText(customer.email || '');
                    if (!flexibleSearch(email, customerEmail)) {
                        match = false;
                    }
                }
                
                return match;
            });
            
            console.log(`‚úÖ Search found ${filteredCustomers.length} customers`);
            displayCustomers(filteredCustomers);
        })
        .catch(error => {
            console.error('‚ùå Error searching customers:', error);
            showAlert('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm');
            loadCustomers(); // T·∫£i l·∫°i danh s√°ch g·ªëc n·∫øu c√≥ l·ªói
        });
}

function displayCustomers(customers) {
    console.log('üéØ Displaying customers:', customers);
    
    const tbody = document.getElementById('customer-table-body');
    tbody.innerHTML = '';

    if (customers.length === 0) {
        console.log('‚ö†Ô∏è No customers to display');
        tbody.innerHTML = '<tr><td colspan="9" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch h√†ng</td></tr>';
        
        // C·∫≠p nh·∫≠t t·ªïng s·ªë
        const totalCount = document.getElementById('customer-total-count');
        if (totalCount) {
            totalCount.textContent = 'T·ªïng: 0';
        }
        return;
    }

    // S·∫Øp x·∫øp kh√°ch h√†ng theo ID ƒë·ªÉ STT c·ªë ƒë·ªãnh
    customers.sort((a, b) => a.id - b.id);
    console.log('üìä Sorted customers:', customers);

    customers.forEach((customer, index) => {
        console.log(`üë§ Processing customer ${index + 1}:`, customer);
        const row = document.createElement('tr');
        // STT t·ª± ƒë·ªông ƒë√°nh l·∫°i t·ª´ 1, 2, 3... thay v√¨ d√πng customer.id
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${customer.ten_tk || ''}</td>
            <td>${customer.tk_no || '-'}</td>
            <td>${customer.tk_co || '-'}</td>
            <td>${customer.email || ''}</td>
            <td>${customer.so_dt || ''}</td>
            <td>${customer.dia_chi || ''}</td>
            <td><span class="status-badge ${customer.trang_thai ? 'active' : 'inactive'}">${customer.trang_thai ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editCustomer(${customer.id})">S·ª≠a</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})" ${!userPermissions.canDelete ? 'style="display: none;"' : ''}>X√≥a</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // C·∫≠p nh·∫≠t t·ªïng s·ªë
    const totalCount = document.getElementById('customer-total-count');
    if (totalCount) {
        totalCount.textContent = `T·ªïng: ${customers.length}`;
    }
    
    console.log(`‚úÖ Displayed ${customers.length} customers successfully`);
}

function clearCustomerFilters() {
    document.getElementById('customer-name').value = '';
    document.getElementById('customer-email').value = '';
    
    // T·∫£i l·∫°i d·ªØ li·ªáu v√† hi·ªÉn th·ªã t·ªïng s·ªë
    loadCustomers();
}

function openAddCustomerModal() {
    // Reset form tr∆∞·ªõc khi hi·ªÉn th·ªã
    document.getElementById('addCustomerForm').reset();
    document.getElementById('addCustomerModal').style.display = 'block';
}

function closeAddCustomerModal() {
    closeModal('addCustomerModal');
}

// Ki·ªÉm tra form th√™m kh√°ch c√≥ d·ªØ li·ªáu ƒë·ªÉ c·∫£nh b√°o khi ƒë√≥ng
function hasAddCustomerFormData(){
    const name = (document.getElementById('customerName')?.value || '').trim();
    const email = (document.getElementById('customerEmail')?.value || '').trim();
    const phone = (document.getElementById('customerPhone')?.value || '').trim();
    const address = (document.getElementById('customerAddress')?.value || '').trim();
    const tkNo = (document.getElementById('customerTkNo')?.value || '').trim();
    const tkCo = (document.getElementById('customerTkCo')?.value || '').trim();
    return !!(name || email || phone || address || tkNo || tkCo);
}

// C·ªë g·∫Øng ƒë√≥ng modal th√™m kh√°ch h√†ng theo logic t∆∞∆°ng t·ª± products.html
function attemptCloseAddCustomerModal(){
    if (hasAddCustomerFormData()){
        const m = document.getElementById('confirmExitModal');
        if (!m) { document.getElementById('addCustomerModal').style.display='none'; return; }
        m.style.display = 'block';
        const stay = document.getElementById('confirmExitStayBtn');
        const leave = document.getElementById('confirmExitLeaveBtn');
        if (stay) stay.onclick = function(){ m.style.display='none'; };
        if (leave) leave.onclick = function(){
            m.style.display='none';
            document.getElementById('addCustomerForm').reset();
            document.getElementById('addCustomerModal').style.display = 'none';
        };
    } else {
        document.getElementById('addCustomerModal').style.display='none';
    }
}

function saveCustomer() {
    console.log('üöÄ B·∫Øt ƒë·∫ßu l∆∞u kh√°ch h√†ng...');
    
    // L·∫•y gi√° tr·ªã t·ª´ form
    const customerNameEl = document.getElementById('customerName');
    const customerEmailEl = document.getElementById('customerEmail');
    const customerPhoneEl = document.getElementById('customerPhone');
    const customerAddressEl = document.getElementById('customerAddress');
    const customerTkNoEl = document.getElementById('customerTkNo');
    const customerTkCoEl = document.getElementById('customerTkCo');
    
    console.log('üîç Form elements found:', {
        customerNameEl: !!customerNameEl,
        customerEmailEl: !!customerEmailEl,
        customerPhoneEl: !!customerPhoneEl,
        customerAddressEl: !!customerAddressEl,
        customerTkNoEl: !!customerTkNoEl,
        customerTkCoEl: !!customerTkCoEl
    });
    
    const customerName = customerNameEl ? customerNameEl.value : '';
    const customerEmail = customerEmailEl ? customerEmailEl.value : '';
    const customerPhone = customerPhoneEl ? customerPhoneEl.value : '';
    const customerAddress = customerAddressEl ? customerAddressEl.value : '';
    const customerTkNo = customerTkNoEl ? customerTkNoEl.value : '';
    const customerTkCo = customerTkCoEl ? customerTkCoEl.value : '';
    
    console.log('üìù Raw form values:', {
        customerName,
        customerEmail,
        customerPhone,
        customerAddress,
        customerTkNo,
        customerTkCo
    });
    
    const formData = {
        ten_tk: customerName,
        email: customerEmail,
        so_dt: customerPhone,
        dia_chi: customerAddress,
        tk_no: customerTkNo,
        tk_co: customerTkCo,
        trang_thai: true // Default to active
    };

    console.log('üìã Form data:', formData);

    // Validation
    console.log('üîç Validating form data...');
    console.log('üîç ten_tk value:', formData.ten_tk);
    console.log('üîç ten_tk trimmed:', formData.ten_tk.trim());
    console.log('üîç ten_tk length:', formData.ten_tk.trim().length);
    console.log('üîç ten_tk type:', typeof formData.ten_tk);
    
    if (!formData.ten_tk || formData.ten_tk.trim() === '') {
      console.log('‚ùå Validation failed: ten_tk is empty');
      if (window.showErrorModal) { showErrorModal('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!'); } else { alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng!'); }
      return;
    }
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu th·ª±c s·ª± kh√¥ng
    if (formData.ten_tk.trim().length < 2) {
      console.log('‚ùå Validation failed: ten_tk too short');
      if (window.showErrorModal) { showErrorModal('T√™n kh√°ch h√†ng ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±!'); } else { alert('T√™n kh√°ch h√†ng ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±!'); }
      return;
    }
    
    console.log('‚úÖ Validation passed, proceeding with save...');
    
    console.log('üì° G·ª≠i request ƒë·∫øn:', `{{ BACKEND_URL }}/api/accounts/`);
    
    fetch(`{{ BACKEND_URL }}/api/accounts/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);
        return response.json();
    })
    .then(data => {
        console.log('üì° Response data:', data);
        if (data.success === false) {
            console.error('‚ùå Backend tr·∫£ v·ªÅ l·ªói:', data.error);
            showAlert(data.error || 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin');
        } else {
            console.log('‚úÖ L∆∞u kh√°ch h√†ng th√†nh c√¥ng!');
            // B·ªè x√°c nh·∫≠n tho√°t ngay sau khi l∆∞u th√†nh c√¥ng
            window.__suppressAddCustomerConfirm = true;
            try{
            document.getElementById('addCustomerForm').reset();
                document.getElementById('addCustomerModal').style.display = 'none';
            }finally{
                setTimeout(function(){ window.__suppressAddCustomerConfirm = false; }, 0);
            }
            loadCustomers();
            if (window.showSuccessModal) { showSuccessModal('Th√™m kh√°ch h√†ng th√†nh c√¥ng!'); }
        }
    })
    .catch(error => {
        console.error('‚ùå Error saving customer:', error);
        showAlert('C√≥ l·ªói x·∫£y ra khi th√™m kh√°ch h√†ng');
    });
}

// Employee functions
function loadEmployees() {
    console.log('üîÑ Loading employees...');
    console.log('üì° Making request to /api/users');
    
    fetch(`{{ BACKEND_URL }}/api/users/`)
        .then(response => {
            console.log('üì° Response status:', response.status);
            console.log('üì° Response ok:', response.ok);
            console.log('üì° Response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            const arr = Array.isArray(data) ? data : (data.data || []);
            console.log('üìä Employee data received:', arr);
            if (arr && arr.length > 0) {
                console.log(`‚úÖ Found ${arr.length} employees`);
                console.log('üìã Employee details:', arr);
                displayEmployees(arr);
            } else {
                console.log('‚ö†Ô∏è No employee data found in response');
                displayEmployees([]);
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading employees:', error);
            console.error('‚ùå Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            displayEmployees([]);
        });
}

function searchEmployees() {
    const code = normalizeVietnameseText(document.getElementById('employee-code').value);
    const name = normalizeVietnameseText(document.getElementById('employee-name').value);

    console.log('üîç Searching employees with:', { code, name });

    // Hi·ªÉn th·ªã loading indicator
    const tbody = document.getElementById('employee-table-body');
    tbody.innerHTML = '<tr><td colspan="8" class="searching">ƒêang t√¨m ki·∫øm...</td></tr>';

    if (!code && !name) {
        // N·∫øu r·ªóng, t·∫£i to√†n b·ªô danh s√°ch
        console.log('üîÑ No search criteria, loading all employees');
        loadEmployees();
        return;
    }

    // Client-side filtering gi·ªëng nh∆∞ orders.html
    console.log('üîç Performing client-side search...');
    
    // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng hi·ªán t·∫°i ho·∫∑c t·ª´ API
    fetch(`{{ BACKEND_URL }}/api/users/`)
        .then(response => response.json())
        .then(data => {
            const employees = Array.isArray(data) ? data : (data.data || []);
            console.log(`üìä Found ${employees.length} employees in database`);
            
            // L·ªçc d·ªØ li·ªáu theo ti√™u ch√≠ t√¨m ki·∫øm
            const filteredEmployees = employees.filter(employee => {
                let match = true;
                
                // Ki·ªÉm tra m√£ nh√¢n vi√™n (username) - s·ª≠ d·ª•ng t√¨m ki·∫øm linh ho·∫°t
                if (code) {
                    const employeeCode = normalizeVietnameseText(employee.username || '');
                    if (!flexibleSearch(code, employeeCode)) {
                        match = false;
                    }
                }
                
                // Ki·ªÉm tra t√™n nh√¢n vi√™n - s·ª≠ d·ª•ng t√¨m ki·∫øm linh ho·∫°t
                if (name) {
                    const employeeName = normalizeVietnameseText(employee.name || '');
                    if (!flexibleSearch(name, employeeName)) {
                        match = false;
                    }
                }
                
                return match;
            });
            
            console.log(`‚úÖ Search found ${filteredEmployees.length} employees`);
            displayEmployees(filteredEmployees);
        })
        .catch(error => {
            console.error('‚ùå Error searching employees:', error);
            showAlert('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm');
            loadEmployees(); // T·∫£i l·∫°i danh s√°ch g·ªëc n·∫øu c√≥ l·ªói
        });
}

function displayEmployees(employees) {
    console.log('üéØ Displaying employees:', employees);
    
    const tbody = document.getElementById('employee-table-body');
    tbody.innerHTML = '';

    if (employees.length === 0) {
        console.log('‚ö†Ô∏è No employees to display');
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu nh√¢n vi√™n</td></tr>';
        
        // C·∫≠p nh·∫≠t t·ªïng s·ªë
        const totalCount = document.getElementById('employee-total-count');
        if (totalCount) {
            totalCount.textContent = 'T·ªïng: 0';
        }
        return;
    }

    // S·∫Øp x·∫øp nh√¢n vi√™n theo ID ƒë·ªÉ STT c·ªë ƒë·ªãnh
    employees.sort((a, b) => a.id - b.id);
    console.log('üìä Sorted employees:', employees);

    employees.forEach((employee, index) => {
        console.log(`üë§ Processing employee ${index + 1}:`, employee);
        const row = document.createElement('tr');
        // STT t·ª± ƒë·ªông ƒë√°nh l·∫°i t·ª´ 1, 2, 3... thay v√¨ d√πng employee.id
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${employee.username || ''}</td>
            <td>${employee.name || ''}</td>
            <td>${employee.email || ''}</td>
            <td>${employee.phone || ''}</td>
            <td>${employee.position || ''}</td>
            <td>
                <span class="status-badge ${employee.status ? 'active' : 'inactive'}">${employee.status ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editEmployee(${employee.id})" ${!userPermissions.canManageEmployees ? 'style="display: none;"' : ''}>S·ª≠a</button>
                <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${employee.id})" ${!userPermissions.canDelete || !userPermissions.canManageEmployees ? 'style="display: none;"' : ''}>X√≥a</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // C·∫≠p nh·∫≠t t·ªïng s·ªë
    const totalCount = document.getElementById('employee-total-count');
    if (totalCount) {
        totalCount.textContent = `T·ªïng: ${employees.length}`;
    }
    
    console.log(`‚úÖ Displayed ${employees.length} employees successfully`);
    
    // √Åp d·ª•ng ph√¢n quy·ªÅn cho c√°c n√∫t sau khi hi·ªÉn th·ªã b·∫£ng
    if (!(window.userPermissions && window.userPermissions.canManageEmployees)) {
        const employeeActionButtons = tbody.querySelectorAll('.btn');
        employeeActionButtons.forEach(btn => {
            btn.style.display = 'none';
        });
        console.log('üîí ƒê√£ ·∫©n c√°c n√∫t qu·∫£n l√Ω nh√¢n vi√™n cho user kh√¥ng c√≥ quy·ªÅn');
    }
}

function clearEmployeeFilters() {
    document.getElementById('employee-code').value = '';
    document.getElementById('employee-name').value = '';
    
    // T·∫£i l·∫°i d·ªØ li·ªáu v√† hi·ªÉn th·ªã t·ªïng s·ªë
    loadEmployees();
}

function openAddEmployeeModal() {
    // Ki·ªÉm tra quy·ªÅn qu·∫£n l√Ω nh√¢n vi√™n
    if (!(window.userPermissions && window.userPermissions.canManageEmployees)) {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m nh√¢n vi√™n!');
        return;
    }
    
    // Reset form tr∆∞·ªõc khi hi·ªÉn th·ªã
    document.getElementById('addEmployeeForm').reset();
    document.getElementById('addEmployeeModal').style.display = 'block';
}

function closeAddEmployeeModal() {
    closeModal('addEmployeeModal');
}

function saveEmployee() {
    // Ki·ªÉm tra quy·ªÅn qu·∫£n l√Ω nh√¢n vi√™n
    if (!userPermissions.canManageEmployees) {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m nh√¢n vi√™n!');
        return;
    }
    
    const formData = {
        username: document.getElementById('employeeUsername').value,
        password: document.getElementById('employeePassword').value,
        name: document.getElementById('employeeName').value,
        email: document.getElementById('employeeEmail').value,
        phone: document.getElementById('employeePhone').value,
        position: document.getElementById('employeePosition').value,

        status: true // Default to active
    };

    // Validate required fields
    if (!formData.username || !formData.password) {
        showAlert('Vui l√≤ng nh·∫≠p T√™n ƒëƒÉng nh·∫≠p v√† M·∫≠t kh·∫©u');
        return;
    }

    fetch(`{{ BACKEND_URL }}/api/users/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success === false) {
            showAlert(data.error || 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin');
        } else {
            window.__suppressAddEmployeeConfirm = true;
            try{
            document.getElementById('addEmployeeForm').reset();
                document.getElementById('addEmployeeModal').style.display = 'none';
            }finally{
                setTimeout(function(){ window.__suppressAddEmployeeConfirm = false; }, 0);
            }
            loadEmployees();
            if (window.showSuccessModal) { showSuccessModal('Th√™m nh√¢n vi√™n th√†nh c√¥ng!'); }
        }
    })
    .catch(error => {
        console.error('Error saving employee:', error);
        showAlert('C√≥ l·ªói x·∫£y ra khi th√™m nh√¢n vi√™n');
    });
}

 // Edit and Delete functions for customers
 function editCustomer(customerId) {
    fetch(`{{ BACKEND_URL }}/api/accounts/${customerId}`)
        .then(response => response.json())
        .then(customer => {
            document.getElementById('edit-customer-id').value = customer.id;
             document.getElementById('edit-customer-name').value = customer.ten_tk || '';
            document.getElementById('edit-customer-tk-no').value = customer.tk_no || '';
            document.getElementById('edit-customer-tk-co').value = customer.tk_co || '';
            document.getElementById('edit-customer-email').value = customer.email || '';
             document.getElementById('edit-customer-phone').value = customer.so_dt || '';
             document.getElementById('edit-customer-address').value = customer.dia_chi || '';
             document.getElementById('edit-customer-status').value = customer.trang_thai ? 'true' : 'false';
             
             // L∆∞u d·ªØ li·ªáu g·ªëc v√†o data-original ƒë·ªÉ so s√°nh
             document.getElementById('edit-customer-name').setAttribute('data-original', customer.ten_tk || '');
             document.getElementById('edit-customer-tk-no').setAttribute('data-original', customer.tk_no || '');
             document.getElementById('edit-customer-tk-co').setAttribute('data-original', customer.tk_co || '');
             document.getElementById('edit-customer-email').setAttribute('data-original', customer.email || '');
             document.getElementById('edit-customer-phone').setAttribute('data-original', customer.so_dt || '');
             document.getElementById('edit-customer-address').setAttribute('data-original', customer.dia_chi || '');
             document.getElementById('edit-customer-status').setAttribute('data-original', customer.trang_thai ? 'true' : 'false');
            
            document.getElementById('editCustomerModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading customer data:', error);
            if (window.showErrorModal) { showErrorModal('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin kh√°ch h√†ng'); } else { alert('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin kh√°ch h√†ng'); }
        });
}

   function updateCustomer() {
    const customerId = document.getElementById('edit-customer-id').value;
    // Validate phone: 10 digits, starts with 0
    const phoneEl = document.getElementById('edit-customer-phone');
    if (phoneEl){
        phoneEl.value = (phoneEl.value||'').replace(/[^0-9]/g,'');
        if (!/^0\d{9}$/.test(phoneEl.value)){
            if (window.showErrorModal) { showErrorModal('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0'); } else { alert('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0'); }
            phoneEl.focus();
            return;
        }
    }
    const formData = {
        ten_tk: document.getElementById('edit-customer-name').value,
        tk_no: document.getElementById('edit-customer-tk-no').value,
        tk_co: document.getElementById('edit-customer-tk-co').value,
        email: document.getElementById('edit-customer-email').value,
        so_dt: document.getElementById('edit-customer-phone').value,
        dia_chi: document.getElementById('edit-customer-address').value,
        trang_thai: document.getElementById('edit-customer-status').value === 'true'
    };

      fetch(`{{ BACKEND_URL }}/api/accounts/${customerId}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
          if (data.success === false) {
              showAlert(data.error);
          } else {
              // B·ªè x√°c nh·∫≠n tho√°t ngay sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng
              window.__suppressEditCustomerConfirm = true;
              try{
                  document.getElementById('editCustomerForm').reset();
                  document.getElementById('editCustomerModal').style.display = 'none';
              }finally{
                  setTimeout(function(){ window.__suppressEditCustomerConfirm = false; }, 0);
              }
              loadCustomers();
              if (window.showSuccessModal) { showSuccessModal('C·∫≠p nh·∫≠t kh√°ch h√†ng th√†nh c√¥ng!'); }
          }
      })
      .catch(error => {
          console.error('Error updating customer:', error);
          showAlert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t kh√°ch h√†ng');
      });
  }

function deleteCustomer(customerId) {
    // Ki·ªÉm tra quy·ªÅn x√≥a
    if (!(window.userPermissions && window.userPermissions.canDelete)) {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a kh√°ch h√†ng!');
        return;
    }
    // X√°c nh·∫≠n x√≥a d√πng popup chu·∫©n
    const doDelete = function(){
        fetch(`{{ BACKEND_URL }}/api/accounts/${customerId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (data && data.success === true){
                loadCustomers();
                if (window.showSuccessModal) { showSuccessModal('X√≥a kh√°ch h√†ng th√†nh c√¥ng!'); }
            } else {
                showAlert((data && data.error) || 'C√≥ l·ªói x·∫£y ra khi x√≥a kh√°ch h√†ng');
            }
        })
        .catch(err=>{
            console.error('Error deleting customer:', err);
            showAlert('C√≥ l·ªói x·∫£y ra khi x√≥a kh√°ch h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    };
    if (window.showConfirm) { return showConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?', doDelete); }
    if (window.openPopup) { return openPopup('confirm', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?', doDelete); }
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?')) doDelete();
}

 // Edit and Delete functions for employees
 function editEmployee(employeeId) {
    // Ki·ªÉm tra quy·ªÅn qu·∫£n l√Ω nh√¢n vi√™n
    if (!(window.userPermissions && window.userPermissions.canManageEmployees)) {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a nh√¢n vi√™n!');
        return;
    }
    
     fetch(`{{ BACKEND_URL }}/api/users/${employeeId}`)
         .then(response => response.json())
         .then(employee => {
             document.getElementById('edit-employee-id').value = employee.id;
             document.getElementById('edit-employee-username').value = employee.username || '';
             document.getElementById('edit-employee-password').value = ''; // Kh√¥ng hi·ªÉn th·ªã m·∫≠t kh·∫©u c≈©
             document.getElementById('edit-employee-name').value = employee.name || '';
            document.getElementById('edit-employee-username').value = employee.username || '';
             document.getElementById('edit-employee-email').value = employee.email || '';
             document.getElementById('edit-employee-phone').value = employee.phone || '';
             document.getElementById('edit-employee-position').value = employee.position || '';
            document.getElementById('edit-employee-status').value = employee.status ? 'true' : 'false';
            
            // L∆∞u d·ªØ li·ªáu g·ªëc v√†o data-original ƒë·ªÉ so s√°nh
            document.getElementById('edit-employee-username').setAttribute('data-original', employee.username || '');
            document.getElementById('edit-employee-name').setAttribute('data-original', employee.name || '');
            document.getElementById('edit-employee-email').setAttribute('data-original', employee.email || '');
            document.getElementById('edit-employee-phone').setAttribute('data-original', employee.phone || '');
            document.getElementById('edit-employee-position').setAttribute('data-original', employee.position || '');
            document.getElementById('edit-employee-status').setAttribute('data-original', employee.status ? 'true' : 'false');
             
             document.getElementById('editEmployeeModal').style.display = 'block';
         })
         .catch(error => {
             console.error('Error loading employee data:', error);
             if (window.showErrorModal) { showErrorModal('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin nh√¢n vi√™n'); } else { alert('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin nh√¢n vi√™n'); }
         });
 }

   function updateEmployee() {
      // Ki·ªÉm tra quy·ªÅn qu·∫£n l√Ω nh√¢n vi√™n
      if (!userPermissions.canManageEmployees) {
          showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t nh√¢n vi√™n!');
          return;
      }
      
      const employeeId = document.getElementById('edit-employee-id').value;
      const formData = {
          username: document.getElementById('edit-employee-username').value,
          password: document.getElementById('edit-employee-password').value,
          name: document.getElementById('edit-employee-name').value,
          email: document.getElementById('edit-employee-email').value,
          phone: document.getElementById('edit-employee-phone').value,
          position: document.getElementById('edit-employee-position').value,
          status: document.getElementById('edit-employee-status').value === 'true'
      };

      fetch(`{{ BACKEND_URL }}/api/users/${employeeId}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
          if (data.success === false) {
              showAlert(data.error);
          } else {
              window.__suppressEditEmployeeConfirm = true;
              try{
                  document.getElementById('editEmployeeForm').reset();
                  document.getElementById('editEmployeeModal').style.display = 'none';
              }finally{
                  setTimeout(function(){ window.__suppressEditEmployeeConfirm = false; }, 0);
              }
              loadEmployees();
              if (window.showSuccessModal) { showSuccessModal('C·∫≠p nh·∫≠t nh√¢n vi√™n th√†nh c√¥ng!'); }
          }
      })
      .catch(error => {
          console.error('Error updating employee:', error);
          showAlert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t nh√¢n vi√™n');
      });
  }

function deleteEmployee(employeeId) {
    // Ki·ªÉm tra quy·ªÅn x√≥a nh√¢n vi√™n
    if (!(window.userPermissions && window.userPermissions.canDelete) || !(window.userPermissions && window.userPermissions.canManageEmployees)) {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a nh√¢n vi√™n!');
        return;
    }
    const doDelete = function(){
        fetch(`{{ BACKEND_URL }}/api/users/${employeeId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r=>r.json())
        .then(data=>{
            if (data && data.success === true){
                loadEmployees();
                if (window.showSuccessModal) { showSuccessModal('X√≥a nh√¢n vi√™n th√†nh c√¥ng!'); }
            } else {
                showAlert((data && data.error) || 'C√≥ l·ªói x·∫£y ra khi x√≥a nh√¢n vi√™n');
            }
        })
        .catch(err=>{
            console.error('Error deleting employee:', err);
            showAlert('C√≥ l·ªói x·∫£y ra khi x√≥a nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    };
    if (window.showConfirm) { return showConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n n√†y?', doDelete); }
    if (window.openPopup) { return openPopup('confirm', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n n√†y?', doDelete); }
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n n√†y?')) doDelete();
}

 // Success notification functions (proxy to global modal)
 function showSuccessNotification(message) {
     if (window.showSuccessModal) { window.showSuccessModal(message || 'Th√†nh c√¥ng'); return; }
     alert(message || 'Th√†nh c√¥ng');
 }

 function closeSuccessNotification() {
     if (window.hideSuccessModal) { window.hideSuccessModal(); }
 }

  // Alert helper
  function showAlert(message) {
      if (window.showErrorModal) { window.showErrorModal(message); return; }
      const el = document.getElementById('alertModal');
      const msg = document.getElementById('alertMessage');
      if (el && msg){
          msg.textContent = message;
          el.style.display = 'block';
          setTimeout(()=>{ el.style.display='none'; }, 3000);
      }
  }

  // Confirm helper
  function closeConfirm() {
      document.getElementById('confirmDeleteModal').style.display = 'none';
      // X√≥a c√°c bi·∫øn l∆∞u tr·ªØ
      if (window.customerToDelete) {
          delete window.customerToDelete;
      }
      if (window.employeeToDelete) {
          delete window.employeeToDelete;
      }
  }

 // Close modal when clicking outside
document.addEventListener('click', function(event) {
     const modals = document.querySelectorAll('.modal');
     modals.forEach(modal => {
         if (event.target === modal) {
            // Ch·ªâ x·ª≠ l√Ω cho c√°c modal ch√≠nh, kh√¥ng ph·∫£i modal x√°c nh·∫≠n
            if (modal.id === 'confirmExitModal' || modal.id === 'confirmDeleteModal' || 
                modal.id === 'successNotificationModal' || modal.id === 'alertModal') {
                return;
            }
            
            // B·ªè x√°c nh·∫≠n tho√°t sau khi l∆∞u th√†nh c√¥ng ·ªü Add Customer
            if (modal.id === 'addCustomerModal' && window.__suppressAddCustomerConfirm) {
                window.__suppressAddCustomerConfirm = false;
                modal.style.display = 'none';
                return;
            }
            
            // Ki·ªÉm tra n·∫øu c√≥ d·ªØ li·ªáu thay ƒë·ªïi trong form
            if (hasFormDataChanged(modal.id)) {
                // C√≥ d·ªØ li·ªáu thay ƒë·ªïi -> hi·ªÉn th·ªã x√°c nh·∫≠n tho√°t
                     document.getElementById('confirmExitModal').style.display = 'block';
                
                     // G√°n s·ª± ki·ªán cho c√°c n√∫t
                     document.getElementById('confirmExitStayBtn').onclick = function() {
                         document.getElementById('confirmExitModal').style.display = 'none';
                     };
                     document.getElementById('confirmExitLeaveBtn').onclick = function() {
                         document.getElementById('confirmExitModal').style.display = 'none';
                         
                         // X√≥a d·ªØ li·ªáu v√† ƒë√≥ng modal
                    if (modal.id === 'editCustomerModal') {
                             document.getElementById('editCustomerForm').reset();
                             document.getElementById('editCustomerModal').style.display = 'none';
                         } else if (modal.id === 'editEmployeeModal') {
                             document.getElementById('editEmployeeForm').reset();
                             document.getElementById('editEmployeeModal').style.display = 'none';
                         }
                     };
                 } else {
                // Kh√¥ng c√≥ d·ªØ li·ªáu thay ƒë·ªïi ho·∫∑c l√† modal t·∫°o m·ªõi -> ƒë√≥ng ngay
                 modal.style.display = 'none';
             }
         }
     });
});

// H√†m ki·ªÉm tra d·ªØ li·ªáu thay ƒë·ªïi trong form
function hasFormDataChanged(modalId) {
    let hasData = false;
    
    if (modalId === 'addCustomerModal') {
        // V·ªõi popup th√™m kh√°ch h√†ng: x√°c nh·∫≠n n·∫øu c√≥ d·ªØ li·ªáu
        hasData = hasAddCustomerFormData();
        
    } else if (modalId === 'addEmployeeModal') {
        // V·ªõi popup th√™m nh√¢n vi√™n: x√°c nh·∫≠n n·∫øu c√≥ d·ªØ li·ªáu
        hasData = hasAddEmployeeFormData();
        
    } else if (modalId === 'editCustomerModal') {
        // Ki·ªÉm tra form s·ª≠a kh√°ch h√†ng - so s√°nh v·ªõi d·ªØ li·ªáu g·ªëc
        const currentName = document.getElementById('edit-customer-name').value.trim();
        const currentTkNo = document.getElementById('edit-customer-tk-no').value.trim();
        const currentTkCo = document.getElementById('edit-customer-tk-co').value.trim();
        const currentEmail = document.getElementById('edit-customer-email').value.trim();
        const currentPhone = document.getElementById('edit-customer-phone').value.trim();
        const currentAddress = document.getElementById('edit-customer-address').value.trim();
        const currentStatus = document.getElementById('edit-customer-status').value;
        
        // So s√°nh v·ªõi d·ªØ li·ªáu g·ªëc (l∆∞u trong data attributes)
        const originalName = document.getElementById('edit-customer-name').getAttribute('data-original') || '';
        const originalTkNo = document.getElementById('edit-customer-tk-no').getAttribute('data-original') || '';
        const originalTkCo = document.getElementById('edit-customer-tk-co').getAttribute('data-original') || '';
        const originalEmail = document.getElementById('edit-customer-email').getAttribute('data-original') || '';
        const originalPhone = document.getElementById('edit-customer-phone').getAttribute('data-original') || '';
        const originalAddress = document.getElementById('edit-customer-address').getAttribute('data-original') || '';
        const originalStatus = document.getElementById('edit-customer-status').getAttribute('data-original') || 'true';
        
        hasData = (currentName !== originalName) || 
                  (currentTkNo !== originalTkNo) || 
                  (currentTkCo !== originalTkCo) || 
                  (currentEmail !== originalEmail) || 
                  (currentPhone !== originalPhone) || 
                  (currentAddress !== originalAddress) || 
                  (currentStatus !== originalStatus);
        
    } else if (modalId === 'editEmployeeModal') {
        // Ki·ªÉm tra form s·ª≠a nh√¢n vi√™n - so s√°nh v·ªõi d·ªØ li·ªáu g·ªëc
        const currentUsername = document.getElementById('edit-employee-username').value.trim();
        const currentPassword = document.getElementById('edit-employee-password').value.trim();
        const currentName = document.getElementById('edit-employee-name').value.trim();
        const currentEmail = document.getElementById('edit-employee-email').value.trim();
        const currentPhone = document.getElementById('edit-employee-phone').value.trim();
        const currentPosition = document.getElementById('edit-employee-position').value.trim();
        const currentStatus = document.getElementById('edit-employee-status').value;
        
        // So s√°nh v·ªõi d·ªØ li·ªáu g·ªëc (l∆∞u trong data attributes)
        const originalUsername = document.getElementById('edit-employee-username').getAttribute('data-original') || '';
        const originalName = document.getElementById('edit-employee-name').getAttribute('data-original') || '';
        const originalEmail = document.getElementById('edit-employee-email').getAttribute('data-original') || '';
        const originalPhone = document.getElementById('edit-employee-phone').getAttribute('data-original') || '';
        const originalPosition = document.getElementById('edit-employee-position').getAttribute('data-original') || '';
        const originalStatus = document.getElementById('edit-employee-status').getAttribute('data-original') || 'true';
        
        hasData = (currentUsername !== originalUsername) || 
                  (currentPassword !== '') || // N·∫øu c√≥ nh·∫≠p m·∫≠t kh·∫©u m·ªõi
                  (currentName !== originalName) || 
                  (currentEmail !== originalEmail) || 
                  (currentPhone !== originalPhone) || 
                  (currentPosition !== originalPosition) || 
                  (currentStatus !== originalStatus);
    }
    
    return hasData;
}

// H√†m ƒë√≥ng modal ch√≠nh - ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi ƒë√≥ng
function closeModal(modalId) {
    // Cho ph√©p ƒë√≥ng Add Customer kh√¥ng c·∫ßn x√°c nh·∫≠n sau khi l∆∞u
    if (modalId === 'addCustomerModal' && window.__suppressAddCustomerConfirm) {
        window.__suppressAddCustomerConfirm = false;
        document.getElementById(modalId).style.display = 'none';
        return;
    }
    // Cho ph√©p ƒë√≥ng Edit Customer kh√¥ng c·∫ßn x√°c nh·∫≠n sau khi c·∫≠p nh·∫≠t
    if (modalId === 'editCustomerModal' && window.__suppressEditCustomerConfirm) {
        window.__suppressEditCustomerConfirm = false;
        document.getElementById(modalId).style.display = 'none';
        return;
    }
    // Cho ph√©p ƒë√≥ng Employee kh√¥ng c·∫ßn x√°c nh·∫≠n sau khi l∆∞u/c·∫≠p nh·∫≠t
    if (modalId === 'addEmployeeModal' && window.__suppressAddEmployeeConfirm) {
        window.__suppressAddEmployeeConfirm = false;
        document.getElementById(modalId).style.display = 'none';
        return;
    }
    if (modalId === 'editEmployeeModal' && window.__suppressEditEmployeeConfirm) {
        window.__suppressEditEmployeeConfirm = false;
        document.getElementById(modalId).style.display = 'none';
        return;
    }
    if (hasFormDataChanged(modalId)) {
        // C√≥ d·ªØ li·ªáu thay ƒë·ªïi -> hi·ªÉn th·ªã x√°c nh·∫≠n
        document.getElementById('confirmExitModal').style.display = 'block';
        
        // G√°n s·ª± ki·ªán cho c√°c n√∫t
        document.getElementById('confirmExitStayBtn').onclick = function() {
            document.getElementById('confirmExitModal').style.display = 'none';
        };
        document.getElementById('confirmExitLeaveBtn').onclick = function() {
            document.getElementById('confirmExitModal').style.display = 'none';
            
            // X√≥a d·ªØ li·ªáu v√† ƒë√≥ng modal (cho edit v√† add customer)
            if (modalId === 'editCustomerModal') {
                document.getElementById('editCustomerForm').reset();
                document.getElementById('editCustomerModal').style.display = 'none';
            } else if (modalId === 'editEmployeeModal') {
                document.getElementById('editEmployeeForm').reset();
                document.getElementById('editEmployeeModal').style.display = 'none';
            } else if (modalId === 'addCustomerModal') {
                document.getElementById('addCustomerForm').reset();
                document.getElementById('addCustomerModal').style.display = 'none';
            } else if (modalId === 'addEmployeeModal') {
                document.getElementById('addEmployeeForm').reset();
                document.getElementById('addEmployeeModal').style.display = 'none';
            }
        };
    } else {
        // Kh√¥ng c√≥ d·ªØ li·ªáu thay ƒë·ªïi -> ƒë√≥ng ngay
        document.getElementById(modalId).style.display = 'none';
    }
}



      // Debug function ƒë·ªÉ ki·ªÉm tra khung t√†i kho·∫£n
      window.debugUserHeader = function() {
        console.log('üîç Debug User Account Header:');
        console.log('  - Username element:', document.getElementById('username-display'));
        console.log('  - Current username:', document.getElementById('username-display')?.textContent);
        console.log('  - Session username:', '{{ session.get("username", "") }}');
        console.log('  - Session user_id:', '{{ session.get("user_id", "") }}');
        console.log('  - Is expanded:', document.querySelector('.user-account-header')?.classList.contains('expanded'));
        console.log('  - Header element:', document.querySelector('.user-account-header'));
        console.log('  - Session data:', {
          username: '{{ session.get("username", "") }}',
          user_id: '{{ session.get("user_id", "") }}'
        });
        
        // Ki·ªÉm tra th√™m
        console.log('  - Template username check:', '{{ session.get("username") }}');
        console.log('  - Template user_id check:', '{{ session.get("user_id") }}');
        console.log('  - Template session exists:', '{{ session }}');
        
        // G·ªçi h√†m ki·ªÉm tra session
        console.log('üîÑ G·ªçi checkSessionAndUpdate...');
        checkSessionAndUpdate();
      };

      // Debug function ƒë·ªÉ ki·ªÉm tra modal
      window.debugModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          console.log(`üîç Debug Modal: ${modalId}`);
          console.log('  - Modal element:', modal);
          console.log('  - Modal display:', modal.style.display);
          console.log('  - Modal content:', modal.querySelector('.modal-content'));
          console.log('  - Modal footer:', modal.querySelector('.modal-footer'));
          console.log('  - Save button:', modal.querySelector('.btn-success'));
          console.log('  - Cancel button:', modal.querySelector('.btn-cancel'));
        } else {
          console.error(`‚ùå Modal ${modalId} kh√¥ng t·ªìn t·∫°i`);
        }
      };

      // G·ªçi debug function khi c·∫ßn thi·∫øt
      if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
        console.log('üîß Debug functions available:');
        console.log('  - window.debugUserHeader() - Ki·ªÉm tra khung t√†i kho·∫£n');
        console.log('  - window.forceRefreshUserInfo() - Force refresh th√¥ng tin ng∆∞·ªùi d√πng');
        console.log('  - window.refreshUserInfo() - C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng');
        console.log('  - window.debugModal("editEmployeeModal") - Ki·ªÉm tra modal edit nh√¢n vi√™n');
        console.log('  - window.debugModal("editCustomerModal") - Ki·ªÉm tra modal edit kh√°ch h√†ng');
        
        // T·ª± ƒë·ªông debug khi load trang
        setTimeout(() => {
          console.log('üîç Auto-debug user header...');
          window.debugUserHeader();
        }, 1000);
      }

</script>
{% endblock %}

