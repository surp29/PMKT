<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PHD Computer{% endblock %}</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='1.0') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <!-- Logo -->
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="PHD Logo" />
        </div>

        <!-- Menu -->
        <ul>
            <li><a href="{{ url_for('general_diary') }}" {% if request.endpoint == 'general_diary' %}class="active"{% endif %}><i class="fas fa-home"></i> Nh·∫≠t k√Ω chung</a></li>
            <li>


              <a href="javascript:void(0)" class="dropdown-btn {% if request.endpoint in ['products','product_groups','prices'] %}active{% endif %}" data-dropdown="products">
                    <i class="fas fa-box"></i> Qu·∫£n l√Ω s·∫£n ph·∫©m <i class="fas fa-caret-down"></i>
                </a>
                <ul class="dropdown-container" {% if request.endpoint in ['products','product_groups','prices'] %}style="display:block;"{% endif %}>
                    <li><a href="{{ url_for('products') }}" {% if request.endpoint == 'products' %}class="active"{% endif %}>S·∫£n ph·∫©m</a></li>
                    <li><a href="{{ url_for('product_groups') }}" {% if request.endpoint == 'product_groups' %}class="active"{% endif %}>Qu·∫£n l√Ω nh√≥m s·∫£n ph·∫©m</a></li>
                    <li><a href="{{ url_for('prices') }}" {% if request.endpoint == 'prices' %}class="active"{% endif %}>B·∫£ng gi√°</a></li>
                </ul>
            </li>
            <li><a href="{{ url_for('orders') }}"><i class="fas fa-shopping-cart"></i> ƒê∆°n h√†ng</a></li>
            <li><a href="{{ url_for('invoices') }}"><i class="fas fa-file-invoice"></i> H√≥a ƒë∆°n</a></li>
            <li><a href="{{ url_for('warehouse') }}"><i class="fas fa-warehouse"></i> Kho h√†ng</a></li>
            <li><a href="{{ url_for('reports') }}"><i class="fas fa-chart-line"></i> B√°o c√°o</a></li>
            <li><a href="{{ url_for('account_management') }}"><i class="fas fa-users-cog"></i> Qu·∫£n l√Ω t√†i kho·∫£n</a></li>
        </ul>
    </div>

    <!-- User Account Header -->
    <div class="user-account-header" title="Click ƒë·ªÉ m·ªü r·ªông khung t√†i kho·∫£n">
        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span class="username" id="username-display">
                {% if session.get('username') %}
                    {{ session.get('username') }}
                {% else %}
                    Kh√°ch
                {% endif %}
            </span>
        </div>
        <div class="user-actions">
            <button class="switch-account-btn" onclick="openSwitchAccountModal()">
                <i class="fas fa-exchange-alt"></i> Chuy·ªÉn TK
            </button>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <!-- Global Notification Modal -->
    <div id="globalNotificationModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:99999; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
      <div class="modal-content" style="max-width:480px;">
        <div id="globalNotificationHeader" class="modal-header" style="justify-content:center;">
          <h3 id="globalNotificationTitle" style="margin:0; text-align:center; color:#fff;">Th√¥ng b√°o</h3>
        </div>
        <div class="modal-body" style="padding:20px; text-align:center;">
          <div>
            <i id="globalNotificationIcon" class="fas fa-info-circle" style="font-size:48px; margin-bottom:15px;"></i>
            <p id="globalNotificationMessage" style="font-size:16px; margin:0; color:#333;">Tin nh·∫Øn</p>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:center; gap:10px; padding:16px;">
          <button type="button" id="btnGlobalNotificationOK" style="background:#1976d2; color:#fff; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-size:14px;">OK</button>
        </div>
      </div>
    </div>

    <!-- Modal chuy·ªÉn t√†i kho·∫£n -->
    <div id="switchAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: white; text-align: center; width: 100%; margin: 0;">Chuy·ªÉn t√†i kho·∫£n</h3>
                <span class="close" onclick="closeSwitchAccountModal()">&times;</span>
            </div>
            <form id="switchAccountForm">
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p *</label>
                    <input type="text" id="switchUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u *</label>
                    <input type="password" id="switchPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="save-btn">ƒêƒÉng nh·∫≠p</button>
                </div>
            </form>
        </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dropdown = document.querySelector('.dropdown-btn');
        dropdown.addEventListener('click', function () {
          // N·∫øu dropdown ƒë√£ active (ƒëang ·ªü trang con), kh√¥ng toggle
          if (this.classList.contains('active') && 
              (window.location.pathname.includes('/products') || 
               window.location.pathname.includes('/product-groups') || 
               window.location.pathname.includes('/prices'))) {
            return;
          }
          
          this.classList.toggle('active');
          const container = this.nextElementSibling;
          if (container.style.display === "block") {
            container.style.display = "none";
          } else {
            container.style.display = "block";
          }
        });

        // X·ª≠ l√Ω form chuy·ªÉn t√†i kho·∫£n
        const switchAccountForm = document.getElementById('switchAccountForm');
        if (switchAccountForm) {
          switchAccountForm.addEventListener('submit', function(e) {
            e.preventDefault();
            switchAccount();
          });
          
          // Th√™m event listener cho ph√≠m Enter tr√™n c√°c input field
          const usernameInput = document.getElementById('switchUsername');
          const passwordInput = document.getElementById('switchPassword');
          
          if (usernameInput) {
            usernameInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                switchAccount();
              }
            });
          }
          
          if (passwordInput) {
            passwordInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                switchAccount();
              }
            });
          }
        }

        // X·ª≠ l√Ω click v√†o khung t√†i kho·∫£n ƒë·ªÉ m·ªü r·ªông/thu g·ªçn
        const userAccountHeader = document.querySelector('.user-account-header');
        if (userAccountHeader) {
          userAccountHeader.addEventListener('click', function(e) {
            // Ch·ªâ toggle khi click v√†o khung ch√≠nh, kh√¥ng ph·∫£i v√†o c√°c n√∫t
            if (e.target === this || e.target.closest('.user-info')) {
              this.classList.toggle('expanded');
              
              // Th√™m hi·ªáu ·ª©ng focus ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ click
              this.style.outline = '2px solid #007bff';
              this.style.outlineOffset = '2px';
              
              // X√≥a outline sau 300ms
              setTimeout(() => {
                this.style.outline = '';
                this.style.outlineOffset = '';
              }, 300);
            }
          });

          // NgƒÉn ch·∫∑n event bubbling t·ª´ c√°c n√∫t
          const buttons = userAccountHeader.querySelectorAll('button');
          buttons.forEach(button => {
            button.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          });

          // T·ª± ƒë·ªông thu g·ªçn khi click ra ngo√†i
          document.addEventListener('click', function(e) {
            if (!userAccountHeader.contains(e.target)) {
              userAccountHeader.classList.remove('expanded');
            }
          });

          // Thu g·ªçn khi nh·∫•n ESC
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              userAccountHeader.classList.remove('expanded');
            }
          });

          // Th√™m hi·ªáu ·ª©ng hover cho icon
          const userIcon = userAccountHeader.querySelector('.user-info i');
          if (userIcon) {
            userIcon.addEventListener('mouseenter', function() {
              this.style.color = '#0056b3';
            });
            
            userIcon.addEventListener('mouseleave', function() {
              this.style.color = '#007bff';
            });
          }
        }

        // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng t·ª´ session
        updateUsername();
        
        // Ki·ªÉm tra session t·ª´ server ƒë·ªÉ ƒë·∫£m b·∫£o t√™n ng∆∞·ªùi d√πng ƒë∆∞·ª£c hi·ªÉn th·ªã ƒë√∫ng
        setTimeout(() => {
          checkSessionAndUpdate();
        }, 500);
      });

      // H√†m c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
      function updateUsername() {
        const usernameElement = document.getElementById('username-display');
        if (usernameElement) {
          // L·∫•y t√™n ng∆∞·ªùi d√πng t·ª´ session
          const currentUsername = '{{ session.get("username", "") }}';
          const userId = '{{ session.get("user_id", "") }}';
          
          console.log('üîç Debug updateUsername:');
          console.log('  - Session username:', currentUsername);
          console.log('  - Session user_id:', userId);
          console.log('  - Username element:', usernameElement);
          
          if (currentUsername && currentUsername.trim() !== '' && currentUsername !== 'None') {
            // N·∫øu c√≥ t√™n ng∆∞·ªùi d√πng th·ª±c, hi·ªÉn th·ªã
            usernameElement.textContent = currentUsername;
            console.log('‚úÖ C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng:', currentUsername);
          } else {
            // N·∫øu kh√¥ng c√≥ t√™n ng∆∞·ªùi d√πng, hi·ªÉn th·ªã "Kh√°ch"
            usernameElement.textContent = 'Kh√°ch';
            console.log('‚ö†Ô∏è Kh√¥ng c√≥ t√™n ng∆∞·ªùi d√πng, hi·ªÉn th·ªã "Kh√°ch"');
            console.log('  - L√Ω do: currentUsername =', currentUsername);
          }
        } else {
          console.error('‚ùå Kh√¥ng t√¨m th·∫•y element username-display');
        }
      }

      // M·ªü modal chuy·ªÉn t√†i kho·∫£n
      function openSwitchAccountModal() {
        document.getElementById('switchAccountModal').style.display = 'block';
        document.getElementById('switchAccountForm').reset();
      }

      // ƒê√≥ng modal chuy·ªÉn t√†i kho·∫£n
      function closeSwitchAccountModal() {
        document.getElementById('switchAccountModal').style.display = 'none';
      }

      // X·ª≠ l√Ω chuy·ªÉn t√†i kho·∫£n
      async function switchAccount() {
        const username = document.getElementById('switchUsername').value;
        const password = document.getElementById('switchPassword').value;

        if (!username || !password) {
          if (window.showErrorModal) { showErrorModal('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!'); } else { alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!'); }
          return;
        }

        try {
          console.log('üîê ƒêang chuy·ªÉn t√†i kho·∫£n:', { username, password: '***' });
          
          const response = await fetch('/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
          });

          console.log('üì° Response status:', response.status);
          console.log('üì° Response ok:', response.ok);

          if (response.ok) {
            // ƒêƒÉng nh·∫≠p th√†nh c√¥ng, reload trang
            console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng, reload trang...');
            window.location.reload();
          } else {
            try {
              const data = await response.json();
              console.log('‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i:', data);
              
              // Ki·ªÉm tra n·∫øu t√†i kho·∫£n b·ªã v√¥ hi·ªáu h√≥a
              if (data.error && data.error.includes('T√†i kho·∫£n ƒë√£ b·ªã t·∫Øt')) {
                if (window.showErrorModal) { 
                  showErrorModal('T√†i kho·∫£n ƒëang b·ªã v√¥ hi·ªáu h√≥a!'); 
                } else { 
                  alert('T√†i kho·∫£n ƒëang b·ªã v√¥ hi·ªáu h√≥a!'); 
                }
              } else {
                if (window.showErrorModal) { 
                  showErrorModal(data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!'); 
                } else { 
                  alert(data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!'); 
                }
              }
            } catch (parseError) {
              console.error('‚ùå L·ªói parse response:', parseError);
              if (window.showErrorModal) { 
                showErrorModal('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.'); 
              } else { 
                alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.'); 
              }
            }
          }
        } catch (error) {
          console.error('‚ùå Error trong switchAccount:', error);
          console.error('‚ùå Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
          });
          
          if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            if (window.showErrorModal) { 
              showErrorModal('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server! Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.'); 
            } else { 
              alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server! Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.'); 
            }
          } else {
            if (window.showErrorModal) { 
              showErrorModal('C√≥ l·ªói x·∫£y ra khi chuy·ªÉn t√†i kho·∫£n! Vui l√≤ng th·ª≠ l·∫°i.'); 
            } else { 
              alert('C√≥ l·ªói x·∫£y ra khi chuy·ªÉn t√†i kho·∫£n! Vui l√≤ng th·ª≠ l·∫°i.'); 
            }
          }
        }
      }

      // X·ª≠ l√Ω logout
      function logout() {
        // ƒêƒÉng xu·∫•t tr·ª±c ti·∫øp kh√¥ng c·∫ßn x√°c nh·∫≠n
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/login';
          })
          .catch(() => {
            window.location.href = '/login';
          });
      }

      // ƒê√≥ng modal khi click b√™n ngo√†i
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('switchAccountModal');
        if (event.target === modal) {
          closeSwitchAccountModal();
        }
      });

      // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng khi session thay ƒë·ªïi
      function refreshUserInfo() {
        updateUsername();
      }

      // G·ªçi h√†m c·∫≠p nh·∫≠t khi c·∫ßn thi·∫øt
      window.refreshUserInfo = refreshUserInfo;

      // H√†m ki·ªÉm tra session v√† c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng
      function checkSessionAndUpdate() {
        console.log('üîç Ki·ªÉm tra session v√† c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng...');
        
        // Ki·ªÉm tra session t·ª´ server
        fetch('/check-session', { 
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => {
            console.log('üì° Check-session response status:', response.status);
            console.log('üì° Check-session response ok:', response.ok);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
          })
          .then(data => {
            console.log('üì° Session data t·ª´ server:', data);
            
            if (data.username && data.username.trim() !== '') {
              const usernameElement = document.getElementById('username-display');
              if (usernameElement) {
                usernameElement.textContent = data.username;
                console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng t·ª´ server:', data.username);
              }
            } else {
              console.log('‚ö†Ô∏è Kh√¥ng c√≥ username trong session t·ª´ server');
              updateUsername(); // Fallback v·ªÅ template
            }
          })
          .catch(error => {
            console.error('‚ùå L·ªói khi ki·ªÉm tra session:', error);
            console.error('‚ùå Error details:', {
              name: error.name,
              message: error.message,
              stack: error.stack
            });
            updateUsername(); // Fallback v·ªÅ template
          });
      }

      // H√†m force refresh user info
      window.forceRefreshUserInfo = function() {
        console.log('üîÑ Force refresh user info...');
        checkSessionAndUpdate();
      };

      // Debug function ƒë·ªÉ ki·ªÉm tra khung t√†i kho·∫£n
      window.debugUserHeader = function() {
        console.log('üîç Debug User Account Header:');
        console.log('  - Username element:', document.getElementById('username-display'));
        console.log('  - Current username:', document.getElementById('username-display')?.textContent);
        console.log('  - Session username:', '{{ session.get("username", "") }}');
        console.log('  - Session user_id:', '{{ session.get("user_id", "") }}');
        console.log('  - Is expanded:', document.querySelector('.user-account-header')?.classList.contains('expanded'));
        console.log('  - Header element:', document.querySelector('.user-account-header'));
        console.log('  - Session data:', {
          username: '{{ session.get("username", "") }}',
          user_id: '{{ session.get("user_id", "") }}'
        });
        
        // Ki·ªÉm tra th√™m
        console.log('  - Template username check:', '{{ session.get("username") }}');
        console.log('  - Template user_id check:', '{{ session.get("user_id") }}');
        console.log('  - Template session exists:', '{{ session }}');
        
        // G·ªçi h√†m ki·ªÉm tra session
        console.log('üîÑ G·ªçi checkSessionAndUpdate...');
        checkSessionAndUpdate();
      };



      // G·ªçi debug function khi c·∫ßn thi·∫øt
      if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
        console.log('üîß Debug functions available:');
        console.log('  - window.debugUserHeader() - Ki·ªÉm tra khung t√†i kho·∫£n');
        console.log('  - window.forceRefreshUserInfo() - Force refresh th√¥ng tin ng∆∞·ªùi d√πng');
        console.log('  - window.refreshUserInfo() - C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng');

        
        // T·ª± ƒë·ªông debug khi load trang
        setTimeout(() => {
          console.log('üîç Auto-debug user header...');
          window.debugUserHeader();
        }, 1000);
      }
    </script>
    <script>
      // Global permission management
      window.userPermissions = {
        isAdmin: false,
        canDelete: false,
        canManageEmployees: false
      };

      // Function to check user permissions globally
      function checkUserPermissions() {
        const username = '{{ session.get("username", "") }}';
        console.log('üîê Checking global permissions for user:', username);
        
        // Ki·ªÉm tra quy·ªÅn admin
        window.userPermissions.isAdmin = username === 'admin';
        window.userPermissions.canDelete = username === 'admin';
        window.userPermissions.canManageEmployees = username === 'admin';
        
        console.log('üîê Global user permissions:', window.userPermissions);
        
        // √Åp d·ª•ng ph√¢n quy·ªÅn cho giao di·ªán
        applyPermissionsToUI();
      }

      // Function to apply permissions to UI globally
      function applyPermissionsToUI() {
        // ·∫®n/hi·ªán t·∫•t c·∫£ c√°c n√∫t x√≥a d·ª±a tr√™n quy·ªÅn
        const deleteButtons = document.querySelectorAll('.btn-delete, .btn-action.btn-delete, .btn-delete-order, .btn-delete-product, .btn-delete-price, .btn-delete-invoice, .btn-delete-warehouse, .btn-delete-account, .btn-delete-employee, .btn-delete-group, .btn-delete-warehouse');
        deleteButtons.forEach(btn => {
          if (window.userPermissions.canDelete) {
            btn.style.display = 'inline-block';
          } else {
            btn.style.display = 'none';
          }
        });

        // ·∫®n/hi·ªán c√°c n√∫t x√≥a trong b·∫£ng d·ª±a tr√™n class v√† onclick
        const tableDeleteButtons = document.querySelectorAll('button[onclick*="delete"], button[onclick*="confirmDelete"], .delete-btn, .remove-btn, button[onclick*="deleteOrder"], button[onclick*="deleteProduct"], button[onclick*="deletePrice"], button[onclick*="deleteInvoice"], button[onclick*="deleteWarehouse"], button[onclick*="deleteAccount"], button[onclick*="deleteEmployee"], button[onclick*="deleteGroup"], button[data-id][data-code]');
        tableDeleteButtons.forEach(btn => {
          if (window.userPermissions.canDelete) {
            btn.style.display = 'inline-block';
          } else {
            btn.style.display = 'none';
          }
        });

        // Th√™m selector c·ª• th·ªÉ cho c√°c button c√≥ icon trash (n√∫t x√≥a)
        const trashButtons = document.querySelectorAll('button i.fa-trash, button i.fas.fa-trash');
        trashButtons.forEach(icon => {
          const button = icon.closest('button');
          if (button && !window.userPermissions.canDelete) {
            button.style.display = 'none';
          }
        });

        console.log('üîê Applied permissions to UI - Delete buttons hidden for non-admin users');
      }

      // Expose functions globally
      window.checkUserPermissions = checkUserPermissions;
      window.applyPermissionsToUI = applyPermissionsToUI;

      // Auto-check permissions when page loads
      document.addEventListener('DOMContentLoaded', function() {
        checkUserPermissions();
        
        // T·ª± ƒë·ªông ƒë√°nh d·∫•u dropdown button active khi ·ªü trang con
        markActiveDropdownMenu();
      });
      
      // H√†m ƒë√°nh d·∫•u dropdown menu active d·ª±a tr√™n URL hi·ªán t·∫°i
      function markActiveDropdownMenu() {
        const currentPath = window.location.pathname;
        
        // Ki·ªÉm tra c√°c trang con c·ªßa "Qu·∫£n l√Ω s·∫£n ph·∫©m"
        if (currentPath.includes('/products') || 
            currentPath.includes('/product-groups') || 
            currentPath.includes('/prices')) {
          
          // T√¨m dropdown button "Qu·∫£n l√Ω s·∫£n ph·∫©m"
          const productDropdown = document.querySelector('.dropdown-btn[data-dropdown="products"]');
          if (productDropdown) {
            productDropdown.classList.add('active');
            
            // M·ªü dropdown container
            const dropdownContainer = productDropdown.nextElementSibling;
            if (dropdownContainer && dropdownContainer.classList.contains('dropdown-container')) {
              dropdownContainer.style.display = 'block';
            }
            
            // ƒê√°nh d·∫•u submenu item active
            let activeSubmenu = null;
            if (currentPath.includes('/products')) {
              activeSubmenu = document.querySelector('.dropdown-container a[href*="products"]');
            } else if (currentPath.includes('/product-groups')) {
              activeSubmenu = document.querySelector('.dropdown-container a[href*="product-groups"]');
            } else if (currentPath.includes('/prices')) {
              activeSubmenu = document.querySelector('.dropdown-container a[href*="prices"]');
            }
            
            if (activeSubmenu) {
              activeSubmenu.classList.add('active');
            }
          }
        }
        
        // ƒê√°nh d·∫•u c√°c menu items kh√°c
        markOtherMenuItems(currentPath);
      }
      
      // H√†m ƒë√°nh d·∫•u c√°c menu items kh√°c
      function markOtherMenuItems(currentPath) {
        // ƒê√°nh d·∫•u "Nh·∫≠t k√Ω chung"
        if (currentPath === '/' || currentPath.includes('/general-diary')) {
          const generalDiaryLink = document.querySelector('.sidebar a[href="/"]');
          if (generalDiaryLink) {
            generalDiaryLink.classList.add('active');
          }
        }
        
        // ƒê√°nh d·∫•u "ƒê∆°n h√†ng"
        if (currentPath.includes('/orders')) {
          const ordersLink = document.querySelector('.sidebar a[href="/orders"]');
          if (ordersLink) {
            ordersLink.classList.add('active');
          }
        }
        
        // ƒê√°nh d·∫•u "H√≥a ƒë∆°n"
        if (currentPath.includes('/invoices')) {
          const invoicesLink = document.querySelector('.sidebar a[href="/invoices"]');
          if (invoicesLink) {
            invoicesLink.classList.add('active');
          }
        }
        
        // ƒê√°nh d·∫•u "Kho h√†ng"
        if (currentPath.includes('/warehouse')) {
          const warehouseLink = document.querySelector('.sidebar a[href="/warehouse"]');
          if (warehouseLink) {
            warehouseLink.classList.add('active');
          }
        }
        
        // ƒê√°nh d·∫•u "B√°o c√°o"
        if (currentPath.includes('/reports')) {
          const reportsLink = document.querySelector('.sidebar a[href="/reports"]');
          if (reportsLink) {
            reportsLink.classList.add('active');
          }
        }
        
        // ƒê√°nh d·∫•u "Qu·∫£n l√Ω t√†i kho·∫£n"
        if (currentPath.includes('/account-management')) {
          const accountLink = document.querySelector('.sidebar a[href="/account-management"]');
          if (accountLink) {
            accountLink.classList.add('active');
          }
        }
      }
    </script>
    <script>
      // Global popup helpers and alert override
      (function(){
        const modal = document.getElementById('globalNotificationModal');
        const header = document.getElementById('globalNotificationHeader');
        const title = document.getElementById('globalNotificationTitle');
        const icon = document.getElementById('globalNotificationIcon');
        const msgEl = document.getElementById('globalNotificationMessage');
        const okBtn = document.getElementById('btnGlobalNotificationOK');
        let onCloseHandler = null;

        function setStyleByType(type){
          // type: success | error | info | warning
          let bg = '#1976d2', ic = 'fa-info-circle', icColor = '#1976d2', text = 'Th√¥ng b√°o';
          if (type === 'success'){ bg = '#28a745'; ic = 'fa-check-circle'; icColor = '#28a745'; text = 'Th√†nh c√¥ng'; }
          else if (type === 'error'){ bg = '#dc3545'; ic = 'fa-exclamation-triangle'; icColor = '#dc3545'; text = 'L·ªói'; }
          else if (type === 'warning'){ bg = '#ffc107'; ic = 'fa-exclamation-circle'; icColor = '#e0a800'; text = 'C·∫£nh b√°o'; }
          header.style.background = bg;
          title.textContent = text;
          icon.className = `fas ${ic}`;
          icon.style.color = icColor;
        }

        function openPopup(type, message, onClose){
          try{
            setStyleByType(type||'info');
            msgEl.textContent = (message==null? '': String(message));
            onCloseHandler = (typeof onClose === 'function') ? onClose : null;
            modal.style.display = 'flex';
          }catch(_){ /* noop */ }
        }

        function closePopup(){
          modal.style.display = 'none';
          if (onCloseHandler){ try{ onCloseHandler(); }catch(_){} }
          onCloseHandler = null;
        }

        if (okBtn){ okBtn.addEventListener('click', closePopup); }
        window.addEventListener('click', function(e){ if (e.target === modal) closePopup(); });

        // Expose globally
        window.showPopup = function(type, message, onClose){ openPopup(type, message, onClose); };
        window.showSuccessModal = function(message, onClose){ openPopup('success', message, onClose); };
        window.showErrorModal = function(message, onClose){ openPopup('error', message, onClose); };
        window.showInfoModal = function(message, onClose){ openPopup('info', message, onClose); };
        window.hideSuccessModal = closePopup; // backward compat
        window.hideErrorModal = closePopup;

        // Override native alert to popup
        if (!window.__alert_overridden__) {
          const nativeAlert = window.alert;
          window.alert = function(message){
            try{
              // ∆Øu ti√™n hi·ªÉn th·ªã l·ªói qua showErrorModal n·∫øu c√≥ ch·ªØ "l·ªói" trong n·ªôi dung
              const msg = (message==null? '': String(message));
              const lower = msg.toLowerCase();
              if (lower.includes('l·ªói') || lower.includes('error')) {
                if (window.showErrorModal) { showErrorModal(msg); return; }
              }
              openPopup('info', msg);
            } catch(_){ nativeAlert(message); }
          };
          window.__alert_overridden__ = true;
        }

        // Add confirm popup support (th·ªëng nh·∫•t, kh√¥ng fallback confirm native ƒë·ªÉ tr√°nh xung ƒë·ªôt)
        window.openPopup = function(type, message, onClose, onCancel) {
          if (type === 'confirm') {
            // Hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n b·∫±ng popup chu·∫©n
            setStyleByType('warning');
            title.textContent = 'X√°c nh·∫≠n';
            msgEl.textContent = (message==null? '': String(message));
            onCloseHandler = null;
            const footer = modal.querySelector('.modal-footer');
            const okBtnRef = document.getElementById('btnGlobalNotificationOK');
            // ·∫®n n√∫t OK m·∫∑c ƒë·ªãnh v√† ch√®n nh√≥m n√∫t x√°c nh·∫≠n
            if (okBtnRef) okBtnRef.style.display = 'none';
            let group = document.getElementById('__popupConfirmGroup');
            if (!group) {
              group = document.createElement('div');
              group.id = '__popupConfirmGroup';
              group.innerHTML = '<button id="__popupConfirmYes" style="background:#dc3545; color:#fff; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-size:14px;">ƒê·ªìng √Ω</button> <button id="__popupConfirmNo" style="background:#6c757d; color:#fff; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-size:14px;">H·ªßy</button>';
              footer.appendChild(group);
            }
            modal.style.display = 'flex';
            const yes = document.getElementById('__popupConfirmYes');
            const no = document.getElementById('__popupConfirmNo');
            const cleanup = ()=>{
              // X√≥a nh√≥m n√∫t x√°c nh·∫≠n v√† kh√¥i ph·ª•c n√∫t OK m·∫∑c ƒë·ªãnh
              const g = document.getElementById('__popupConfirmGroup');
              if (g && g.parentElement) g.parentElement.removeChild(g);
              if (okBtnRef) okBtnRef.style.display = '';
            };
            if (yes) yes.onclick = function(){ modal.style.display='none'; cleanup(); if (typeof onClose==='function') onClose(); };
            if (no) no.onclick = function(){ modal.style.display='none'; cleanup(); if (typeof onCancel==='function') onCancel(); };
          } else {
            openPopup(type, message, onClose);
          }
        };

        // Alias ti·ªán d·ª•ng cho confirm
        window.showConfirm = function(message, onYes, onNo){ window.openPopup('confirm', message, onYes, onNo); };
      })();
    </script>
    <script>
      // Normalize backend host for all fetch calls (localhost vs 127.0.0.1)
      (function(){
        if (!window.__fetch_patched__) {
          const originalFetch = window.fetch;
          function normalizeUrl(url){
            try{
              if (typeof url !== 'string') return url;
              const u = new URL(url, window.location.origin);
              if (u.hostname === 'localhost' || u.hostname === '127.0.0.1'){
                u.hostname = window.location.hostname;
                return u.toString();
              }
              return url;
            }catch(_){ return url; }
          }
          window.fetch = function(resource, init){
            try{
              if (typeof resource === 'string') {
                resource = normalizeUrl(resource);
              } else if (resource && typeof resource.url === 'string') {
                const n = normalizeUrl(resource.url);
                if (n !== resource.url) resource = new Request(n, resource);
              }
            }catch(_){ /* noop */ }
            return originalFetch.call(this, resource, init);
          };
          window.__fetch_patched__ = true;
        }
      })();
    </script>
</body>
</html> 