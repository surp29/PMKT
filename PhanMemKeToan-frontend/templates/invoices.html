{% extends "base.html" %}
{% block title %}Quản lý hóa đơn{% endblock %}
{% block content %}

<h2 class="page-title"><i class="fas fa-file-invoice"></i> Quản lý hóa đơn</h2>

<div class="tabs">
  <button class="tab active" data-status="all">Tất cả</button>
  <button class="tab" data-status="Đã thanh toán">Đã thanh toán</button>
  <button class="tab" data-status="Chưa thanh toán">Chưa thanh toán</button>
</div>

<div class="filter-bar">
  <div class="filter-item">
    <label> Từ ngày</label>
    <input type="date" class="date-input" id="from-date">
  </div>
  <div class="filter-item">
    <label>Đến ngày</label>
    <input type="date" class="date-input" id="to-date">
  </div>
  <div class="filter-item">
    <label>Số hóa đơn</label>
    <input type="text" id="invoice-number" placeholder="Nhập Mã HĐ">
  </div>
  <div class="filter-item">
    <label>Tên khách hàng</label>
    <input type="text" id="buyer-search" placeholder="Tên khách hàng">
  </div>
  <div class="filter-item">
    <label>Loại HĐ</label>
    <select id="loai-hd-filter">
      <option value="" disabled selected hidden>Tất cả</option>
      <option value="Sản phẩm">Sản phẩm</option>
      <option value="Hành động">Hành động</option>
    </select>
  </div>
</div>

<div class="filter-actions">
  <button class="search-btn btn-secondary" onclick="clearInvoiceFilters()"><i class="fas fa-sync"></i> Xóa bộ lọc</button>
  <button class="search-btn get-data-btn"><i class="fas fa-download"></i> Lấy dữ liệu hóa đơn</button>
  <script>
    // Event listeners cho tìm kiếm sẽ được gắn sau khi hàm searchInvoices được định nghĩa ở bên dưới
  </script>
  </div>

<div class="summary-bar" style="display:flex; align-items:center; justify-content:space-between;">
  <div class="summary-left" style="display:flex; align-items:center; gap:10px;">
    <button type="button" class="add-btn" onclick="openAddInvoiceModal()">
      <i class="fas fa-plus"></i> Thêm hóa đơn
    </button>
  </div>
  <div class="summary-right" style="margin-left:auto;">
    <span class="total-count" style="color:#000;">Tổng: {{ invoices|length }} hóa đơn</span>
  </div>
</div>



<!-- Modal tạo hóa đơn -->
<div id="add-invoice-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
    <h3>Tạo hóa đơn mới</h3>
    <span class="close">&times;</span>
    </div>
    
    <form id="invoice-form">
       <div class="form-row">
         <div class="form-group">
           <label>Số HĐ *</label>
           <input type="text" name="so_hd" id="auto-so-hd" readonly style="background-color: #f5f5f5;">
         </div>
         <div class="form-group">
           <label>Ngày HĐ *</label>
           <input type="date" name="ngay_hd" required>
         </div>
       </div>
      
       <div class="form-row">
         <div class="form-group">
           <label>Tên khách hàng *</label>
           <select name="tai_khoan_id" id="tai_khoan_select" onchange="handleTaiKhoanChange()" required>
             <option value="">Chọn tài khoản khách hàng</option>
             {% for account in accounts %}
             <option value="{{ account.id }}" data-ten-tk="{{ account.ten_tk }}">
               {{ account.ten_tk }}
             </option>
             {% endfor %}
             <option value="khac">Thêm khách hàng mới</option>
           </select>
           <div id="tai_khoan_moi_div" style="display: none; margin-top: 10px;">
             <input type="text" name="ten_tk_moi" id="ten_tk_moi" placeholder="Tên khách hàng mới" style="width: 100%;">
           </div>
           <input type="hidden" name="nguoi_mua" id="nguoi_mua_hidden">
         </div>
         <div class="form-group">
           <label>Tổng tiền *</label>
           <div style="display:flex;align-items:center;gap:6px;">
             <input type="text" id="invoice_tong_tien_display" inputmode="numeric" placeholder="0" style="flex:1;">
             <input type="hidden" name="tong_tien" id="invoice_tong_tien">
             <span>VNĐ</span>
           </div>
         </div>
       </div>
      
       <div class="form-row">
         <div class="form-group">
           <label>Loại SP *</label>
           <select name="loai_hd" required>
             <option value="">Chọn loại sản phẩm</option>
             <option value="Sản phẩm">Sản phẩm</option>
             <option value="Hành động">Hành động</option>
           </select>
         </div>
         <div class="form-group" style="position:relative;">
           <label>Tìm kiếm đơn hàng</label>
                      <!-- Dropdown đơn hàng (Hoàn thành) -->
           <select id="order-select" style="width:100%; height:38px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;" onchange="handleOrderSelectChange()">
             <option value="">Chọn đơn hàng</option>
             <!-- Orders will be loaded dynamically to avoid duplicates -->
             <option value="khac">Khác (nhập mã)</option>
           </select>
           <!-- Ô nhập thủ công (ẩn mặc định) -->
           <input type="text" id="order-search" placeholder="Nhập mã đơn hàng hoặc chọn từ danh sách..." style="width:100%; height:38px; margin-top:8px; display:none; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
           <div id="order-results" style="position:absolute; left:0; right:0; background:#fff; max-height: 260px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; display: none; z-index: 1001; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
         </div>
         <div class="form-group">
           <label>Trạng thái</label>
           <select name="trang_thai">
             <option value="Đã thanh toán">Đã thanh toán</option>
             <option value="Chưa thanh toán">Chưa thanh toán</option>
           </select>
         </div>
       </div>
      
       
      
       
      
      <input type="hidden" name="order_id" id="selected_order_id">
      <div class="form-actions">
        <button type="submit" class="save-btn">Tạo hóa đơn</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal xem chi tiết hóa đơn -->
<div id="view-invoice-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
    <h3>Chi tiết hóa đơn</h3>
    <span class="close" onclick="closeViewInvoiceModal()">&times;</span>
    </div>
    
    <form id="view-invoice-form">
      <input type="hidden" name="invoice_id" id="view_invoice_id">
      
      <div class="form-row">
        <div class="form-group">
          <label>Số HĐ *</label>
          <input type="text" name="so_hd" id="view_so_hd" required readonly>
        </div>
        <div class="form-group">
          <label>Ngày HĐ *</label>
          <input type="date" name="ngay_hd" id="view_ngay_hd" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Tên khách hàng *</label>
          <select name="tai_khoan_id" id="view_tai_khoan_select" onchange="handleViewTaiKhoanChange()" required disabled>
            <option value="">Chọn tài khoản khách hàng</option>
            {% for account in accounts %}
            <option value="{{ account.id }}" data-ten-tk="{{ account.ten_tk }}">
              {{ account.ten_tk }}
            </option>
            {% endfor %}
            <option value="khac">Thêm khách hàng mới</option>
          </select>
          <div id="view_tai_khoan_moi_div" style="display: none; margin-top: 10px;">
            <input type="text" name="ten_tk_moi" id="view_ten_tk_moi" placeholder="Tên khách hàng mới" style="width: 100%;" readonly>
          </div>
          <input type="hidden" name="nguoi_mua" id="view_nguoi_mua_hidden">
        </div>
        <div class="form-group">
          <label>Tổng tiền*</label>
          <div style="display:flex;align-items:center;gap:6px;">
            <input type="text" id="view_tong_tien_display" inputmode="numeric" placeholder="0" style="flex:1;" readonly>
            <input type="hidden" name="tong_tien" id="view_tong_tien">
            <span>VNĐ</span>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Loại Hóa Đơn *</label>
          <select name="loai_hd" id="view_loai_hd" required disabled>
            <option value="">Chọn loại hóa đơn</option>
            <option value="Sản phẩm">Sản phẩm</option>
            <option value="Hành động">Hành động</option>
          </select>
        </div>
        <div class="form-group">
          <label>Trạng thái</label>
          <select name="trang_thai" id="view_trang_thai">
            <option value="Đã thanh toán">Đã thanh toán</option>
            <option value="Chưa thanh toán">Chưa thanh toán</option>
          </select>
        </div>
      </div>
      
      
      
      
      
      <div class="form-actions" style="display:flex; gap:10px; justify-content:center; align-items:center;">
        <button type="button" id="btnUpdateInvoice" class="save-btn">Cập nhật</button>
        <button type="button" id="btnPrintInvoice" class="print-btn" style="background: #27ae60;">
          <i class="fas fa-print"></i> In
        </button>
        <button type="button" id="btnDeleteInvoice" class="btn-delete-invoice" style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Xóa</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal phê duyệt hóa đơn -->
<div id="approve-invoice-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Phê duyệt hóa đơn</h3>
    
    <div id="invoice-details">
      <!-- Chi tiết hóa đơn sẽ được load ở đây -->
    </div>
    
    <div class="approval-actions">
      <button onclick="approveInvoice()" class="approve-btn">
        <i class="fas fa-check"></i> Phê duyệt
      </button>
      <button onclick="rejectInvoice()" class="reject-btn">
        <i class="fas fa-times"></i> Từ chối
      </button>
      <button onclick="closeApproveModal()" class="cancel-btn">Hủy</button>
    </div>
  </div>
</div>

<!-- Modal xác nhận xóa hóa đơn -->
<div id="confirm-delete-invoice" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header" style="justify-content:center; background: linear-gradient(135deg, #dc3545, #e35d6a);">
      <h3 style="margin:0; color:white;">Xác nhận xóa</h3>
    </div>
    <div class="modal-body" style="padding:20px; text-align:center;">
      <p>Bạn có chắc chắn muốn xóa hóa đơn này?</p>
    </div>
    <div class="modal-footer" style="padding: 15px 20px; text-align:center; border-top:1px solid #eee;">
      <button onclick="deleteInvoice()" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">Xóa</button>
      <button onclick="closeDeleteInvoiceModal()" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Hủy</button>
    </div>
  </div>
</div>

<!-- Modal xác nhận thoát (khi dữ liệu thay đổi) -->
<div id="confirm-exit-invoice" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header" style="justify-content:center; background: linear-gradient(135deg, #007bff, #0056b3);">
      <h3 style="margin:0; color:white;">Xác nhận</h3>
    </div>
    <div class="modal-body" style="padding:20px; text-align:center;">
      <p>Bạn có chắc muốn thoát?</p>
    </div>
    <div class="modal-footer" style="padding: 15px 20px; text-align:center; border-top:1px solid #eee;">
      <button id="btnConfirmExitYes" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">Thoát</button>
      <button id="btnConfirmExitNo" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Ở lại</button>
    </div>
  </div>
</div>

<table class="product-table">
  <thead>
    <tr>
      <th style="text-align:center;">Số HĐ</th>
      <th style="text-align:center;">Ngày HĐ</th>
      <th style="text-align:center;">Tên khách hàng</th>
      <th style="text-align:center;">Tổng tiền</th>
      <th style="text-align:center;">Loại HĐ</th>
      <th style="text-align:center;">Trạng thái</th>
      <th style="text-align:center;">Hành động</th>
    </tr>
  </thead>
  <tbody>
    {% if invoices %}
      {% for invoice in invoices %}
      <tr data-status="{{ 'Đã thanh toán' if invoice.trang_thai == 'da_thanh_toan' else ('Chưa thanh toán' if invoice.trang_thai == 'chua_thanh_toan' else invoice.trang_thai or 'checking') }}" data-loai="{{ (invoice.loai_hd or '').strip() }}" data-index="{{ loop.index0 }}">
        <td style="text-align:center;">{{ invoice.so_hd or 'HĐ-0001' }}</td>
        <td style="text-align:center;">{{ invoice.ngay_hd }}</td>
        <td style="text-align:center;">{{ invoice.nguoi_mua }}</td>
        <td style="text-align:center;">{{ "{:,.0f}".format(invoice.tong_tien) if invoice.tong_tien else 0 }} VNĐ</td>
        <td style="text-align:center;">{{ invoice.loai_hd }}</td>
        <td style="text-align:center;">{{ 'Đã thanh toán' if invoice.trang_thai == 'da_thanh_toan' else ('Chưa thanh toán' if invoice.trang_thai == 'chua_thanh_toan' else invoice.trang_thai or 'checking') }}</td>
        <td style="text-align:center;">
          <button onclick="openViewInvoiceModal('{{ invoice.id }}')" style="background: #3498db; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
            <i class="fas fa-eye"></i> Xem
          </button>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="7" style="text-align:center;">Không có dữ liệu</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<div class="total-footer">Tổng: {{ invoices|length }} hóa đơn</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Remove active class from all tabs
      tabs.forEach(t => t.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      
      const status = this.getAttribute('data-status');
      filterInvoices(status);
    });
  });
  
  // Khôi phục giá trị filter từ URL khi tải trang
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('from_date')) {
    document.getElementById('from-date').value = urlParams.get('from_date');
  }
  if (urlParams.has('to_date')) {
    document.getElementById('to-date').value = urlParams.get('to_date');
  }
  if (urlParams.has('invoice_number')) {
    document.querySelector('input[placeholder="Tìm kiếm"]').value = urlParams.get('invoice_number');
  }
  if (urlParams.has('customer_info')) {
    const buyer = document.getElementById('buyer-search');
    if (buyer) buyer.value = urlParams.get('customer_info');
  }
  if (urlParams.has('loai_hd')) {
    const loaiSel = document.getElementById('loai-hd-filter');
    const v = urlParams.get('loai_hd');
    if (loaiSel && (v === 'Sản phẩm' || v === 'Hành động')) loaiSel.value = v;
  }
  
  // Thêm event listener cho date input
  // Đồng bộ như orders.html: dùng input type=date, không đổi sang text
});

// ===== Helpers: dựng URL backend và fetch an toàn (tự đồng bộ hostname, thử lại khi lỗi) =====
function buildBackendUrl(path){
  const base = `{{ BACKEND_URL }}`;
  try{
    const u = new URL(base);
    u.hostname = window.location.hostname; // đồng bộ localhost/127.0.0.1
    return new URL(path, u).toString();
  }catch(_){
    return (base || '').replace(/\/$/,'') + path;
  }
}

async function safeFetch(path, options){
  const url1 = buildBackendUrl(path);
  try{
    const r = await fetch(url1, options);
    return r;
  }catch(err){
    // Thử lại với hostname đảo chiều (localhost <-> 127.0.0.1)
    try{
      const base = `{{ BACKEND_URL }}`;
      const u = new URL(base);
      u.hostname = (window.location.hostname === '127.0.0.1') ? 'localhost' : '127.0.0.1';
      const url2 = new URL(path, u).toString();
      return await fetch(url2, options);
    }catch(_){
      throw err;
    }
  }
}

// Lọc theo trạng thái khi bấm các nút tab
function filterInvoices(status) {
  // Khi bấm tab, áp dụng toàn bộ bộ lọc
  applyAllFilters();
}

// Function to clear invoice filters
function clearInvoiceFilters() {
  // Reset tất cả các trường input về mặc định
  const filterInputs = document.querySelectorAll('.filter-bar input');
  filterInputs.forEach(input => {
    input.value = '';
  });
  
  // Reset date inputs về placeholder
  document.getElementById('from-date').placeholder = 'mm / dd / yyyy';
  document.getElementById('to-date').placeholder = 'mm / dd / yyyy';
  
  // Reset tabs về trạng thái "Tất cả"
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  document.querySelector('[data-status="all"]').classList.add('active');
  // Reset filter Loại HĐ về placeholder "Tất cả"
  const loaiSel = document.getElementById('loai-hd-filter');
  if (loaiSel) loaiSel.selectedIndex = 0;
  
  // Reset URL về trạng thái ban đầu (nếu có)
  if (window.history && window.history.pushState) {
    window.history.pushState({}, '', window.location.pathname);
  }
  
  // Áp dụng lại bộ lọc (tab = all, loại = rỗng)
  applyLoaiFilter();
}

// Function to format date input
function formatDateInput(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + ' / ' + value.slice(2);
  }
  if (value.length >= 7) {
    value = value.slice(0, 7) + ' / ' + value.slice(7);
  }
  if (value.length >= 12) {
    value = value.slice(0, 12);
  }
  input.value = value;
}

// Function to format date display
function formatDateDisplay(input) {
  if (input.value) {
    const date = new Date(input.value);
    if (!isNaN(date.getTime())) {
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      input.value = `${month} / ${day} / ${year}`;
    }
  }
}

// Hàm chuẩn hóa văn bản tiếng Việt để tìm kiếm
function normalizeVietnameseText(text) {
    if (!text) return "";
    
    // Mapping dấu tiếng Việt sang không dấu
    const vietnameseMap = {
        'à': 'a', 'á': 'a', 'ả': 'a', 'ã': 'a', 'ạ': 'a',
        'ă': 'a', 'ằ': 'a', 'ắ': 'a', 'ẳ': 'a', 'ẵ': 'a', 'ặ': 'a',
        'â': 'a', 'ầ': 'a', 'ấ': 'a', 'ẩ': 'a', 'ẫ': 'a', 'ậ': 'a',
        'è': 'e', 'é': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ẹ': 'e',
        'ê': 'e', 'ề': 'e', 'ế': 'e', 'ể': 'e', 'ễ': 'e', 'ệ': 'e',
        'ì': 'i', 'í': 'i', 'ỉ': 'i', 'ĩ': 'i', 'ị': 'i',
        'ò': 'o', 'ó': 'o', 'ỏ': 'o', 'õ': 'o', 'ọ': 'o',
        'ô': 'o', 'ồ': 'o', 'ố': 'o', 'ổ': 'o', 'ỗ': 'o', 'ộ': 'o',
        'ơ': 'o', 'ờ': 'o', 'ớ': 'o', 'ở': 'o', 'ỡ': 'o', 'ợ': 'o',
        'ù': 'u', 'ú': 'u', 'ủ': 'u', 'ũ': 'u', 'ụ': 'u',
        'ư': 'u', 'ừ': 'u', 'ứ': 'u', 'ử': 'u', 'ữ': 'u', 'ự': 'u',
        'ỳ': 'y', 'ý': 'y', 'ỷ': 'y', 'ỹ': 'y', 'ỵ': 'y',
        'đ': 'd',
        'À': 'A', 'Á': 'A', 'Ả': 'A', 'Ã': 'A', 'Ạ': 'A',
        'Ă': 'A', 'Ằ': 'A', 'Ắ': 'A', 'Ẳ': 'A', 'Ẵ': 'A', 'Ặ': 'A',
        'Â': 'A', 'Ầ': 'A', 'Ấ': 'A', 'Ẩ': 'A', 'Ẫ': 'A', 'Ậ': 'A',
        'È': 'E', 'É': 'E', 'Ẻ': 'E', 'Ẽ': 'E', 'Ẹ': 'E',
        'Ê': 'E', 'Ề': 'E', 'Ế': 'E', 'Ể': 'E', 'Ễ': 'E', 'Ệ': 'E',
        'Ì': 'I', 'Í': 'I', 'Ỉ': 'I', 'Ĩ': 'I', 'Ị': 'I',
        'Ò': 'O', 'Ó': 'O', 'Ỏ': 'O', 'Õ': 'O', 'Ọ': 'O',
        'Ô': 'O', 'Ồ': 'O', 'Ố': 'O', 'Ổ': 'O', 'Ỗ': 'O', 'Ộ': 'O',
        'Ơ': 'O', 'Ờ': 'O', 'Ớ': 'O', 'Ở': 'O', 'Ỡ': 'O', 'Ợ': 'O',
        'Ù': 'U', 'Ú': 'U', 'Ủ': 'U', 'Ũ': 'U', 'Ụ': 'U',
        'Ư': 'U', 'Ừ': 'U', 'Ứ': 'U', 'Ử': 'U', 'Ữ': 'U', 'Ự': 'U',
        'Ỳ': 'Y', 'Ý': 'Y', 'Ỷ': 'Y', 'Ỹ': 'Y', 'Ỵ': 'Y',
        'Đ': 'D'
    };
    
    // Thay thế dấu tiếng Việt
    let normalized = text;
    for (const [accented, plain] of Object.entries(vietnameseMap)) {
        normalized = normalized.replace(new RegExp(accented, 'g'), plain);
    }
    
    // Chuyển về chữ thường và loại bỏ khoảng trắng thừa
    normalized = normalized.toLowerCase().trim();
    
    return normalized;
}

// Hàm tìm kiếm linh hoạt - hỗ trợ tìm kiếm dính liền và tách rời
function flexibleSearch(searchText, targetText) {
    if (!searchText || !targetText) return false;
    
    // Chuẩn hóa cả hai văn bản
    const normalizedSearch = normalizeVietnameseText(searchText);
    const normalizedTarget = normalizeVietnameseText(targetText);
    
    // 1. Tìm kiếm trực tiếp (bao gồm cả dính liền)
    if (normalizedTarget.includes(normalizedSearch)) {
        return true;
    }
    
    // 2. Tìm kiếm khi tách từ (nếu searchText có thể tách thành nhiều từ)
    const searchWords = normalizedSearch.split(/\s+/).filter(word => word.length > 0);
    if (searchWords.length > 1) {
        // Nếu có nhiều từ, kiểm tra xem tất cả từ có xuất hiện trong target không
        return searchWords.every(word => normalizedTarget.includes(word));
    }
    
    // 3. Tìm kiếm khi ghép từ (nếu searchText có thể là từ ghép)
    if (normalizedSearch.length > 3) {
        // Thử tách thành các từ có thể có
        const possibleCombinations = generatePossibleCombinations(normalizedSearch);
        for (const combination of possibleCombinations) {
            if (normalizedTarget.includes(combination)) {
                return true;
            }
        }
    }
    
    // 4. Tìm kiếm fuzzy - kiểm tra độ tương tự
    if (calculateSimilarity(normalizedSearch, normalizedTarget) > 0.7) {
        return true;
    }
    
    return false;
}

// Hàm tạo các tổ hợp từ có thể có từ một chuỗi dính liền
function generatePossibleCombinations(text) {
    const combinations = [];
    
    // Thêm chính nó
    combinations.push(text);
    
    // Thêm các biến thể có thể có
    if (text.length > 4) {
        // Thử chèn khoảng trắng ở các vị trí khác nhau
        for (let i = 2; i < text.length - 1; i++) {
            const part1 = text.substring(0, i);
            const part2 = text.substring(i);
            combinations.push(part1 + ' ' + part2);
        }
    }
    
    // Thêm các biến thể thay thế ký tự tương tự
    const similarChars = {
        'd': ['d', 'đ'],
        'đ': ['d', 'đ'],
        'i': ['i', 'y'],
        'y': ['i', 'y'],
        'u': ['u', 'ư'],
        'ư': ['u', 'ư'],
        'o': ['o', 'ô', 'ơ'],
        'ô': ['o', 'ô', 'ơ'],
        'ơ': ['o', 'ô', 'ơ'],
        'a': ['a', 'ă', 'â'],
        'ă': ['a', 'ă', 'â'],
        'â': ['a', 'ă', 'â'],
        'e': ['e', 'ê'],
        'ê': ['e', 'ê']
    };
    
    // Tạo biến thể với các ký tự tương tự
    for (const [char, alternatives] of Object.entries(similarChars)) {
        if (text.includes(char)) {
            for (const alt of alternatives) {
                if (alt !== char) {
                    combinations.push(text.replace(new RegExp(char, 'g'), alt));
                }
            }
        }
    }
    
    return combinations;
}

// Hàm tính độ tương tự giữa hai chuỗi (Levenshtein distance)
function calculateSimilarity(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLength = Math.max(str1.length, str2.length);
    const similarity = 1 - (matrix[str2.length][str1.length] / maxLength);
    return similarity;
}

// Function to search invoices (flexible like products.html)
function searchInvoices() {
  // Lấy giá trị từ các filter
  const fromDate = document.getElementById('from-date').value;
  const toDate = document.getElementById('to-date').value;
  const invoiceNumber = normalizeVietnameseText((document.getElementById('invoice-number')?.value)||'');
  const customerInfo = normalizeVietnameseText((document.getElementById('buyer-search')?.value) || '');
  const loaiHd = (document.getElementById('loai-hd-filter')?.value) || '';
  
  // Tạo object chứa dữ liệu tìm kiếm
  const searchData = {};
  if (fromDate) searchData.fromDate = fromDate;
  if (toDate) searchData.toDate = toDate;
  if (invoiceNumber) searchData.invoiceNumber = invoiceNumber;
  if (customerInfo) searchData.customerInfo = customerInfo;
  if (loaiHd) searchData.loaiHd = loaiHd;
  
  if ((fromDate && !toDate) || (!fromDate && toDate)) {
    // Chưa đủ cặp ngày -> chưa tìm
    return;
  }
  
  if (fromDate && toDate) {
    const fromDateObj = new Date(fromDate);
    const toDateObj = new Date(toDate);
    if (fromDateObj > toDateObj) { return; }
  }
  
  // Cập nhật URL với các tham số tìm kiếm
  const queryParams = new URLSearchParams();
  if (searchData.fromDate) queryParams.set('from_date', searchData.fromDate);
  if (searchData.toDate) queryParams.set('to_date', searchData.toDate);
  if (searchData.invoiceNumber) queryParams.set('invoice_number', searchData.invoiceNumber);
  if (searchData.customerInfo) queryParams.set('customer_info', searchData.customerInfo);
  if (searchData.loaiHd) queryParams.set('loai_hd', searchData.loaiHd);
  const newUrl = window.location.pathname + (queryParams.toString()? ('?' + queryParams.toString()) : '');
  window.history.replaceState({}, '', newUrl);
  
  // Lọc trực tiếp trên bảng (client-side) để phản hồi nhanh
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 7) return;
    const soHd = normalizeVietnameseText(cells[0].textContent || '');
    const ngay = (cells[1].textContent || '').trim();
    const tenKh = normalizeVietnameseText(cells[2].textContent || '');
    const loai = (cells[4].textContent || '').trim();
    const status = (cells[5].textContent || '').trim();

    // Ngày: so sánh theo khoảng nếu có
    let match = true;
    if (fromDate) {
      try { if (new Date(ngay) < new Date(fromDate)) match = false; } catch(_){}
    }
    if (toDate && match) {
      try { if (new Date(ngay) > new Date(toDate)) match = false; } catch(_){}
    }

    // Số HĐ linh hoạt
    if (match && invoiceNumber) {
      match = flexibleSearch(invoiceNumber, soHd);
    }

    // Tên KH linh hoạt
    if (match && customerInfo) {
      match = flexibleSearch(customerInfo, tenKh);
    }

    // Loại HĐ
    if (match && loaiHd) {
      match = (loai === loaiHd);
    }

    row.style.display = match ? '' : 'none';
    if (match) visible++;
  });
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `Tổng: ${visible} hóa đơn`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `Tổng: ${visible} hóa đơn`;
}

// Gắn event listeners cho filter sau khi searchInvoices đã được định nghĩa
document.addEventListener('DOMContentLoaded', function(){
  function debounce(fn, delay){ let t; return function(){ clearTimeout(t); const a=arguments, c=this; t=setTimeout(()=>fn.apply(c,a), delay||300); } }
  const from = document.getElementById('from-date');
  const to = document.getElementById('to-date');
  const inv = document.getElementById('invoice-number');
  const cus = document.getElementById('buyer-search');
  const loaiHdSel = document.getElementById('loai-hd-filter');
  if (from) from.addEventListener('change', applyAllFilters);
  if (to) to.addEventListener('change', applyAllFilters);
  if (inv) inv.addEventListener('input', debounce(searchInvoices, 300));
  if (cus) cus.addEventListener('input', debounce(searchInvoices, 300));
  if (loaiHdSel) loaiHdSel.addEventListener('change', function(){
    applyLoaiFilter();
    // cập nhật URL param loai_hd
    const url = new URL(window.location);
    const v = this.value || '';
    if (v) url.searchParams.set('loai_hd', v); else url.searchParams.delete('loai_hd');
    window.history.replaceState({}, '', url);
  });
});

// Áp dụng filter theo trạng thái dựa trên tab
function applyStatusFilter(status){
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  if (status === 'all'){
    // Hiển thị tất cả, trở lại thứ tự ban đầu
    rows.sort((a,b)=> (parseInt(a.getAttribute('data-index')||'0',10) - parseInt(b.getAttribute('data-index')||'0',10)));
    rows.forEach(row=>{ row.style.display=''; visible++; });
  } else {
    // Hiển thị theo trạng thái và sắp xếp nhóm trạng thái được chọn lên trước
    const tbody = document.querySelector('.product-table tbody');
    const match = [], nonMatch = [];
    rows.forEach(row=>{
      const s = row.getAttribute('data-status') || '';
      if (s === status){ match.push(row); } else { nonMatch.push(row); }
    });
    // Ghép lại: trước là match (hiển thị), sau là nonMatch (ẩn)
    match.forEach(r=>{ r.style.display=''; tbody.appendChild(r); });
    nonMatch.forEach(r=>{ r.style.display='none'; tbody.appendChild(r); });
    visible = match.length;
  }
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `Tổng: ${visible} hóa đơn`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `Tổng: ${visible} hóa đơn`;
}

function updateTotalFooter(){
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  const visible = rows.filter(r=>r.style.display !== 'none').length || rows.length;
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `Tổng: ${visible} hóa đơn`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `Tổng: ${visible} hóa đơn`;
}

// Helper chuẩn hóa chuỗi để so sánh (bỏ khoảng trắng, không phân biệt hoa/thường)
function normalized(v){
  return (v || '').toString().normalize('NFC').trim().toLowerCase();
}

function getActiveStatus(){
  const active = document.querySelector('.tabs .tab.active');
  return active ? active.getAttribute('data-status') : 'all';
}

// Lọc theo Loại HĐ (select ở thanh filter)
function applyLoaiFilter(){
  const loai = normalized(document.getElementById('loai-hd-filter')?.value || '');
  const status = normalized(getActiveStatus());
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  rows.forEach(row=>{
    const rowLoai = normalized(row.getAttribute('data-loai') || '');
    const rowStatus = normalized(row.getAttribute('data-status') || '');
    const okLoai = (!loai) || (rowLoai === loai);
    const okStatus = (status === 'all') || (rowStatus === status);
    const show = okLoai && okStatus;
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `Tổng: ${visible} hóa đơn`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `Tổng: ${visible} hóa đơn`;
}

// Áp dụng tất cả filter: ngày, số HĐ, KH, loại, trạng thái
function applyAllFilters(){
  const status = getActiveStatus();
  // Bắt đầu từ hiển thị tất cả, sau đó gọi searchInvoices để lọc mềm
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  rows.forEach(r=> r.style.display='');
  searchInvoices();
}

// Tự động tăng số HĐ
let currentInvoiceNumber = 1;

function generateInvoiceNumber() {
  // Lấy số hóa đơn tiếp theo từ server
  safeFetch('/api/invoices/next-number')
    .then(response => response.json())
    .then(data => {
      if (data && typeof data.next_number === 'number' && data.next_number > 0) {
        currentInvoiceNumber = data.next_number;
      }
      const formattedNumber = `HĐ-${currentInvoiceNumber.toString().padStart(4, '0')}`;
      const el = document.getElementById('auto-so-hd');
      if (el) el.value = formattedNumber;
    })
    .catch(error => {
      console.error('Error getting next invoice number:', error);
      // Fallback: sử dụng số hiện tại
      const formattedNumber = `HĐ-${currentInvoiceNumber.toString().padStart(4, '0')}`;
      const el = document.getElementById('auto-so-hd');
      if (el) el.value = formattedNumber;
    });
}

// TÌM KIẾM MỚI: Tìm đơn hàng theo mã đơn hàng
async function searchOrdersForInvoice(query){
  const resultsDiv = document.getElementById('order-results');
  if (!resultsDiv) return;

  const q = (query || '').trim();
  if (!q){ 
    resultsDiv.style.display='none'; 
    resultsDiv.innerHTML=''; 
    return; 
  }

  console.log(`🔍 TÌM KIẾM MỚI: Tìm kiếm đơn hàng với mã: "${q}"`);

  try{
    // Lấy toàn bộ danh sách đơn hàng
    const r = await safeFetch('/api/orders/');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const list = await r.json();
    const all = Array.isArray(list) ? list : [];

    console.log(`📋 TÌM KIẾM MỚI: Nhận được ${all.length} đơn hàng từ API`);

    // Lọc: tất cả đơn hàng + khớp theo mã đơn hàng (không giới hạn trạng thái)
    const filtered = all.filter(o => {
      const code = (o.ma_don_hang || o.id || '').toString();
      const codeOk = code === q || code.includes(q) || q.includes(code);
      
      console.log(`🔍 TÌM KIẾM MỚI: Kiểm tra "${code}" vs "${q}" -> Trạng thái: "${o.trang_thai}", Code: ${codeOk}`);
      
      return codeOk;
    });

    console.log(`✅ TÌM KIẾM MỚI: Tìm thấy ${filtered.length} đơn hàng phù hợp`);

    if (!filtered.length){
      resultsDiv.innerHTML = '<div style="padding:8px;color:#666;">Không tìm thấy đơn hàng</div>';
      resultsDiv.style.display = 'block';
      console.log(`❌ TÌM KIẾM MỚI: Không tìm thấy đơn hàng nào với mã "${q}"`);
      return;
    }

    resultsDiv.innerHTML = '';
    filtered.forEach(o => {
      const div = document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #eee';
      div.style.cursor='pointer';
      const amt = (parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US');
      div.textContent = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${amt} VND) - ${o.trang_thai||'N/A'}`;
      div.onclick=function(){ selectOrderForInvoice(o); };
      resultsDiv.appendChild(div);
    });
    resultsDiv.style.display='block';
    
    console.log(`✅ TÌM KIẾM MỚI: Hiển thị ${filtered.length} đơn hàng`);
  } catch(err){
    console.error('❌ TÌM KIẾM MỚI: Lỗi tìm kiếm đơn hàng:', err);
    resultsDiv.innerHTML = '<div style="padding:8px;color:#666;">Lỗi tìm kiếm đơn hàng</div>';
    resultsDiv.style.display = 'block';
  }
}

async function selectOrderForInvoice(o){
  console.log('🎯 TỰ ĐỘNG ĐIỀN: Chọn đơn hàng:', o);
  
  const inp=document.getElementById('order-search');
  const hid=document.getElementById('selected_order_id');
  if (inp) inp.value = o.ma_don_hang||o.id;
  if (hid) hid.value = o.id;
  
  // TỰ ĐỘNG ĐIỀN TÊN KHÁCH HÀNG
  const customerSelect = document.getElementById('tai_khoan_select');
  if (customerSelect && o.thong_tin_kh) {
    console.log(`🎯 TỰ ĐỘNG ĐIỀN: Tìm khách hàng "${o.thong_tin_kh}" trong dropdown`);
    
    // Tìm option khách hàng phù hợp
    let found = false;
    for (let i = 0; i < customerSelect.options.length; i++) {
      const option = customerSelect.options[i];
      if (option.textContent.trim() === o.thong_tin_kh.trim()) {
        customerSelect.selectedIndex = i;
        console.log(`✅ TỰ ĐỘNG ĐIỀN: Đã chọn khách hàng "${o.thong_tin_kh}"`);
        found = true;
        break;
      }
    }
    
    if (!found) {
      console.log(`⚠️ TỰ ĐỘNG ĐIỀN: Không tìm thấy khách hàng "${o.thong_tin_kh}" trong dropdown`);
    }
  }
  
  // Điền tổng tiền
  const tong = document.querySelector('#invoice-form input[name="tong_tien"]');
  if (tong) tong.value = o.tong_tien || 0;
  setInvoiceTotalFromOrder(o.tong_tien || 0);
  
  // Điền loại sản phẩm
  const loai = document.querySelector('#invoice-form select[name="loai_hd"]');
  await preloadProducts();
  const key = o.sp_banggia || '';
  if (loai){ loai.value = productExists(key) ? 'Sản phẩm' : 'Hành động'; }
  
  // Ẩn kết quả tìm kiếm
  const resultsDiv = document.getElementById('order-results');
  if (resultsDiv){ resultsDiv.style.display='none'; resultsDiv.innerHTML=''; }
  
  console.log('✅ TỰ ĐỘNG ĐIỀN: Hoàn thành điền thông tin đơn hàng');
}

// Debounce function để tránh gọi API quá nhiều
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

document.addEventListener('DOMContentLoaded', function(){
  const os = document.getElementById('order-search');
  if (os){ 
    const debouncedSearch = debounce(function(query) {
      searchOrdersForInvoice(query);
    }, 300); // Chờ 300ms sau khi user ngừng gõ
    
    os.addEventListener('input', function(){ 
      debouncedSearch(this.value.trim()); 
    }); 
    // Cho phép nhấn Enter để tìm ngay
    os.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        const q = (this.value || '').trim();
        if (q) { searchOrdersForInvoice(q); }
      }
    });
  }
});

// ====== Preload danh sách sản phẩm để suy luận loại hóa đơn ======
let __productKeys = null; // Set các khóa: mã SP và tên SP (lowercase)
async function preloadProducts(){
  if (__productKeys) return __productKeys;
  try{
    const r = await safeFetch('/api/products/');
    const list = await r.json();
    const arr = Array.isArray(list) ? list : [];
    __productKeys = new Set();
    arr.forEach(p=>{
      const code = (p.ma_sp||'').toString().toLowerCase();
      const name = (p.ten_sp||'').toString().toLowerCase();
      if (code) __productKeys.add(code);
      if (name) __productKeys.add(name);
    });
  }catch(_){ __productKeys = new Set(); }
  return __productKeys;
}
function productExists(key){
  if (!key) return false;
  const s = (key||'').toString().toLowerCase();
  return !!(__productKeys && __productKeys.has(s));
}

// Nạp danh sách đơn hàng (Hoàn thành) vào dropdown
async function loadOrdersForSelect(){
  const sel = document.getElementById('order-select');
  if (!sel) return Promise.resolve();
  // Reset lại dropdown, chỉ giữ placeholder và option "Khác"
  sel.innerHTML = '<option value="">Chọn đơn hàng</option><option value="khac">Khác (nhập mã)</option>';
  const customerSelect = document.getElementById('tai_khoan_select');
  const customerId = customerSelect ? customerSelect.value : '';
  
  try{
    // Sử dụng API orders thông thường thay vì search API
    const r = await safeFetch('/api/orders/');
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    
    const list = await r.json();
    const orders = Array.isArray(list)? list:[];
    
    // Helper chuẩn hóa tiếng Việt (bỏ dấu, thường hóa)
    const normalize = (s)=> (s||'')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .trim();
    
    // Lọc chỉ lấy đơn hàng hoàn thành (linh hoạt theo nhiều biến thể)
    const completedOrders = orders.filter(o => {
      const st = normalize(o.trang_thai);
      return st === 'hoan thanh' || st === 'da hoan thanh' || st === 'completed' || st === 'done';
    });
    
    console.log(`📋 Nhận được ${orders.length} đơn hàng từ API`);
    console.log(`✅ Tìm thấy ${completedOrders.length} đơn hàng hoàn thành`);
    
    // BỘ LỌC MỚI: Lọc đơn hàng theo khách hàng được chọn
    let filteredOrders = completedOrders;
    const selectedCustomerOption = customerSelect ? customerSelect.options[customerSelect.selectedIndex] : null;
    const selectedCustomerName = selectedCustomerOption ? selectedCustomerOption.textContent.trim() : '';
    
    if (selectedCustomerName && selectedCustomerName !== 'Chọn tài khoản khách hàng') {
      console.log(`🎯 BỘ LỌC MỚI: Lọc cho khách hàng "${selectedCustomerName}"`);
      
      // Lọc chính xác: chỉ lấy đơn hàng có tên khách hàng khớp chính xác
      filteredOrders = completedOrders.filter(order => {
        const orderCustomerName = order.thong_tin_kh || '';
        const isMatch = orderCustomerName === selectedCustomerName;
        
        console.log(`🔍 So sánh: "${orderCustomerName}" === "${selectedCustomerName}" -> ${isMatch ? '✅ KHỚP' : '❌ KHÔNG KHỚP'}`);
        
        return isMatch;
      });
      
      console.log(`✅ BỘ LỌC MỚI: Tìm thấy ${filteredOrders.length} đơn hàng cho khách hàng "${selectedCustomerName}"`);
    } else {
      console.log(`✅ BỘ LỌC MỚI: Không có bộ lọc khách hàng, hiển thị tất cả ${completedOrders.length} đơn hàng`);
    }
    
    // Khử trùng lặp theo mã đơn hàng (ưu tiên đơn đầu tiên, chuẩn hóa code)
    const seen = new Set();
    const unique = [];
    const seenText = new Set(); // Thêm kiểm tra text hiển thị
    
    for (const o of filteredOrders){
      const code = (o.ma_don_hang || o.id || '').toString().trim().toLowerCase();
      const displayText = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${(parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US')} VND)`;
      
      // Kiểm tra cả mã và text hiển thị để tránh trùng lặp
      if (seen.has(code) || seenText.has(displayText)) {
        console.log(`🚫 Bỏ qua đơn hàng trùng lặp: ${displayText}`);
        continue;
      }
      
      seen.add(code);
      seenText.add(displayText);
      unique.push(o);
    }

    // Sắp xếp theo mã đơn hàng để dễ tìm
    unique.sort((a, b) => {
      const codeA = (a.ma_don_hang || a.id || '').toString().toLowerCase();
      const codeB = (b.ma_don_hang || b.id || '').toString().toLowerCase();
      return codeA.localeCompare(codeB);
    });

    unique.forEach(o=>{
      const op = document.createElement('option');
      op.value = o.id;
      const amt = (parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US');
      op.textContent = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${amt} VND)`;
      op.dataset.tong = o.tong_tien || 0;
      op.dataset.loai = o.loai_suy_luan || '';
      // Lưu mã SP/bảng giá (nếu API có), dùng để suy luận loại
      op.dataset.sp = o.sp_banggia || '';
      op.dataset.customer = o.thong_tin_kh || '';
      // Duy trì các data cũ để tương thích handler cũ
      op.setAttribute('data-customer', o.thong_tin_kh || '');
      op.setAttribute('data-amount', o.tong_tien || 0);
      op.setAttribute('data-order-id', o.id);
      op.setAttribute('data-customer-name', o.thong_tin_kh || '');
      sel.appendChild(op);
    });

    console.log(`✅ Đã nạp ${unique.length} đơn hàng duy nhất (từ ${completedOrders.length} đơn hàng hoàn thành)`);

    // Kiểm tra và sửa trùng lặp ngay lập tức
    setTimeout(() => {
      debugCheckDuplicates();
      // Thêm một lần kiểm tra nữa để đảm bảo
      setTimeout(() => debugCheckDuplicates(), 200);
    }, 100);

    // Sau khi nạp xong, áp dụng lại bộ lọc theo khách hàng hiện tại (nếu có)
    let currentCustomerName = '';
    if (customerId && customerId !== 'khac'){
      const selectedOption = customerSelect.options[customerSelect.selectedIndex];
      currentCustomerName = selectedOption ? (selectedOption.getAttribute('data-ten-tk') || '') : '';
    } else {
      const tenTkMoiInput = document.getElementById('ten_tk_moi');
      currentCustomerName = tenTkMoiInput ? (tenTkMoiInput.value || '') : '';
    }
    filterOrdersByCustomer(currentCustomerName);
  }catch(err){ 
    console.error('Load orders error:', err);
  }
}

// Xử lý thay đổi dropdown đơn hàng
(function(){
  const sel = document.getElementById('order-select');
  const searchInput = document.getElementById('order-search');
  if (!sel) return;
  sel.addEventListener('change', async function(){
    const val = this.value;
    if (val === 'khac'){
      // Hiển thị ô nhập để người dùng tự gõ tìm kiếm
      if (searchInput) searchInput.style.display='block';
      document.getElementById('selected_order_id').value = '';
      // Focus vào ô nhập và clear kết quả
      if (searchInput){
        searchInput.focus();
        const res = document.getElementById('order-results');
        if (res){ res.style.display='none'; res.innerHTML=''; }
      }
    } else if (val){
      if (searchInput) { searchInput.style.display='none'; searchInput.value=''; }
      document.getElementById('selected_order_id').value = val;
      // Điền tổng tiền + loại SP
      const tongVal = this.options[this.selectedIndex].dataset.tong || 0;
      const tong = document.querySelector('#invoice-form input[name="tong_tien"]');
      if (tong) tong.value = tongVal;
      // cập nhật ô hiển thị có dấu phẩy
      setInvoiceTotalFromOrder(tongVal);
      const loai = document.querySelector('#invoice-form select[name="loai_hd"]');
      // Suy luận loại theo sự tồn tại của sản phẩm trong danh sách products
      await preloadProducts();
      const spKey = this.options[this.selectedIndex].dataset.sp || '';
      if (loai){ loai.value = productExists(spKey) ? 'Sản phẩm' : 'Hành động'; }
    } else {
      if (searchInput) { searchInput.style.display='none'; searchInput.value=''; }
      document.getElementById('selected_order_id').value = '';
    }
  });
})();

// BỘ LỌC MỚI: Khi chọn khách hàng -> lọc đơn hàng
(function(){
  const customerSelect = document.getElementById('tai_khoan_select');
  const orderSelect = document.getElementById('order-select');
  if (customerSelect){
    customerSelect.addEventListener('change', function(){
      const selectedCustomer = customerSelect.options[customerSelect.selectedIndex];
      const customerName = selectedCustomer ? selectedCustomer.textContent.trim() : '';
      
      console.log('🔄 BỘ LỌC MỚI: Khách hàng được chọn:', customerName);
      
      if (orderSelect) orderSelect.selectedIndex = 0;
      
      // Load lại danh sách đơn hàng (đã có bộ lọc tích hợp)
      loadOrdersForSelect();
      
      // Mặc định ẩn ô nhập khi vừa đổi khách hàng
      const si = document.getElementById('order-search');
      if (si){ si.style.display='none'; si.value=''; }
    });
  }
})();

// Khởi tạo số HĐ khi mở modal
function openInvoiceModal() {
  generateInvoiceNumber();
  document.getElementById('add-invoice-modal').style.display = 'block';
}

// Khởi tạo khi trang load
document.addEventListener('DOMContentLoaded', function() {
  // Khởi tạo số HĐ đầu tiên
  generateInvoiceNumber();
  
  // Gắn lại sự kiện mở modal tạo hóa đơn cho nút trong thanh summary
  const addButton = document.querySelector('.add-btn');
  if (addButton) addButton.addEventListener('click', openAddInvoiceModal);
  
  // Tự động load danh sách đơn hàng khi trang được tải
  loadOrdersForSelect();
  
  // Thêm nút debug vào console (chỉ trong development)
  if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
    window.debugInvoices = {
      checkDuplicates: debugCheckDuplicates,
      removeDuplicates: removeDuplicateOptions,
      reloadOrders: loadOrdersForSelect,
      filterByCustomer: filterOrdersByCustomer,

      debugCustomerData: () => {
        console.log('🔍 Debug dữ liệu khách hàng:');
        const customerSelect = document.getElementById('tai_khoan_select');
        const orderSelect = document.getElementById('order-select');
        
        if (customerSelect) {
          console.log('📋 Danh sách khách hàng:');
          Array.from(customerSelect.options).forEach((opt, index) => {
            console.log(`  ${index}: "${opt.textContent}" (value: "${opt.value}")`);
          });
        }
        
        if (orderSelect) {
          console.log('📋 Danh sách đơn hàng:');
          Array.from(orderSelect.options).forEach((opt, index) => {
            const customer = opt.getAttribute('data-customer-name') || opt.dataset.customer || '';
            console.log(`  ${index}: "${opt.textContent}" (customer: "${customer}")`);
          });
        }
      },

      forceReloadAndFilter: (customerName) => {
        console.log(`🔄 BỘ LỌC MỚI: Force reload và lọc cho khách hàng: "${customerName}"`);
        loadOrdersForSelect();
      },
      debugOrdersData: async () => {
        console.log('🔍 Debug dữ liệu đơn hàng:');
        try {
          const r = await safeFetch('/api/orders/');
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const list = await r.json();
          const all = Array.isArray(list) ? list : [];
          
          console.log(`📋 Tổng số đơn hàng: ${all.length}`);
          
          all.forEach((order, index) => {
            console.log(`  ${index + 1}: Mã: "${order.ma_don_hang || order.id}", Khách hàng: "${order.thong_tin_kh}", Trạng thái: "${order.trang_thai}", Tổng tiền: ${order.tong_tien}`);
          });
          
          // Tìm đơn hàng có mã "950"
          const order950 = all.find(o => (o.ma_don_hang || o.id || '').toString() === '950');
          if (order950) {
            console.log(`✅ Tìm thấy đơn hàng 950:`, order950);
          } else {
            console.log(`❌ Không tìm thấy đơn hàng có mã "950"`);
          }
          
        } catch (err) {
          console.error('❌ Lỗi khi debug dữ liệu đơn hàng:', err);
        }
      },

      debugCustomerDropdown: () => {
        console.log('🔍 Debug dropdown khách hàng:');
        const customerSelect = document.getElementById('tai_khoan_select');
        if (customerSelect) {
          console.log('📋 Danh sách khách hàng trong dropdown:');
          Array.from(customerSelect.options).forEach((opt, index) => {
            console.log(`  ${index}: "${opt.textContent}" (value: "${opt.value}")`);
          });
        } else {
          console.log('❌ Không tìm thấy dropdown khách hàng');
        }
      },
      debugChangeState: () => {
        console.log('🔍 Debug trạng thái thay đổi:');
        console.log(`  - addChanged: ${addChanged}`);
        console.log(`  - addInitialState: ${addInitialState ? 'Có' : 'Không'}`);
        console.log(`  - viewChanged: ${viewChanged}`);
        console.log(`  - viewInitialState: ${viewInitialState ? 'Có' : 'Không'}`);
      },
      resetAllChangeStates: () => {
        console.log('🔄 Reset tất cả trạng thái thay đổi:');
        resetAddChangeState();
        resetViewChangeState();
      }
    };
    console.log('🔧 Debug functions available:');
    console.log('  - window.debugInvoices.checkDuplicates()');
    console.log('  - window.debugInvoices.removeDuplicates()');
    console.log('  - window.debugInvoices.reloadOrders()');
    console.log('  - window.debugInvoices.filterByCustomer("tên khách hàng")');

    console.log('  - window.debugInvoices.debugCustomerDropdown() (xem dropdown khách hàng)');
    console.log('  - window.debugInvoices.debugChangeState() (xem trạng thái thay đổi)');
    console.log('  - window.debugInvoices.resetAllChangeStates() (reset tất cả trạng thái)');
  }
  // Áp dụng phân quyền UI toàn cục ngay khi trang tải
  if (window.checkUserPermissions) { window.checkUserPermissions(); }
});


// Modal functions
function openAddInvoiceModal() {
  // Reset form trước khi hiển thị
  document.getElementById('invoice-form').reset();
  document.getElementById('tai_khoan_moi_div').style.display = 'none';
  generateInvoiceNumber();
  const m = document.getElementById('add-invoice-modal');
  if (m) m.style.display = 'flex';
  
  // Load lại danh sách đơn hàng (đã có bộ lọc tích hợp)
  loadOrdersForSelect();
  
  console.log('🔄 BỘ LỌC MỚI: Đã mở modal tạo hóa đơn và load lại danh sách đơn hàng');
}

function closeInvoiceModal() {
  document.getElementById('add-invoice-modal').style.display = 'none';
  // Reset form khi đóng modal
  document.getElementById('invoice-form').reset();
  document.getElementById('tai_khoan_moi_div').style.display = 'none';
}

// Mở modal xem chi tiết hóa đơn
function openViewInvoiceModal(invoiceId) {
  // Reset form trước khi điền dữ liệu mới
  document.getElementById('view-invoice-form').reset();
  document.getElementById('view_tai_khoan_moi_div').style.display = 'none';
  document.getElementById('view_nguoi_mua_hidden').value = '';
  
  // Lấy thông tin hóa đơn từ server
  safeFetch(`/api/invoices/${invoiceId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        if (window.showErrorModal) { showErrorModal('Lỗi: ' + (data.error || 'Không thể tải thông tin hóa đơn')); } else { alert('Lỗi: ' + (data.error || 'Không thể tải thông tin hóa đơn')); }
        return;
      }
      
      // Điền thông tin vào form
      document.getElementById('view_invoice_id').value = data.id;
      document.getElementById('view_so_hd').value = data.so_hd || '';
      document.getElementById('view_ngay_hd').value = data.ngay_hd || '';
      
      // Xử lý thông tin người mua
      if (data.nguoi_mua) {
        // Tìm tài khoản phù hợp trong dropdown
        const select = document.getElementById('view_tai_khoan_select');
        let found = false;
        
        for (let i = 0; i < select.options.length; i++) {
          const option = select.options[i];
          const optionText = option.text;
          if (optionText === data.nguoi_mua) {
            select.value = option.value;
            found = true;
            break;
          }
        }
        
        // Nếu không tìm thấy, chọn "Khác" và điền thông tin
        if (!found) {
          select.value = 'khac';
          document.getElementById('view_ten_tk_moi').value = data.nguoi_mua;
          document.getElementById('view_tai_khoan_moi_div').style.display = 'block';
        }
        
        // Cập nhật hidden input
        document.getElementById('view_nguoi_mua_hidden').value = data.nguoi_mua;
      }
      
      // Tổng tiền hiển thị dạng có dấu phẩy
      const vt = document.getElementById('view_tong_tien');
      const vtd = document.getElementById('view_tong_tien_display');
      if (vt){ vt.value = data.tong_tien || ''; }
      if (vtd){ vtd.value = (parseInt(data.tong_tien||0,10)||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
      document.getElementById('view_loai_hd').value = data.loai_hd || '';
      document.getElementById('view_trang_thai').value = data.trang_thai || 'Đã thanh toán';
      
      document.getElementById('view-invoice-modal').style.display = 'block';
      // Bật theo dõi thay đổi để điều khiển nút Cập nhật
      bindViewChangeWatcher();
      // Áp dụng phân quyền UI toàn cục (đã định nghĩa ở base.html)
      if (window.applyPermissionsToUI) { window.applyPermissionsToUI(); }
    })
    .catch(error => {
      console.error('Error:', error);
      if (window.showErrorModal) { showErrorModal('Lỗi khi tải thông tin hóa đơn!'); } else { alert('Lỗi khi tải thông tin hóa đơn!'); }
    });
}

// Đóng modal xem chi tiết hóa đơn
function closeViewInvoiceModal() {
  document.getElementById('view-invoice-modal').style.display = 'none';
  // Reset form khi đóng modal
  document.getElementById('view-invoice-form').reset();
  document.getElementById('view_tai_khoan_moi_div').style.display = 'none';
}

// Cập nhật hóa đơn
function updateInvoice() {
  const form = document.getElementById('view-invoice-form');
  const fd = new FormData(form);

  const id = (fd.get('invoice_id') || '').toString().trim();
  if (!id) { if (window.showErrorModal) { showErrorModal('Thiếu mã hóa đơn.'); } else { alert('Thiếu mã hóa đơn.'); } return; }

  // Xác định người mua cuối cùng
  let nguoiMuaFinal = fd.get('nguoi_mua') || '';
  const viewSelect = document.getElementById('view_tai_khoan_select');
  if (viewSelect && viewSelect.value === 'khac') {
    const tenMoi = (document.getElementById('view_ten_tk_moi')?.value || '').trim();
    if (!tenMoi) { if (window.showErrorModal) { showErrorModal('Vui lòng nhập tên khách hàng mới!'); } else { alert('Vui lòng nhập tên khách hàng mới!'); } return; }
    nguoiMuaFinal = tenMoi;
  }

  const payload = {
    so_hd: fd.get('so_hd'),
    ngay_hd: fd.get('ngay_hd'),
    nguoi_mua: nguoiMuaFinal,
    tong_tien: parseFloat(fd.get('tong_tien') || '0'),
    loai_hd: fd.get('loai_hd'),
    trang_thai: fd.get('trang_thai')
  };

  safeFetch(`/api/invoices/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
      if (data && (data.success || data.id)) {
        // RESET TRẠNG THÁI THAY ĐỔI SAU KHI CẬP NHẬT THÀNH CÔNG
        viewChanged = false;
        viewInitialState = null;
        
        if (window.showSuccessModal) { showSuccessModal('Cập nhật hóa đơn thành công!', function(){ location.reload(); }); } else { alert('Cập nhật hóa đơn thành công!'); }
        closeViewInvoiceModal();
        location.reload();
      } else {
        if (window.showErrorModal) { showErrorModal('Lỗi: ' + (data.error || 'Không thể cập nhật hóa đơn')); } else { alert('Lỗi: ' + (data.error || 'Không thể cập nhật hóa đơn')); }
      }
    })
  .catch(error => {
    console.error('Error:', error);
    if (window.showErrorModal) { showErrorModal('Lỗi khi cập nhật hóa đơn!'); } else { alert('Lỗi khi cập nhật hóa đơn!'); }
  });
}

// In hóa đơn
function printInvoice(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return;
  const data = {
    so_hd: f.so_hd.value,
    ngay_hd: f.ngay_hd.value,
    nguoi_mua: f.nguoi_mua.value,
    tong_tien: f.tong_tien.value,
    loai_hd: f.loai_hd.value,
    trang_thai: f.trang_thai.value,
  };
  const tongStr = (parseInt(data.tong_tien||0,10)||0).toLocaleString('vi-VN');
  const win = window.open('', '_blank');
  const html = `<!doctype html><html lang="vi"><head><meta charset="utf-8"><title>In hóa đơn</title>
    <style>
      body{ font-family: Arial, Helvetica, sans-serif; }
      .sheet{ width: 794px; margin:0 auto; }
      .title{ text-align:center; font-weight:bold; font-size:18px; margin:10px 0; }
      table{ width:100%; border-collapse:collapse; }
      td,th{ border:1px dotted #000; padding:6px; font-size:13px; }
      .no-border td{ border:none; }
    </style>
  </head><body onload="window.print(); setTimeout(()=>window.close(), 300);">
  <div class="sheet">
    <div style="display:flex; justify-content:space-between;">
      <div>
        <div><strong>CÔNG TY TNHH MTV TM-DV TIN HỌC PHAN HUYỀN</strong></div>
        <div>Số 188/49 Tân Kỳ Tân Quý, P.Sơn Kỳ, Q.Tân Phú, TP.HCM</div>
      </div>
      <div style="text-align:right;">Ngày ${data.ngay_hd || ''}</div>
    </div>
    <div class="title">HÓA ĐƠN BÁN LẺ</div>
    <div style="margin-bottom:8px;">Số HĐ: ${data.so_hd || ''}</div>
    <table class="no-border">
      <tr class="no-border"><td style="width:100px; border:none;">Khách hàng :</td><td style="border:none;">${data.nguoi_mua || ''}</td></tr>
      <tr class="no-border"><td style="border:none;">Địa chỉ :</td><td style="border:none;">............................................................</td></tr>
    </table>
    <table>
      <tr><th>STT</th><th>Tên Sản Phẩm</th><th>ĐVT</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>
      <tr style="height:260px;"><td colspan="6">&nbsp;</td></tr>
      <tr><td colspan="5" style="text-align:right; font-weight:bold;">Cộng</td><td style="text-align:right; font-weight:bold;">${tongStr}</td></tr>
    </table>
    <div style="margin-top:10px;">Bằng chữ: ...............................................................</div>
    <div style="margin-top:10px;">Hình thức thanh toán: .................................................</div>
    <table class="no-border" style="margin-top:40px; text-align:center;">
      <tr class="no-border"><td style="border:none;">Khách hàng</td><td style="border:none;">Nhân viên</td></tr>
    </table>
  </div>
  </body></html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
}

function openApproveModal(invoiceId) {
  // Load invoice details for approval
  document.getElementById('approve-invoice-modal').style.display = 'block';
  // In real implementation, fetch invoice details by ID
}

function closeApproveModal() {
  document.getElementById('approve-invoice-modal').style.display = 'none';
}

function approveInvoice() {
  // Implement invoice approval logic
  if (window.showSuccessModal) { showSuccessModal('Hóa đơn đã được phê duyệt!'); } else { alert('Hóa đơn đã được phê duyệt!'); }
  closeApproveModal();
}

function rejectInvoice() {
  // Implement invoice rejection logic
  if (window.showErrorModal) { showErrorModal('Hóa đơn đã bị từ chối!'); } else { alert('Hóa đơn đã bị từ chối!'); }
  closeApproveModal();
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
  const invoiceModal = document.getElementById('add-invoice-modal');
  const viewInvoiceModal = document.getElementById('view-invoice-modal');
  const approveModal = document.getElementById('approve-invoice-modal');
  const confirmDeleteModal = document.getElementById('confirm-delete-invoice');
  if (event.target === invoiceModal) {
    closeInvoiceModal();
  }
  if (event.target === viewInvoiceModal) {
    closeViewInvoiceModal();
  }
  if (event.target === approveModal) {
    closeApproveModal();
  }
  if (event.target === confirmDeleteModal) {
    closeDeleteInvoiceModal();
  }
});

// Close modals when clicking X
document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
    if (this.closest('#add-invoice-modal')) {
      closeInvoiceModal();
    } else if (this.closest('#view-invoice-modal')) {
      closeViewInvoiceModal();
    } else if (this.closest('#approve-invoice-modal')) {
      closeApproveModal();
    } else if (this.closest('#confirm-delete-invoice')) {
      closeDeleteInvoiceModal();
    }
  }
});

// Xử lý thay đổi tài khoản trong modal tạo hóa đơn
function handleTaiKhoanChange() {
  const select = document.getElementById('tai_khoan_select');
  const moiDiv = document.getElementById('tai_khoan_moi_div');
  const hiddenInput = document.getElementById('nguoi_mua_hidden');
  
  if (select.value === 'khac') {
    moiDiv.style.display = 'block';
    hiddenInput.value = '';
    // Khi chọn "Khác", hiển thị tất cả đơn hàng hoàn thành
    filterOrdersByCustomer('');
    
    // Thêm event listener cho input tên khách hàng mới
    const tenTkMoiInput = document.getElementById('ten_tk_moi');
    if (tenTkMoiInput) {
      tenTkMoiInput.addEventListener('input', function() {
        const customerName = this.value.trim();
        filterOrdersByCustomer(customerName);
      });
    }
  } else if (select.value) {
    moiDiv.style.display = 'none';
    const selectedOption = select.options[select.selectedIndex];
    const tenTk = selectedOption.getAttribute('data-ten-tk');
    hiddenInput.value = `${tenTk}`;
    // Khi chọn khách hàng cụ thể, lọc đơn hàng theo khách hàng đó
    filterOrdersByCustomer(tenTk);
    // Cập nhật lại dropdown đơn hàng
    loadOrdersForSelect();
  } else {
    moiDiv.style.display = 'none';
    hiddenInput.value = '';
    // Khi không chọn gì, hiển thị tất cả đơn hàng hoàn thành
    filterOrdersByCustomer('');
    // Cập nhật lại dropdown đơn hàng
    loadOrdersForSelect();
  }
}

// Xử lý thay đổi tài khoản trong modal xem chi tiết
function handleViewTaiKhoanChange() {
  const select = document.getElementById('view_tai_khoan_select');
  const moiDiv = document.getElementById('view_tai_khoan_moi_div');
  const hiddenInput = document.getElementById('view_nguoi_mua_hidden');
  
  if (select.value === 'khac') {
    moiDiv.style.display = 'block';
    hiddenInput.value = '';
  } else if (select.value) {
    moiDiv.style.display = 'none';
    const selectedOption = select.options[select.selectedIndex];
    const tenTk = selectedOption.getAttribute('data-ten-tk');
    hiddenInput.value = `${tenTk}`;
  } else {
    moiDiv.style.display = 'none';
    hiddenInput.value = '';
  }
}

// Định dạng tiền: thêm dấu ',' khi nhập và đồng bộ hidden
function formatMoneyTypingInvoice(displayEl, hiddenEl){
  const raw = (displayEl.value || '').replace(/[^0-9]/g, '');
  if (!raw){ displayEl.value=''; if(hiddenEl) hiddenEl.value=''; return; }
  if (hiddenEl) hiddenEl.value = raw;
  displayEl.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

(function(){
  const d = document.getElementById('invoice_tong_tien_display');
  const h = document.getElementById('invoice_tong_tien');
  if (d && h){
    const sanitize = ()=>{ d.value = d.value.replace(/[^0-9,]/g,''); };
    d.addEventListener('input', sanitize);
    d.addEventListener('blur', sanitize);
  }
  const vd = document.getElementById('view_tong_tien_display');
  const vh = document.getElementById('view_tong_tien');
  if (vd && vh){
    vd.addEventListener('input', function(){ formatMoneyTypingInvoice(vd,vh); });
    vd.addEventListener('blur', function(){ formatMoneyTypingInvoice(vd,vh); });
  }
})();

// Khi chọn đơn hàng từ dropdown hoặc gợi ý -> set tổng tiền có dấu phẩy
function setInvoiceTotalFromOrder(amount){
  const d = document.getElementById('invoice_tong_tien_display');
  const h = document.getElementById('invoice_tong_tien');
  if (d && h){
    const raw = String(parseInt(amount||0,10));
    h.value = raw;
    d.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
}

// Handle form submissions (create invoice)
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('invoice-form');
  if (!form) return;
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(form);
    const taiKhoanId = fd.get('tai_khoan_id');
    let nguoiMuaFinal = fd.get('nguoi_mua') || '';
    if (taiKhoanId === 'khac') {
      const tenMoi = (fd.get('ten_tk_moi') || '').trim();
      if (!tenMoi) { if (window.showErrorModal) { showErrorModal('Vui lòng nhập tên khách hàng mới!'); } else { alert('Vui lòng nhập tên khách hàng mới!'); } return; }
      nguoiMuaFinal = tenMoi;
    }
    const payload = {
      so_hd: document.getElementById('auto-so-hd').value,
      ngay_hd: fd.get('ngay_hd'),
      nguoi_mua: nguoiMuaFinal,
      tong_tien: parseFloat(fd.get('tong_tien') || '0'),
      loai_hd: fd.get('loai_hd'),
      trang_thai: fd.get('trang_thai') || 'checking',
      order_id: parseInt(fd.get('order_id') || '0') || null
    };
    if (!payload.so_hd || !payload.ngay_hd || !payload.nguoi_mua || !payload.tong_tien || !payload.loai_hd) {
    if (window.showErrorModal) { showErrorModal('Vui lòng điền đầy đủ thông tin bắt buộc!'); } else { alert('Vui lòng điền đầy đủ thông tin bắt buộc!'); }
    return;
  }
    safeFetch('/api/invoices/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
      .then(r=>r.json())
      .then(data=>{
        if (data && (data.success || data.id)) {
          // RESET TRẠNG THÁI THAY ĐỔI SAU KHI TẠO THÀNH CÔNG
          addChanged = false;
          addInitialState = null;
          
          if (window.showSuccessModal) { showSuccessModal('Tạo hóa đơn thành công!', function(){ location.reload(); }); }
          closeInvoiceModal();
          currentInvoiceNumber++;
          location.reload();
        } else {
          if (window.showErrorModal) { showErrorModal('Có lỗi xảy ra khi tạo hóa đơn'); } else { alert('Có lỗi xảy ra khi tạo hóa đơn'); }
        }
      })
      .catch(()=> { if (window.showErrorModal) { showErrorModal('Có lỗi xảy ra khi tạo hóa đơn'); } else { alert('Có lỗi xảy ra khi tạo hóa đơn'); } });
    });
    
    // Áp dụng phân quyền cho trang invoices
    if (window.checkUserPermissions) {
      window.checkUserPermissions();
    }
});

function deleteInvoice() {
  const id = document.getElementById('view_invoice_id').value;
  if (!id) { closeDeleteInvoiceModal(); return; }
  safeFetch(`/api/invoices/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data && data.success) {
        closeDeleteInvoiceModal();
        closeViewInvoiceModal();
        if (window.showSuccessModal) { showSuccessModal('Xóa hóa đơn thành công!', function(){ location.reload(); }); } else { location.reload(); }
      } else {
        if (window.showErrorModal) { showErrorModal('Không thể xóa hóa đơn'); } else { alert('Không thể xóa hóa đơn'); }
      }
    })
    .catch(() => { if (window.showErrorModal) { showErrorModal('Lỗi khi xóa hóa đơn'); } else { alert('Lỗi khi xóa hóa đơn'); } });
}

// Hiển thị/đóng popup xác nhận xóa hóa đơn
function confirmDeleteInvoice(){
  const modal = document.getElementById('confirm-delete-invoice');
  if (modal) modal.style.display = 'flex';
}
function closeDeleteInvoiceModal(){
  const modal = document.getElementById('confirm-delete-invoice');
  if (modal) modal.style.display = 'none';
}

let viewInitialState = null;
let viewChanged = false;
function getViewState(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return '';
  const data = {
    so_hd: f.so_hd.value,
    ngay_hd: f.ngay_hd.value,
    nguoi_mua: f.nguoi_mua.value,
    tong_tien: f.tong_tien.value,
    loai_hd: f.loai_hd.value,
    trang_thai: f.trang_thai.value,
  };
  return JSON.stringify(data);
}
function bindViewChangeWatcher(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return;
  const btn = f.parentElement.querySelector('.save-btn');
  viewChanged = false;
  
  const check = ()=>{
    const currentState = getViewState();
    const hasChanged = currentState !== viewInitialState;
    viewChanged = hasChanged;
    if (btn) btn.disabled = !hasChanged;
    console.log('🔄 Trạng thái thay đổi (view):', hasChanged ? 'CÓ THAY ĐỔI' : 'KHÔNG THAY ĐỔI');
  };
  
  f.querySelectorAll('input,select,textarea').forEach(el=>{ 
    el.addEventListener('input', check); 
    el.addEventListener('change', check); 
  });
  
  // set initial
  viewInitialState = getViewState();
  if (btn) btn.disabled = true;
  console.log('🔄 Đã khởi tạo trạng thái ban đầu cho modal xem hóa đơn');
}

// Gắn sự kiện cho các nút trong popup xem hóa đơn
 (function(){
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'btnUpdateInvoice'){ updateInvoice(); }
    if (e.target && e.target.id === 'btnPrintInvoice'){ printInvoice(); }
    if (e.target && e.target.id === 'btnDeleteInvoice'){ confirmDeleteInvoice(); }
  });
})();

// ===================== Cảnh báo khi thoát nếu dữ liệu thay đổi =====================
let addInitialState = null;
let addChanged = false;
function getAddState(){
  const f = document.getElementById('invoice-form');
  if (!f) return '';
  const data = {
    so_hd: f.so_hd?.value || document.getElementById('auto-so-hd')?.value || '',
    ngay_hd: f.ngay_hd?.value || '',
    nguoi_mua: document.getElementById('nguoi_mua_hidden')?.value || '',
    tong_tien: f.tong_tien?.value || document.getElementById('invoice_tong_tien')?.value || '',
    loai_hd: f.loai_hd?.value || '',
    trang_thai: f.trang_thai?.value || ''
  };
  return JSON.stringify(data);
}

function bindAddChangeWatcher(){
  const f = document.getElementById('invoice-form');
  if (!f) return;
  addChanged = false;
  
  const update = ()=>{
    const currentState = getAddState();
    const hasChanged = currentState !== addInitialState;
    addChanged = hasChanged;
    console.log('🔄 Trạng thái thay đổi:', hasChanged ? 'CÓ THAY ĐỔI' : 'KHÔNG THAY ĐỔI');
  };
  
  f.querySelectorAll('input,select,textarea').forEach(el=>{ 
    el.addEventListener('input', update); 
    el.addEventListener('change', update); 
  });
  
  addInitialState = getAddState();
  console.log('🔄 Đã khởi tạo trạng thái ban đầu cho modal tạo hóa đơn');
}

// Wrap openAddInvoiceModal to capture initial state
const __openAddInvoiceModal = openAddInvoiceModal;
openAddInvoiceModal = function(){
  __openAddInvoiceModal();
  bindAddChangeWatcher();
};

// Hàm reset trạng thái thay đổi
function resetAddChangeState() {
  addChanged = false;
  addInitialState = null;
  console.log('🔄 Đã reset trạng thái thay đổi cho modal tạo hóa đơn');
}

function resetViewChangeState() {
  viewChanged = false;
  viewInitialState = null;
  console.log('🔄 Đã reset trạng thái thay đổi cho modal xem hóa đơn');
}

function openConfirmExit(cb){
  const m = document.getElementById('confirm-exit-invoice');
  if (!m) return cb && cb();
  m.style.display = 'flex';
  const yes = document.getElementById('btnConfirmExitYes');
  const no = document.getElementById('btnConfirmExitNo');
  const cleanup = ()=>{ m.style.display='none'; yes.onclick=null; no.onclick=null; };
  yes.onclick = ()=>{ cleanup(); if (cb) cb(); };
  no.onclick = ()=>{ cleanup(); };
}

const __closeInvoiceModal = closeInvoiceModal;
closeInvoiceModal = function(){
  const f = document.getElementById('invoice-form');
  if (f && addChanged === true){
    return openConfirmExit(()=>{ 
      resetAddChangeState(); 
      __closeInvoiceModal(); 
    });
  }
  resetAddChangeState();
  __closeInvoiceModal();
};

// Click outside add modal
window.addEventListener('click', function(e){
  const m = document.getElementById('add-invoice-modal');
  if (e.target === m){
    const f = document.getElementById('invoice-form');
    if (f && addChanged === true){
      openConfirmExit(()=>{ addInitialState=null; __closeInvoiceModal(); });
    } else {
      __closeInvoiceModal();
    }
  }
});

// BỘ LỌC MỚI: Lọc đơn hàng theo khách hàng được chọn
function filterOrdersByCustomer(customerName) {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  console.log(`🎯 BỘ LỌC MỚI: Bắt đầu lọc cho khách hàng "${customerName}"`);
  
  const allOptions = orderSelect.querySelectorAll('option');
  
  // Reset về trạng thái ban đầu - hiển thị tất cả đơn hàng
  allOptions.forEach(option => {
    if (option.value && option.value !== 'khac') {
      option.style.display = '';
    }
  });
  
  // Nếu có chọn khách hàng cụ thể, chỉ hiển thị đơn hàng của khách hàng đó
  if (customerName && customerName.trim() !== '' && customerName !== 'Chọn tài khoản khách hàng') {
    let shown = 0;
    let hidden = 0;
    
    allOptions.forEach(option => {
      if (option.value && option.value !== 'khac') {
        const optionCustomer = option.getAttribute('data-customer-name') || option.dataset.customer || '';
        
        // SO SÁNH CHÍNH XÁC: chỉ hiển thị nếu tên khách hàng khớp hoàn toàn
        const isMatch = optionCustomer === customerName;
        
        if (isMatch) {
          shown++;
          console.log(`✅ Hiển thị: "${option.textContent}" (khách hàng: "${optionCustomer}")`);
        } else {
          option.style.display = 'none';
          hidden++;
          console.log(`❌ Ẩn: "${option.textContent}" (khách hàng: "${optionCustomer}")`);
        }
      }
    });
    
    console.log(`📊 BỘ LỌC MỚI: ${shown} hiển thị, ${hidden} ẩn`);
    
    // Nếu không tìm thấy đơn hàng nào, hiển thị tất cả
    if (shown === 0) {
      console.log(`⚠️ BỘ LỌC MỚI: Không tìm thấy đơn hàng cho "${customerName}", hiển thị tất cả`);
      allOptions.forEach(option => {
        if (option.value && option.value !== 'khac') {
          option.style.display = '';
        }
      });
    }
  } else {
    console.log(`✅ BỘ LỌC MỚI: Hiển thị tất cả đơn hàng (không có bộ lọc)`);
  }
  
  // Reset selection
  orderSelect.value = '';
  
  console.log(`✅ BỘ LỌC MỚI: Hoàn thành lọc cho khách hàng "${customerName}"`);
}

// Xử lý khi chọn đơn hàng từ dropdown
function handleOrderSelectChange() {
  const orderSelect = document.getElementById('order-select');
  const selectedOption = orderSelect.options[orderSelect.selectedIndex];
  
  console.log('Order selected:', orderSelect.value);
  console.log('Selected option:', selectedOption);
  
  if (orderSelect.value === 'khac') {
    // Hiển thị ô nhập thủ công
    document.getElementById('order-search').style.display = 'block';
    document.getElementById('order-results').style.display = 'none';
    
    // Reset các trường khác
    document.getElementById('nguoi_mua_hidden').value = '';
    document.getElementById('invoice_tong_tien').value = '';
    document.getElementById('selected_order_id').value = '';
    
    // Reset customer name và total amount
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = '';
    if (totalInput) totalInput.value = '';
    
  } else if (orderSelect.value) {
    console.log('🎯 TỰ ĐỘNG ĐIỀN: Chọn đơn hàng từ dropdown:', orderSelect.value);
    
    // Ẩn ô nhập thủ công
    document.getElementById('order-search').style.display = 'none';
    document.getElementById('order-results').style.display = 'none';
    
    // Lấy thông tin từ option được chọn
    const customer = selectedOption.getAttribute('data-customer');
    const amount = selectedOption.getAttribute('data-amount');
    const orderId = selectedOption.getAttribute('data-order-id');
    
    console.log(`🎯 TỰ ĐỘNG ĐIỀN: Thông tin đơn hàng - Khách hàng: "${customer}", Tổng tiền: ${amount}`);
    
    // TỰ ĐỘNG ĐIỀN TÊN KHÁCH HÀNG VÀO DROPDOWN
    const customerSelect = document.getElementById('tai_khoan_select');
    if (customerSelect && customer) {
      console.log(`🎯 TỰ ĐỘNG ĐIỀN: Tìm khách hàng "${customer}" trong dropdown khách hàng`);
      
      // Tìm option khách hàng phù hợp
      let found = false;
      for (let i = 0; i < customerSelect.options.length; i++) {
        const option = customerSelect.options[i];
        if (option.textContent.trim() === customer.trim()) {
          customerSelect.selectedIndex = i;
          console.log(`✅ TỰ ĐỘNG ĐIỀN: Đã chọn khách hàng "${customer}" trong dropdown`);
          found = true;
          break;
        }
      }
      
      if (!found) {
        console.log(`⚠️ TỰ ĐỘNG ĐIỀN: Không tìm thấy khách hàng "${customer}" trong dropdown`);
      }
    }
    
    // Điền thông tin vào form
    document.getElementById('nguoi_mua_hidden').value = customer;
    document.getElementById('invoice_tong_tien').value = amount;
    document.getElementById('selected_order_id').value = orderId;
    
    // Điền customer name và total amount
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = customer;
    if (totalInput) totalInput.value = amount;
    
    // Cập nhật trạng thái form để theo dõi thay đổi
    if (typeof addChanged !== 'undefined') {
      addChanged = true;
    }
    
    console.log('✅ TỰ ĐỘNG ĐIỀN: Hoàn thành điền thông tin từ dropdown');
  } else {
    // Không chọn gì - ẩn ô nhập thủ công
    document.getElementById('order-search').style.display = 'none';
    document.getElementById('order-results').style.display = 'none';
    
    // Reset các trường
    document.getElementById('nguoi_mua_hidden').value = '';
    document.getElementById('invoice_tong_tien').value = '';
    document.getElementById('selected_order_id').value = '';
    
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = '';
    if (totalInput) totalInput.value = '';
  }
}

// Hàm debug để kiểm tra đơn hàng trùng lặp
function debugCheckDuplicates() {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  const options = Array.from(orderSelect.options);
  const codes = options.map(opt => opt.value).filter(v => v && v !== 'khac');
  const duplicates = codes.filter((code, index) => codes.indexOf(code) !== index);
  
  if (duplicates.length > 0) {
    console.warn('⚠️ Phát hiện đơn hàng trùng lặp:', duplicates);
    // Tự động xóa trùng lặp
    removeDuplicateOptions();
  } else {
    console.log('✅ Không có đơn hàng trùng lặp');
  }
  
  console.log(`📊 Tổng số options: ${options.length}, Số đơn hàng: ${codes.length}`);
}

// Hàm xóa các option trùng lặp khỏi dropdown
function removeDuplicateOptions() {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  const options = Array.from(orderSelect.options);
  const seen = new Set();
  const toRemove = [];
  
  options.forEach((option, index) => {
    if (option.value && option.value !== 'khac') {
      if (seen.has(option.value)) {
        toRemove.push(index);
        console.log(`🗑️ Sẽ xóa option trùng lặp: ${option.textContent}`);
      } else {
        seen.add(option.value);
      }
    }
  });
  
  // Xóa từ cuối lên để không ảnh hưởng đến index
  toRemove.reverse().forEach(index => {
    orderSelect.remove(index);
  });
  
  if (toRemove.length > 0) {
    console.log(`✅ Đã xóa ${toRemove.length} option trùng lặp`);
  }
}

// For view modal (edit): reuse viewInitialState/getViewState
const __closeViewInvoiceModal = closeViewInvoiceModal;
closeViewInvoiceModal = function(){
  const f = document.getElementById('view-invoice-form');
  if (f && viewChanged === true){
    return openConfirmExit(()=>{ 
      resetViewChangeState(); 
      __closeViewInvoiceModal(); 
    });
  }
  resetViewChangeState();
  __closeViewInvoiceModal();
};

window.addEventListener('click', function(e){
  const m = document.getElementById('view-invoice-modal');
  if (e.target === m){
    const f = document.getElementById('view-invoice-form');
    if (f && viewChanged === true){
      openConfirmExit(()=>{ viewInitialState=null; __closeViewInvoiceModal(); });
    } else {
      __closeViewInvoiceModal();
    }
  }
});

</script>
{% endblock %}