{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω h√≥a ƒë∆°n{% endblock %}
{% block content %}

<h2 class="page-title"><i class="fas fa-file-invoice"></i> Qu·∫£n l√Ω h√≥a ƒë∆°n</h2>

<div class="tabs">
  <button class="tab active" data-status="all">T·∫•t c·∫£</button>
  <button class="tab" data-status="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</button>
  <button class="tab" data-status="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</button>
</div>

<div class="filter-bar">
  <div class="filter-item">
    <label> T·ª´ ng√†y</label>
    <input type="date" class="date-input" id="from-date">
  </div>
  <div class="filter-item">
    <label>ƒê·∫øn ng√†y</label>
    <input type="date" class="date-input" id="to-date">
  </div>
  <div class="filter-item">
    <label>S·ªë h√≥a ƒë∆°n</label>
    <input type="text" id="invoice-number" placeholder="Nh·∫≠p M√£ Hƒê">
  </div>
  <div class="filter-item">
    <label>T√™n kh√°ch h√†ng</label>
    <input type="text" id="buyer-search" placeholder="T√™n kh√°ch h√†ng">
  </div>
  <div class="filter-item">
    <label>Lo·∫°i Hƒê</label>
    <select id="loai-hd-filter">
      <option value="" disabled selected hidden>T·∫•t c·∫£</option>
      <option value="S·∫£n ph·∫©m">S·∫£n ph·∫©m</option>
      <option value="H√†nh ƒë·ªông">H√†nh ƒë·ªông</option>
    </select>
  </div>
</div>

<div class="filter-actions">
  <button class="search-btn btn-secondary" onclick="clearInvoiceFilters()"><i class="fas fa-sync"></i> X√≥a b·ªô l·ªçc</button>
  <button class="search-btn get-data-btn"><i class="fas fa-download"></i> L·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n</button>
  <script>
    // Event listeners cho t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c g·∫Øn sau khi h√†m searchInvoices ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü b√™n d∆∞·ªõi
  </script>
  </div>

<div class="summary-bar" style="display:flex; align-items:center; justify-content:space-between;">
  <div class="summary-left" style="display:flex; align-items:center; gap:10px;">
    <button type="button" class="add-btn" onclick="openAddInvoiceModal()">
      <i class="fas fa-plus"></i> Th√™m h√≥a ƒë∆°n
    </button>
  </div>
  <div class="summary-right" style="margin-left:auto;">
    <span class="total-count" style="color:#000;">T·ªïng: {{ invoices|length }} h√≥a ƒë∆°n</span>
  </div>
</div>



<!-- Modal t·∫°o h√≥a ƒë∆°n -->
<div id="add-invoice-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
    <h3>T·∫°o h√≥a ƒë∆°n m·ªõi</h3>
    <span class="close">&times;</span>
    </div>
    
    <form id="invoice-form">
       <div class="form-row">
         <div class="form-group">
           <label>S·ªë Hƒê *</label>
           <input type="text" name="so_hd" id="auto-so-hd" readonly style="background-color: #f5f5f5;">
         </div>
         <div class="form-group">
           <label>Ng√†y Hƒê *</label>
           <input type="date" name="ngay_hd" required>
         </div>
       </div>
      
       <div class="form-row">
         <div class="form-group">
           <label>T√™n kh√°ch h√†ng *</label>
           <select name="tai_khoan_id" id="tai_khoan_select" onchange="handleTaiKhoanChange()" required>
             <option value="">Ch·ªçn t√†i kho·∫£n kh√°ch h√†ng</option>
             {% for account in accounts %}
             <option value="{{ account.id }}" data-ten-tk="{{ account.ten_tk }}">
               {{ account.ten_tk }}
             </option>
             {% endfor %}
             <option value="khac">Th√™m kh√°ch h√†ng m·ªõi</option>
           </select>
           <div id="tai_khoan_moi_div" style="display: none; margin-top: 10px;">
             <input type="text" name="ten_tk_moi" id="ten_tk_moi" placeholder="T√™n kh√°ch h√†ng m·ªõi" style="width: 100%;">
           </div>
           <input type="hidden" name="nguoi_mua" id="nguoi_mua_hidden">
         </div>
         <div class="form-group">
           <label>T·ªïng ti·ªÅn *</label>
           <div style="display:flex;align-items:center;gap:6px;">
             <input type="text" id="invoice_tong_tien_display" inputmode="numeric" placeholder="0" style="flex:1;">
             <input type="hidden" name="tong_tien" id="invoice_tong_tien">
             <span>VNƒê</span>
           </div>
         </div>
       </div>
      
       <div class="form-row">
         <div class="form-group">
           <label>Lo·∫°i SP *</label>
           <select name="loai_hd" required>
             <option value="">Ch·ªçn lo·∫°i s·∫£n ph·∫©m</option>
             <option value="S·∫£n ph·∫©m">S·∫£n ph·∫©m</option>
             <option value="H√†nh ƒë·ªông">H√†nh ƒë·ªông</option>
           </select>
         </div>
         <div class="form-group" style="position:relative;">
           <label>T√¨m ki·∫øm ƒë∆°n h√†ng</label>
                      <!-- Dropdown ƒë∆°n h√†ng (Ho√†n th√†nh) -->
           <select id="order-select" style="width:100%; height:38px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;" onchange="handleOrderSelectChange()">
             <option value="">Ch·ªçn ƒë∆°n h√†ng</option>
             <!-- Orders will be loaded dynamically to avoid duplicates -->
             <option value="khac">Kh√°c (nh·∫≠p m√£)</option>
           </select>
           <!-- √î nh·∫≠p th·ªß c√¥ng (·∫©n m·∫∑c ƒë·ªãnh) -->
           <input type="text" id="order-search" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng ho·∫∑c ch·ªçn t·ª´ danh s√°ch..." style="width:100%; height:38px; margin-top:8px; display:none; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
           <div id="order-results" style="position:absolute; left:0; right:0; background:#fff; max-height: 260px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; display: none; z-index: 1001; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
         </div>
         <div class="form-group">
           <label>Tr·∫°ng th√°i</label>
           <select name="trang_thai">
             <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
             <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
           </select>
         </div>
       </div>
      
       
      
       
      
      <input type="hidden" name="order_id" id="selected_order_id">
      <div class="form-actions">
        <button type="submit" class="save-btn">T·∫°o h√≥a ƒë∆°n</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal xem chi ti·∫øt h√≥a ƒë∆°n -->
<div id="view-invoice-modal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
    <h3>Chi ti·∫øt h√≥a ƒë∆°n</h3>
    <span class="close" onclick="closeViewInvoiceModal()">&times;</span>
    </div>
    
    <form id="view-invoice-form">
      <input type="hidden" name="invoice_id" id="view_invoice_id">
      
      <div class="form-row">
        <div class="form-group">
          <label>S·ªë Hƒê *</label>
          <input type="text" name="so_hd" id="view_so_hd" required readonly>
        </div>
        <div class="form-group">
          <label>Ng√†y Hƒê *</label>
          <input type="date" name="ngay_hd" id="view_ngay_hd" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>T√™n kh√°ch h√†ng *</label>
          <select name="tai_khoan_id" id="view_tai_khoan_select" onchange="handleViewTaiKhoanChange()" required disabled>
            <option value="">Ch·ªçn t√†i kho·∫£n kh√°ch h√†ng</option>
            {% for account in accounts %}
            <option value="{{ account.id }}" data-ten-tk="{{ account.ten_tk }}">
              {{ account.ten_tk }}
            </option>
            {% endfor %}
            <option value="khac">Th√™m kh√°ch h√†ng m·ªõi</option>
          </select>
          <div id="view_tai_khoan_moi_div" style="display: none; margin-top: 10px;">
            <input type="text" name="ten_tk_moi" id="view_ten_tk_moi" placeholder="T√™n kh√°ch h√†ng m·ªõi" style="width: 100%;" readonly>
          </div>
          <input type="hidden" name="nguoi_mua" id="view_nguoi_mua_hidden">
        </div>
        <div class="form-group">
          <label>T·ªïng ti·ªÅn*</label>
          <div style="display:flex;align-items:center;gap:6px;">
            <input type="text" id="view_tong_tien_display" inputmode="numeric" placeholder="0" style="flex:1;" readonly>
            <input type="hidden" name="tong_tien" id="view_tong_tien">
            <span>VNƒê</span>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Lo·∫°i H√≥a ƒê∆°n *</label>
          <select name="loai_hd" id="view_loai_hd" required disabled>
            <option value="">Ch·ªçn lo·∫°i h√≥a ƒë∆°n</option>
            <option value="S·∫£n ph·∫©m">S·∫£n ph·∫©m</option>
            <option value="H√†nh ƒë·ªông">H√†nh ƒë·ªông</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tr·∫°ng th√°i</label>
          <select name="trang_thai" id="view_trang_thai">
            <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
            <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
          </select>
        </div>
      </div>
      
      
      
      
      
      <div class="form-actions" style="display:flex; gap:10px; justify-content:center; align-items:center;">
        <button type="button" id="btnUpdateInvoice" class="save-btn">C·∫≠p nh·∫≠t</button>
        <button type="button" id="btnPrintInvoice" class="print-btn" style="background: #27ae60;">
          <i class="fas fa-print"></i> In
        </button>
        <button type="button" id="btnDeleteInvoice" class="btn-delete-invoice" style="background:#dc3545; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">X√≥a</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal ph√™ duy·ªát h√≥a ƒë∆°n -->
<div id="approve-invoice-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Ph√™ duy·ªát h√≥a ƒë∆°n</h3>
    
    <div id="invoice-details">
      <!-- Chi ti·∫øt h√≥a ƒë∆°n s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
    </div>
    
    <div class="approval-actions">
      <button onclick="approveInvoice()" class="approve-btn">
        <i class="fas fa-check"></i> Ph√™ duy·ªát
      </button>
      <button onclick="rejectInvoice()" class="reject-btn">
        <i class="fas fa-times"></i> T·ª´ ch·ªëi
      </button>
      <button onclick="closeApproveModal()" class="cancel-btn">H·ªßy</button>
    </div>
  </div>
</div>

<!-- Modal x√°c nh·∫≠n x√≥a h√≥a ƒë∆°n -->
<div id="confirm-delete-invoice" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header" style="justify-content:center; background: linear-gradient(135deg, #dc3545, #e35d6a);">
      <h3 style="margin:0; color:white;">X√°c nh·∫≠n x√≥a</h3>
    </div>
    <div class="modal-body" style="padding:20px; text-align:center;">
      <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y?</p>
    </div>
    <div class="modal-footer" style="padding: 15px 20px; text-align:center; border-top:1px solid #eee;">
      <button onclick="deleteInvoice()" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">X√≥a</button>
      <button onclick="closeDeleteInvoiceModal()" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">H·ªßy</button>
    </div>
  </div>
</div>

<!-- Modal x√°c nh·∫≠n tho√°t (khi d·ªØ li·ªáu thay ƒë·ªïi) -->
<div id="confirm-exit-invoice" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header" style="justify-content:center; background: linear-gradient(135deg, #007bff, #0056b3);">
      <h3 style="margin:0; color:white;">X√°c nh·∫≠n</h3>
    </div>
    <div class="modal-body" style="padding:20px; text-align:center;">
      <p>B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?</p>
    </div>
    <div class="modal-footer" style="padding: 15px 20px; text-align:center; border-top:1px solid #eee;">
      <button id="btnConfirmExitYes" style="background:#dc3545; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">Tho√°t</button>
      <button id="btnConfirmExitNo" style="background:#6c757d; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">·ªû l·∫°i</button>
    </div>
  </div>
</div>

<table class="product-table">
  <thead>
    <tr>
      <th style="text-align:center;">S·ªë Hƒê</th>
      <th style="text-align:center;">Ng√†y Hƒê</th>
      <th style="text-align:center;">T√™n kh√°ch h√†ng</th>
      <th style="text-align:center;">T·ªïng ti·ªÅn</th>
      <th style="text-align:center;">Lo·∫°i Hƒê</th>
      <th style="text-align:center;">Tr·∫°ng th√°i</th>
      <th style="text-align:center;">H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody>
    {% if invoices %}
      {% for invoice in invoices %}
      <tr data-status="{{ 'ƒê√£ thanh to√°n' if invoice.trang_thai == 'da_thanh_toan' else ('Ch∆∞a thanh to√°n' if invoice.trang_thai == 'chua_thanh_toan' else invoice.trang_thai or 'checking') }}" data-loai="{{ (invoice.loai_hd or '').strip() }}" data-index="{{ loop.index0 }}">
        <td style="text-align:center;">{{ invoice.so_hd or 'Hƒê-0001' }}</td>
        <td style="text-align:center;">{{ invoice.ngay_hd }}</td>
        <td style="text-align:center;">{{ invoice.nguoi_mua }}</td>
        <td style="text-align:center;">{{ "{:,.0f}".format(invoice.tong_tien) if invoice.tong_tien else 0 }} VNƒê</td>
        <td style="text-align:center;">{{ invoice.loai_hd }}</td>
        <td style="text-align:center;">{{ 'ƒê√£ thanh to√°n' if invoice.trang_thai == 'da_thanh_toan' else ('Ch∆∞a thanh to√°n' if invoice.trang_thai == 'chua_thanh_toan' else invoice.trang_thai or 'checking') }}</td>
        <td style="text-align:center;">
          <button onclick="openViewInvoiceModal('{{ invoice.id }}')" style="background: #3498db; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
            <i class="fas fa-eye"></i> Xem
          </button>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="7" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<div class="total-footer">T·ªïng: {{ invoices|length }} h√≥a ƒë∆°n</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.tab');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Remove active class from all tabs
      tabs.forEach(t => t.classList.remove('active'));
      
      // Add active class to clicked tab
      this.classList.add('active');
      
      const status = this.getAttribute('data-status');
      filterInvoices(status);
    });
  });
  
  // Kh√¥i ph·ª•c gi√° tr·ªã filter t·ª´ URL khi t·∫£i trang
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('from_date')) {
    document.getElementById('from-date').value = urlParams.get('from_date');
  }
  if (urlParams.has('to_date')) {
    document.getElementById('to-date').value = urlParams.get('to_date');
  }
  if (urlParams.has('invoice_number')) {
    document.querySelector('input[placeholder="T√¨m ki·∫øm"]').value = urlParams.get('invoice_number');
  }
  if (urlParams.has('customer_info')) {
    const buyer = document.getElementById('buyer-search');
    if (buyer) buyer.value = urlParams.get('customer_info');
  }
  if (urlParams.has('loai_hd')) {
    const loaiSel = document.getElementById('loai-hd-filter');
    const v = urlParams.get('loai_hd');
    if (loaiSel && (v === 'S·∫£n ph·∫©m' || v === 'H√†nh ƒë·ªông')) loaiSel.value = v;
  }
  
  // Th√™m event listener cho date input
  // ƒê·ªìng b·ªô nh∆∞ orders.html: d√πng input type=date, kh√¥ng ƒë·ªïi sang text
});

// ===== Helpers: d·ª±ng URL backend v√† fetch an to√†n (t·ª± ƒë·ªìng b·ªô hostname, th·ª≠ l·∫°i khi l·ªói) =====
function buildBackendUrl(path){
  const base = `{{ BACKEND_URL }}`;
  try{
    const u = new URL(base);
    u.hostname = window.location.hostname; // ƒë·ªìng b·ªô localhost/127.0.0.1
    return new URL(path, u).toString();
  }catch(_){
    return (base || '').replace(/\/$/,'') + path;
  }
}

async function safeFetch(path, options){
  const url1 = buildBackendUrl(path);
  try{
    const r = await fetch(url1, options);
    return r;
  }catch(err){
    // Th·ª≠ l·∫°i v·ªõi hostname ƒë·∫£o chi·ªÅu (localhost <-> 127.0.0.1)
    try{
      const base = `{{ BACKEND_URL }}`;
      const u = new URL(base);
      u.hostname = (window.location.hostname === '127.0.0.1') ? 'localhost' : '127.0.0.1';
      const url2 = new URL(path, u).toString();
      return await fetch(url2, options);
    }catch(_){
      throw err;
    }
  }
}

// L·ªçc theo tr·∫°ng th√°i khi b·∫•m c√°c n√∫t tab
function filterInvoices(status) {
  // Khi b·∫•m tab, √°p d·ª•ng to√†n b·ªô b·ªô l·ªçc
  applyAllFilters();
}

// Function to clear invoice filters
function clearInvoiceFilters() {
  // Reset t·∫•t c·∫£ c√°c tr∆∞·ªùng input v·ªÅ m·∫∑c ƒë·ªãnh
  const filterInputs = document.querySelectorAll('.filter-bar input');
  filterInputs.forEach(input => {
    input.value = '';
  });
  
  // Reset date inputs v·ªÅ placeholder
  document.getElementById('from-date').placeholder = 'mm / dd / yyyy';
  document.getElementById('to-date').placeholder = 'mm / dd / yyyy';
  
  // Reset tabs v·ªÅ tr·∫°ng th√°i "T·∫•t c·∫£"
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  document.querySelector('[data-status="all"]').classList.add('active');
  // Reset filter Lo·∫°i Hƒê v·ªÅ placeholder "T·∫•t c·∫£"
  const loaiSel = document.getElementById('loai-hd-filter');
  if (loaiSel) loaiSel.selectedIndex = 0;
  
  // Reset URL v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu (n·∫øu c√≥)
  if (window.history && window.history.pushState) {
    window.history.pushState({}, '', window.location.pathname);
  }
  
  // √Åp d·ª•ng l·∫°i b·ªô l·ªçc (tab = all, lo·∫°i = r·ªóng)
  applyLoaiFilter();
}

// Function to format date input
function formatDateInput(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + ' / ' + value.slice(2);
  }
  if (value.length >= 7) {
    value = value.slice(0, 7) + ' / ' + value.slice(7);
  }
  if (value.length >= 12) {
    value = value.slice(0, 12);
  }
  input.value = value;
}

// Function to format date display
function formatDateDisplay(input) {
  if (input.value) {
    const date = new Date(input.value);
    if (!isNaN(date.getTime())) {
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      input.value = `${month} / ${day} / ${year}`;
    }
  }
}

// H√†m chu·∫©n h√≥a vƒÉn b·∫£n ti·∫øng Vi·ªát ƒë·ªÉ t√¨m ki·∫øm
function normalizeVietnameseText(text) {
    if (!text) return "";
    
    // Mapping d·∫•u ti·∫øng Vi·ªát sang kh√¥ng d·∫•u
    const vietnameseMap = {
        '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
        'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
        '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
        '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
        '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
        '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
        '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
        '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
        '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
        '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
        '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
        '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
        'ƒë': 'd',
        '√Ä': 'A', '√Å': 'A', '·∫¢': 'A', '√É': 'A', '·∫†': 'A',
        'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫≤': 'A', '·∫¥': 'A', '·∫∂': 'A',
        '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫®': 'A', '·∫™': 'A', '·∫¨': 'A',
        '√à': 'E', '√â': 'E', '·∫∫': 'E', '·∫º': 'E', '·∫∏': 'E',
        '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÇ': 'E', '·ªÑ': 'E', '·ªÜ': 'E',
        '√å': 'I', '√ç': 'I', '·ªà': 'I', 'ƒ®': 'I', '·ªä': 'I',
        '√í': 'O', '√ì': 'O', '·ªé': 'O', '√ï': 'O', '·ªå': 'O',
        '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªî': 'O', '·ªñ': 'O', '·ªò': 'O',
        '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ªû': 'O', '·ª†': 'O', '·ª¢': 'O',
        '√ô': 'U', '√ö': 'U', '·ª¶': 'U', '≈®': 'U', '·ª§': 'U',
        '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª¨': 'U', '·ªÆ': 'U', '·ª∞': 'U',
        '·ª≤': 'Y', '√ù': 'Y', '·ª∂': 'Y', '·ª∏': 'Y', '·ª¥': 'Y',
        'ƒê': 'D'
    };
    
    // Thay th·∫ø d·∫•u ti·∫øng Vi·ªát
    let normalized = text;
    for (const [accented, plain] of Object.entries(vietnameseMap)) {
        normalized = normalized.replace(new RegExp(accented, 'g'), plain);
    }
    
    // Chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
    normalized = normalized.toLowerCase().trim();
    
    return normalized;
}

// H√†m t√¨m ki·∫øm linh ho·∫°t - h·ªó tr·ª£ t√¨m ki·∫øm d√≠nh li·ªÅn v√† t√°ch r·ªùi
function flexibleSearch(searchText, targetText) {
    if (!searchText || !targetText) return false;
    
    // Chu·∫©n h√≥a c·∫£ hai vƒÉn b·∫£n
    const normalizedSearch = normalizeVietnameseText(searchText);
    const normalizedTarget = normalizeVietnameseText(targetText);
    
    // 1. T√¨m ki·∫øm tr·ª±c ti·∫øp (bao g·ªìm c·∫£ d√≠nh li·ªÅn)
    if (normalizedTarget.includes(normalizedSearch)) {
        return true;
    }
    
    // 2. T√¨m ki·∫øm khi t√°ch t·ª´ (n·∫øu searchText c√≥ th·ªÉ t√°ch th√†nh nhi·ªÅu t·ª´)
    const searchWords = normalizedSearch.split(/\s+/).filter(word => word.length > 0);
    if (searchWords.length > 1) {
        // N·∫øu c√≥ nhi·ªÅu t·ª´, ki·ªÉm tra xem t·∫•t c·∫£ t·ª´ c√≥ xu·∫•t hi·ªán trong target kh√¥ng
        return searchWords.every(word => normalizedTarget.includes(word));
    }
    
    // 3. T√¨m ki·∫øm khi gh√©p t·ª´ (n·∫øu searchText c√≥ th·ªÉ l√† t·ª´ gh√©p)
    if (normalizedSearch.length > 3) {
        // Th·ª≠ t√°ch th√†nh c√°c t·ª´ c√≥ th·ªÉ c√≥
        const possibleCombinations = generatePossibleCombinations(normalizedSearch);
        for (const combination of possibleCombinations) {
            if (normalizedTarget.includes(combination)) {
                return true;
            }
        }
    }
    
    // 4. T√¨m ki·∫øm fuzzy - ki·ªÉm tra ƒë·ªô t∆∞∆°ng t·ª±
    if (calculateSimilarity(normalizedSearch, normalizedTarget) > 0.7) {
        return true;
    }
    
    return false;
}

// H√†m t·∫°o c√°c t·ªï h·ª£p t·ª´ c√≥ th·ªÉ c√≥ t·ª´ m·ªôt chu·ªói d√≠nh li·ªÅn
function generatePossibleCombinations(text) {
    const combinations = [];
    
    // Th√™m ch√≠nh n√≥
    combinations.push(text);
    
    // Th√™m c√°c bi·∫øn th·ªÉ c√≥ th·ªÉ c√≥
    if (text.length > 4) {
        // Th·ª≠ ch√®n kho·∫£ng tr·∫Øng ·ªü c√°c v·ªã tr√≠ kh√°c nhau
        for (let i = 2; i < text.length - 1; i++) {
            const part1 = text.substring(0, i);
            const part2 = text.substring(i);
            combinations.push(part1 + ' ' + part2);
        }
    }
    
    // Th√™m c√°c bi·∫øn th·ªÉ thay th·∫ø k√Ω t·ª± t∆∞∆°ng t·ª±
    const similarChars = {
        'd': ['d', 'ƒë'],
        'ƒë': ['d', 'ƒë'],
        'i': ['i', 'y'],
        'y': ['i', 'y'],
        'u': ['u', '∆∞'],
        '∆∞': ['u', '∆∞'],
        'o': ['o', '√¥', '∆°'],
        '√¥': ['o', '√¥', '∆°'],
        '∆°': ['o', '√¥', '∆°'],
        'a': ['a', 'ƒÉ', '√¢'],
        'ƒÉ': ['a', 'ƒÉ', '√¢'],
        '√¢': ['a', 'ƒÉ', '√¢'],
        'e': ['e', '√™'],
        '√™': ['e', '√™']
    };
    
    // T·∫°o bi·∫øn th·ªÉ v·ªõi c√°c k√Ω t·ª± t∆∞∆°ng t·ª±
    for (const [char, alternatives] of Object.entries(similarChars)) {
        if (text.includes(char)) {
            for (const alt of alternatives) {
                if (alt !== char) {
                    combinations.push(text.replace(new RegExp(char, 'g'), alt));
                }
            }
        }
    }
    
    return combinations;
}

// H√†m t√≠nh ƒë·ªô t∆∞∆°ng t·ª± gi·ªØa hai chu·ªói (Levenshtein distance)
function calculateSimilarity(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    const maxLength = Math.max(str1.length, str2.length);
    const similarity = 1 - (matrix[str2.length][str1.length] / maxLength);
    return similarity;
}

// Function to search invoices (flexible like products.html)
function searchInvoices() {
  // L·∫•y gi√° tr·ªã t·ª´ c√°c filter
  const fromDate = document.getElementById('from-date').value;
  const toDate = document.getElementById('to-date').value;
  const invoiceNumber = normalizeVietnameseText((document.getElementById('invoice-number')?.value)||'');
  const customerInfo = normalizeVietnameseText((document.getElementById('buyer-search')?.value) || '');
  const loaiHd = (document.getElementById('loai-hd-filter')?.value) || '';
  
  // T·∫°o object ch·ª©a d·ªØ li·ªáu t√¨m ki·∫øm
  const searchData = {};
  if (fromDate) searchData.fromDate = fromDate;
  if (toDate) searchData.toDate = toDate;
  if (invoiceNumber) searchData.invoiceNumber = invoiceNumber;
  if (customerInfo) searchData.customerInfo = customerInfo;
  if (loaiHd) searchData.loaiHd = loaiHd;
  
  if ((fromDate && !toDate) || (!fromDate && toDate)) {
    // Ch∆∞a ƒë·ªß c·∫∑p ng√†y -> ch∆∞a t√¨m
    return;
  }
  
  if (fromDate && toDate) {
    const fromDateObj = new Date(fromDate);
    const toDateObj = new Date(toDate);
    if (fromDateObj > toDateObj) { return; }
  }
  
  // C·∫≠p nh·∫≠t URL v·ªõi c√°c tham s·ªë t√¨m ki·∫øm
  const queryParams = new URLSearchParams();
  if (searchData.fromDate) queryParams.set('from_date', searchData.fromDate);
  if (searchData.toDate) queryParams.set('to_date', searchData.toDate);
  if (searchData.invoiceNumber) queryParams.set('invoice_number', searchData.invoiceNumber);
  if (searchData.customerInfo) queryParams.set('customer_info', searchData.customerInfo);
  if (searchData.loaiHd) queryParams.set('loai_hd', searchData.loaiHd);
  const newUrl = window.location.pathname + (queryParams.toString()? ('?' + queryParams.toString()) : '');
  window.history.replaceState({}, '', newUrl);
  
  // L·ªçc tr·ª±c ti·∫øp tr√™n b·∫£ng (client-side) ƒë·ªÉ ph·∫£n h·ªìi nhanh
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 7) return;
    const soHd = normalizeVietnameseText(cells[0].textContent || '');
    const ngay = (cells[1].textContent || '').trim();
    const tenKh = normalizeVietnameseText(cells[2].textContent || '');
    const loai = (cells[4].textContent || '').trim();
    const status = (cells[5].textContent || '').trim();

    // Ng√†y: so s√°nh theo kho·∫£ng n·∫øu c√≥
    let match = true;
    if (fromDate) {
      try { if (new Date(ngay) < new Date(fromDate)) match = false; } catch(_){}
    }
    if (toDate && match) {
      try { if (new Date(ngay) > new Date(toDate)) match = false; } catch(_){}
    }

    // S·ªë Hƒê linh ho·∫°t
    if (match && invoiceNumber) {
      match = flexibleSearch(invoiceNumber, soHd);
    }

    // T√™n KH linh ho·∫°t
    if (match && customerInfo) {
      match = flexibleSearch(customerInfo, tenKh);
    }

    // Lo·∫°i Hƒê
    if (match && loaiHd) {
      match = (loai === loaiHd);
    }

    row.style.display = match ? '' : 'none';
    if (match) visible++;
  });
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
}

// G·∫Øn event listeners cho filter sau khi searchInvoices ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
document.addEventListener('DOMContentLoaded', function(){
  function debounce(fn, delay){ let t; return function(){ clearTimeout(t); const a=arguments, c=this; t=setTimeout(()=>fn.apply(c,a), delay||300); } }
  const from = document.getElementById('from-date');
  const to = document.getElementById('to-date');
  const inv = document.getElementById('invoice-number');
  const cus = document.getElementById('buyer-search');
  const loaiHdSel = document.getElementById('loai-hd-filter');
  if (from) from.addEventListener('change', applyAllFilters);
  if (to) to.addEventListener('change', applyAllFilters);
  if (inv) inv.addEventListener('input', debounce(searchInvoices, 300));
  if (cus) cus.addEventListener('input', debounce(searchInvoices, 300));
  if (loaiHdSel) loaiHdSel.addEventListener('change', function(){
    applyLoaiFilter();
    // c·∫≠p nh·∫≠t URL param loai_hd
    const url = new URL(window.location);
    const v = this.value || '';
    if (v) url.searchParams.set('loai_hd', v); else url.searchParams.delete('loai_hd');
    window.history.replaceState({}, '', url);
  });
});

// √Åp d·ª•ng filter theo tr·∫°ng th√°i d·ª±a tr√™n tab
function applyStatusFilter(status){
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  if (status === 'all'){
    // Hi·ªÉn th·ªã t·∫•t c·∫£, tr·ªü l·∫°i th·ª© t·ª± ban ƒë·∫ßu
    rows.sort((a,b)=> (parseInt(a.getAttribute('data-index')||'0',10) - parseInt(b.getAttribute('data-index')||'0',10)));
    rows.forEach(row=>{ row.style.display=''; visible++; });
  } else {
    // Hi·ªÉn th·ªã theo tr·∫°ng th√°i v√† s·∫Øp x·∫øp nh√≥m tr·∫°ng th√°i ƒë∆∞·ª£c ch·ªçn l√™n tr∆∞·ªõc
    const tbody = document.querySelector('.product-table tbody');
    const match = [], nonMatch = [];
    rows.forEach(row=>{
      const s = row.getAttribute('data-status') || '';
      if (s === status){ match.push(row); } else { nonMatch.push(row); }
    });
    // Gh√©p l·∫°i: tr∆∞·ªõc l√† match (hi·ªÉn th·ªã), sau l√† nonMatch (·∫©n)
    match.forEach(r=>{ r.style.display=''; tbody.appendChild(r); });
    nonMatch.forEach(r=>{ r.style.display='none'; tbody.appendChild(r); });
    visible = match.length;
  }
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
}

function updateTotalFooter(){
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  const visible = rows.filter(r=>r.style.display !== 'none').length || rows.length;
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
}

// Helper chu·∫©n h√≥a chu·ªói ƒë·ªÉ so s√°nh (b·ªè kho·∫£ng tr·∫Øng, kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng)
function normalized(v){
  return (v || '').toString().normalize('NFC').trim().toLowerCase();
}

function getActiveStatus(){
  const active = document.querySelector('.tabs .tab.active');
  return active ? active.getAttribute('data-status') : 'all';
}

// L·ªçc theo Lo·∫°i Hƒê (select ·ªü thanh filter)
function applyLoaiFilter(){
  const loai = normalized(document.getElementById('loai-hd-filter')?.value || '');
  const status = normalized(getActiveStatus());
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  let visible = 0;
  rows.forEach(row=>{
    const rowLoai = normalized(row.getAttribute('data-loai') || '');
    const rowStatus = normalized(row.getAttribute('data-status') || '');
    const okLoai = (!loai) || (rowLoai === loai);
    const okStatus = (status === 'all') || (rowStatus === status);
    const show = okLoai && okStatus;
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  const totalSpan = document.querySelector('.total-count');
  if (totalSpan) totalSpan.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
  const footer = document.querySelector('.total-footer');
  if (footer) footer.textContent = `T·ªïng: ${visible} h√≥a ƒë∆°n`;
}

// √Åp d·ª•ng t·∫•t c·∫£ filter: ng√†y, s·ªë Hƒê, KH, lo·∫°i, tr·∫°ng th√°i
function applyAllFilters(){
  const status = getActiveStatus();
  // B·∫Øt ƒë·∫ßu t·ª´ hi·ªÉn th·ªã t·∫•t c·∫£, sau ƒë√≥ g·ªçi searchInvoices ƒë·ªÉ l·ªçc m·ªÅm
  const rows = Array.from(document.querySelectorAll('.product-table tbody tr'));
  rows.forEach(r=> r.style.display='');
  searchInvoices();
}

// T·ª± ƒë·ªông tƒÉng s·ªë Hƒê
let currentInvoiceNumber = 1;

function generateInvoiceNumber() {
  // L·∫•y s·ªë h√≥a ƒë∆°n ti·∫øp theo t·ª´ server
  safeFetch('/api/invoices/next-number')
    .then(response => response.json())
    .then(data => {
      if (data && typeof data.next_number === 'number' && data.next_number > 0) {
        currentInvoiceNumber = data.next_number;
      }
      const formattedNumber = `Hƒê-${currentInvoiceNumber.toString().padStart(4, '0')}`;
      const el = document.getElementById('auto-so-hd');
      if (el) el.value = formattedNumber;
    })
    .catch(error => {
      console.error('Error getting next invoice number:', error);
      // Fallback: s·ª≠ d·ª•ng s·ªë hi·ªán t·∫°i
      const formattedNumber = `Hƒê-${currentInvoiceNumber.toString().padStart(4, '0')}`;
      const el = document.getElementById('auto-so-hd');
      if (el) el.value = formattedNumber;
    });
}

// T√åM KI·∫æM M·ªöI: T√¨m ƒë∆°n h√†ng theo m√£ ƒë∆°n h√†ng
async function searchOrdersForInvoice(query){
  const resultsDiv = document.getElementById('order-results');
  if (!resultsDiv) return;

  const q = (query || '').trim();
  if (!q){ 
    resultsDiv.style.display='none'; 
    resultsDiv.innerHTML=''; 
    return; 
  }

  console.log(`üîç T√åM KI·∫æM M·ªöI: T√¨m ki·∫øm ƒë∆°n h√†ng v·ªõi m√£: "${q}"`);

  try{
    // L·∫•y to√†n b·ªô danh s√°ch ƒë∆°n h√†ng
    const r = await safeFetch('/api/orders/');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const list = await r.json();
    const all = Array.isArray(list) ? list : [];

    console.log(`üìã T√åM KI·∫æM M·ªöI: Nh·∫≠n ƒë∆∞·ª£c ${all.length} ƒë∆°n h√†ng t·ª´ API`);

    // L·ªçc: t·∫•t c·∫£ ƒë∆°n h√†ng + kh·ªõp theo m√£ ƒë∆°n h√†ng (kh√¥ng gi·ªõi h·∫°n tr·∫°ng th√°i)
    const filtered = all.filter(o => {
      const code = (o.ma_don_hang || o.id || '').toString();
      const codeOk = code === q || code.includes(q) || q.includes(code);
      
      console.log(`üîç T√åM KI·∫æM M·ªöI: Ki·ªÉm tra "${code}" vs "${q}" -> Tr·∫°ng th√°i: "${o.trang_thai}", Code: ${codeOk}`);
      
      return codeOk;
    });

    console.log(`‚úÖ T√åM KI·∫æM M·ªöI: T√¨m th·∫•y ${filtered.length} ƒë∆°n h√†ng ph√π h·ª£p`);

    if (!filtered.length){
      resultsDiv.innerHTML = '<div style="padding:8px;color:#666;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</div>';
      resultsDiv.style.display = 'block';
      console.log(`‚ùå T√åM KI·∫æM M·ªöI: Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o v·ªõi m√£ "${q}"`);
      return;
    }

    resultsDiv.innerHTML = '';
    filtered.forEach(o => {
      const div = document.createElement('div');
      div.style.padding='8px';
      div.style.borderBottom='1px solid #eee';
      div.style.cursor='pointer';
      const amt = (parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US');
      div.textContent = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${amt} VND) - ${o.trang_thai||'N/A'}`;
      div.onclick=function(){ selectOrderForInvoice(o); };
      resultsDiv.appendChild(div);
    });
    resultsDiv.style.display='block';
    
    console.log(`‚úÖ T√åM KI·∫æM M·ªöI: Hi·ªÉn th·ªã ${filtered.length} ƒë∆°n h√†ng`);
  } catch(err){
    console.error('‚ùå T√åM KI·∫æM M·ªöI: L·ªói t√¨m ki·∫øm ƒë∆°n h√†ng:', err);
    resultsDiv.innerHTML = '<div style="padding:8px;color:#666;">L·ªói t√¨m ki·∫øm ƒë∆°n h√†ng</div>';
    resultsDiv.style.display = 'block';
  }
}

async function selectOrderForInvoice(o){
  console.log('üéØ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Ch·ªçn ƒë∆°n h√†ng:', o);
  
  const inp=document.getElementById('order-search');
  const hid=document.getElementById('selected_order_id');
  if (inp) inp.value = o.ma_don_hang||o.id;
  if (hid) hid.value = o.id;
  
  // T·ª∞ ƒê·ªòNG ƒêI·ªÄN T√äN KH√ÅCH H√ÄNG
  const customerSelect = document.getElementById('tai_khoan_select');
  if (customerSelect && o.thong_tin_kh) {
    console.log(`üéØ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: T√¨m kh√°ch h√†ng "${o.thong_tin_kh}" trong dropdown`);
    
    // T√¨m option kh√°ch h√†ng ph√π h·ª£p
    let found = false;
    for (let i = 0; i < customerSelect.options.length; i++) {
      const option = customerSelect.options[i];
      if (option.textContent.trim() === o.thong_tin_kh.trim()) {
        customerSelect.selectedIndex = i;
        console.log(`‚úÖ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: ƒê√£ ch·ªçn kh√°ch h√†ng "${o.thong_tin_kh}"`);
        found = true;
        break;
      }
    }
    
    if (!found) {
      console.log(`‚ö†Ô∏è T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng "${o.thong_tin_kh}" trong dropdown`);
    }
  }
  
  // ƒêi·ªÅn t·ªïng ti·ªÅn
  const tong = document.querySelector('#invoice-form input[name="tong_tien"]');
  if (tong) tong.value = o.tong_tien || 0;
  setInvoiceTotalFromOrder(o.tong_tien || 0);
  
  // ƒêi·ªÅn lo·∫°i s·∫£n ph·∫©m
  const loai = document.querySelector('#invoice-form select[name="loai_hd"]');
  await preloadProducts();
  const key = o.sp_banggia || '';
  if (loai){ loai.value = productExists(key) ? 'S·∫£n ph·∫©m' : 'H√†nh ƒë·ªông'; }
  
  // ·∫®n k·∫øt qu·∫£ t√¨m ki·∫øm
  const resultsDiv = document.getElementById('order-results');
  if (resultsDiv){ resultsDiv.style.display='none'; resultsDiv.innerHTML=''; }
  
  console.log('‚úÖ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Ho√†n th√†nh ƒëi·ªÅn th√¥ng tin ƒë∆°n h√†ng');
}

// Debounce function ƒë·ªÉ tr√°nh g·ªçi API qu√° nhi·ªÅu
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

document.addEventListener('DOMContentLoaded', function(){
  const os = document.getElementById('order-search');
  if (os){ 
    const debouncedSearch = debounce(function(query) {
      searchOrdersForInvoice(query);
    }, 300); // Ch·ªù 300ms sau khi user ng·ª´ng g√µ
    
    os.addEventListener('input', function(){ 
      debouncedSearch(this.value.trim()); 
    }); 
    // Cho ph√©p nh·∫•n Enter ƒë·ªÉ t√¨m ngay
    os.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        const q = (this.value || '').trim();
        if (q) { searchOrdersForInvoice(q); }
      }
    });
  }
});

// ====== Preload danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ suy lu·∫≠n lo·∫°i h√≥a ƒë∆°n ======
let __productKeys = null; // Set c√°c kh√≥a: m√£ SP v√† t√™n SP (lowercase)
async function preloadProducts(){
  if (__productKeys) return __productKeys;
  try{
    const r = await safeFetch('/api/products/');
    const list = await r.json();
    const arr = Array.isArray(list) ? list : [];
    __productKeys = new Set();
    arr.forEach(p=>{
      const code = (p.ma_sp||'').toString().toLowerCase();
      const name = (p.ten_sp||'').toString().toLowerCase();
      if (code) __productKeys.add(code);
      if (name) __productKeys.add(name);
    });
  }catch(_){ __productKeys = new Set(); }
  return __productKeys;
}
function productExists(key){
  if (!key) return false;
  const s = (key||'').toString().toLowerCase();
  return !!(__productKeys && __productKeys.has(s));
}

// N·∫°p danh s√°ch ƒë∆°n h√†ng (Ho√†n th√†nh) v√†o dropdown
async function loadOrdersForSelect(){
  const sel = document.getElementById('order-select');
  if (!sel) return Promise.resolve();
  // Reset l·∫°i dropdown, ch·ªâ gi·ªØ placeholder v√† option "Kh√°c"
  sel.innerHTML = '<option value="">Ch·ªçn ƒë∆°n h√†ng</option><option value="khac">Kh√°c (nh·∫≠p m√£)</option>';
  const customerSelect = document.getElementById('tai_khoan_select');
  const customerId = customerSelect ? customerSelect.value : '';
  
  try{
    // S·ª≠ d·ª•ng API orders th√¥ng th∆∞·ªùng thay v√¨ search API
    const r = await safeFetch('/api/orders/');
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    
    const list = await r.json();
    const orders = Array.isArray(list)? list:[];
    
    // Helper chu·∫©n h√≥a ti·∫øng Vi·ªát (b·ªè d·∫•u, th∆∞·ªùng h√≥a)
    const normalize = (s)=> (s||'')
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .trim();
    
    // L·ªçc ch·ªâ l·∫•y ƒë∆°n h√†ng ho√†n th√†nh (linh ho·∫°t theo nhi·ªÅu bi·∫øn th·ªÉ)
    const completedOrders = orders.filter(o => {
      const st = normalize(o.trang_thai);
      return st === 'hoan thanh' || st === 'da hoan thanh' || st === 'completed' || st === 'done';
    });
    
    console.log(`üìã Nh·∫≠n ƒë∆∞·ª£c ${orders.length} ƒë∆°n h√†ng t·ª´ API`);
    console.log(`‚úÖ T√¨m th·∫•y ${completedOrders.length} ƒë∆°n h√†ng ho√†n th√†nh`);
    
    // B·ªò L·ªåC M·ªöI: L·ªçc ƒë∆°n h√†ng theo kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn
    let filteredOrders = completedOrders;
    const selectedCustomerOption = customerSelect ? customerSelect.options[customerSelect.selectedIndex] : null;
    const selectedCustomerName = selectedCustomerOption ? selectedCustomerOption.textContent.trim() : '';
    
    if (selectedCustomerName && selectedCustomerName !== 'Ch·ªçn t√†i kho·∫£n kh√°ch h√†ng') {
      console.log(`üéØ B·ªò L·ªåC M·ªöI: L·ªçc cho kh√°ch h√†ng "${selectedCustomerName}"`);
      
      // L·ªçc ch√≠nh x√°c: ch·ªâ l·∫•y ƒë∆°n h√†ng c√≥ t√™n kh√°ch h√†ng kh·ªõp ch√≠nh x√°c
      filteredOrders = completedOrders.filter(order => {
        const orderCustomerName = order.thong_tin_kh || '';
        const isMatch = orderCustomerName === selectedCustomerName;
        
        console.log(`üîç So s√°nh: "${orderCustomerName}" === "${selectedCustomerName}" -> ${isMatch ? '‚úÖ KH·ªöP' : '‚ùå KH√îNG KH·ªöP'}`);
        
        return isMatch;
      });
      
      console.log(`‚úÖ B·ªò L·ªåC M·ªöI: T√¨m th·∫•y ${filteredOrders.length} ƒë∆°n h√†ng cho kh√°ch h√†ng "${selectedCustomerName}"`);
    } else {
      console.log(`‚úÖ B·ªò L·ªåC M·ªöI: Kh√¥ng c√≥ b·ªô l·ªçc kh√°ch h√†ng, hi·ªÉn th·ªã t·∫•t c·∫£ ${completedOrders.length} ƒë∆°n h√†ng`);
    }
    
    // Kh·ª≠ tr√πng l·∫∑p theo m√£ ƒë∆°n h√†ng (∆∞u ti√™n ƒë∆°n ƒë·∫ßu ti√™n, chu·∫©n h√≥a code)
    const seen = new Set();
    const unique = [];
    const seenText = new Set(); // Th√™m ki·ªÉm tra text hi·ªÉn th·ªã
    
    for (const o of filteredOrders){
      const code = (o.ma_don_hang || o.id || '').toString().trim().toLowerCase();
      const displayText = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${(parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US')} VND)`;
      
      // Ki·ªÉm tra c·∫£ m√£ v√† text hi·ªÉn th·ªã ƒë·ªÉ tr√°nh tr√πng l·∫∑p
      if (seen.has(code) || seenText.has(displayText)) {
        console.log(`üö´ B·ªè qua ƒë∆°n h√†ng tr√πng l·∫∑p: ${displayText}`);
        continue;
      }
      
      seen.add(code);
      seenText.add(displayText);
      unique.push(o);
    }

    // S·∫Øp x·∫øp theo m√£ ƒë∆°n h√†ng ƒë·ªÉ d·ªÖ t√¨m
    unique.sort((a, b) => {
      const codeA = (a.ma_don_hang || a.id || '').toString().toLowerCase();
      const codeB = (b.ma_don_hang || b.id || '').toString().toLowerCase();
      return codeA.localeCompare(codeB);
    });

    unique.forEach(o=>{
      const op = document.createElement('option');
      op.value = o.id;
      const amt = (parseInt(o.tong_tien||0,10)||0).toLocaleString('en-US');
      op.textContent = `${o.ma_don_hang||o.id} - ${o.thong_tin_kh||''} (${amt} VND)`;
      op.dataset.tong = o.tong_tien || 0;
      op.dataset.loai = o.loai_suy_luan || '';
      // L∆∞u m√£ SP/b·∫£ng gi√° (n·∫øu API c√≥), d√πng ƒë·ªÉ suy lu·∫≠n lo·∫°i
      op.dataset.sp = o.sp_banggia || '';
      op.dataset.customer = o.thong_tin_kh || '';
      // Duy tr√¨ c√°c data c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch handler c≈©
      op.setAttribute('data-customer', o.thong_tin_kh || '');
      op.setAttribute('data-amount', o.tong_tien || 0);
      op.setAttribute('data-order-id', o.id);
      op.setAttribute('data-customer-name', o.thong_tin_kh || '');
      sel.appendChild(op);
    });

    console.log(`‚úÖ ƒê√£ n·∫°p ${unique.length} ƒë∆°n h√†ng duy nh·∫•t (t·ª´ ${completedOrders.length} ƒë∆°n h√†ng ho√†n th√†nh)`);

    // Ki·ªÉm tra v√† s·ª≠a tr√πng l·∫∑p ngay l·∫≠p t·ª©c
    setTimeout(() => {
      debugCheckDuplicates();
      // Th√™m m·ªôt l·∫ßn ki·ªÉm tra n·ªØa ƒë·ªÉ ƒë·∫£m b·∫£o
      setTimeout(() => debugCheckDuplicates(), 200);
    }, 100);

    // Sau khi n·∫°p xong, √°p d·ª•ng l·∫°i b·ªô l·ªçc theo kh√°ch h√†ng hi·ªán t·∫°i (n·∫øu c√≥)
    let currentCustomerName = '';
    if (customerId && customerId !== 'khac'){
      const selectedOption = customerSelect.options[customerSelect.selectedIndex];
      currentCustomerName = selectedOption ? (selectedOption.getAttribute('data-ten-tk') || '') : '';
    } else {
      const tenTkMoiInput = document.getElementById('ten_tk_moi');
      currentCustomerName = tenTkMoiInput ? (tenTkMoiInput.value || '') : '';
    }
    filterOrdersByCustomer(currentCustomerName);
  }catch(err){ 
    console.error('Load orders error:', err);
  }
}

// X·ª≠ l√Ω thay ƒë·ªïi dropdown ƒë∆°n h√†ng
(function(){
  const sel = document.getElementById('order-select');
  const searchInput = document.getElementById('order-search');
  if (!sel) return;
  sel.addEventListener('change', async function(){
    const val = this.value;
    if (val === 'khac'){
      // Hi·ªÉn th·ªã √¥ nh·∫≠p ƒë·ªÉ ng∆∞·ªùi d√πng t·ª± g√µ t√¨m ki·∫øm
      if (searchInput) searchInput.style.display='block';
      document.getElementById('selected_order_id').value = '';
      // Focus v√†o √¥ nh·∫≠p v√† clear k·∫øt qu·∫£
      if (searchInput){
        searchInput.focus();
        const res = document.getElementById('order-results');
        if (res){ res.style.display='none'; res.innerHTML=''; }
      }
    } else if (val){
      if (searchInput) { searchInput.style.display='none'; searchInput.value=''; }
      document.getElementById('selected_order_id').value = val;
      // ƒêi·ªÅn t·ªïng ti·ªÅn + lo·∫°i SP
      const tongVal = this.options[this.selectedIndex].dataset.tong || 0;
      const tong = document.querySelector('#invoice-form input[name="tong_tien"]');
      if (tong) tong.value = tongVal;
      // c·∫≠p nh·∫≠t √¥ hi·ªÉn th·ªã c√≥ d·∫•u ph·∫©y
      setInvoiceTotalFromOrder(tongVal);
      const loai = document.querySelector('#invoice-form select[name="loai_hd"]');
      // Suy lu·∫≠n lo·∫°i theo s·ª± t·ªìn t·∫°i c·ªßa s·∫£n ph·∫©m trong danh s√°ch products
      await preloadProducts();
      const spKey = this.options[this.selectedIndex].dataset.sp || '';
      if (loai){ loai.value = productExists(spKey) ? 'S·∫£n ph·∫©m' : 'H√†nh ƒë·ªông'; }
    } else {
      if (searchInput) { searchInput.style.display='none'; searchInput.value=''; }
      document.getElementById('selected_order_id').value = '';
    }
  });
})();

// B·ªò L·ªåC M·ªöI: Khi ch·ªçn kh√°ch h√†ng -> l·ªçc ƒë∆°n h√†ng
(function(){
  const customerSelect = document.getElementById('tai_khoan_select');
  const orderSelect = document.getElementById('order-select');
  if (customerSelect){
    customerSelect.addEventListener('change', function(){
      const selectedCustomer = customerSelect.options[customerSelect.selectedIndex];
      const customerName = selectedCustomer ? selectedCustomer.textContent.trim() : '';
      
      console.log('üîÑ B·ªò L·ªåC M·ªöI: Kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn:', customerName);
      
      if (orderSelect) orderSelect.selectedIndex = 0;
      
      // Load l·∫°i danh s√°ch ƒë∆°n h√†ng (ƒë√£ c√≥ b·ªô l·ªçc t√≠ch h·ª£p)
      loadOrdersForSelect();
      
      // M·∫∑c ƒë·ªãnh ·∫©n √¥ nh·∫≠p khi v·ª´a ƒë·ªïi kh√°ch h√†ng
      const si = document.getElementById('order-search');
      if (si){ si.style.display='none'; si.value=''; }
    });
  }
})();

// Kh·ªüi t·∫°o s·ªë Hƒê khi m·ªü modal
function openInvoiceModal() {
  generateInvoiceNumber();
  document.getElementById('add-invoice-modal').style.display = 'block';
}

// Kh·ªüi t·∫°o khi trang load
document.addEventListener('DOMContentLoaded', function() {
  // Kh·ªüi t·∫°o s·ªë Hƒê ƒë·∫ßu ti√™n
  generateInvoiceNumber();
  
  // G·∫Øn l·∫°i s·ª± ki·ªán m·ªü modal t·∫°o h√≥a ƒë∆°n cho n√∫t trong thanh summary
  const addButton = document.querySelector('.add-btn');
  if (addButton) addButton.addEventListener('click', openAddInvoiceModal);
  
  // T·ª± ƒë·ªông load danh s√°ch ƒë∆°n h√†ng khi trang ƒë∆∞·ª£c t·∫£i
  loadOrdersForSelect();
  
  // Th√™m n√∫t debug v√†o console (ch·ªâ trong development)
  if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
    window.debugInvoices = {
      checkDuplicates: debugCheckDuplicates,
      removeDuplicates: removeDuplicateOptions,
      reloadOrders: loadOrdersForSelect,
      filterByCustomer: filterOrdersByCustomer,

      debugCustomerData: () => {
        console.log('üîç Debug d·ªØ li·ªáu kh√°ch h√†ng:');
        const customerSelect = document.getElementById('tai_khoan_select');
        const orderSelect = document.getElementById('order-select');
        
        if (customerSelect) {
          console.log('üìã Danh s√°ch kh√°ch h√†ng:');
          Array.from(customerSelect.options).forEach((opt, index) => {
            console.log(`  ${index}: "${opt.textContent}" (value: "${opt.value}")`);
          });
        }
        
        if (orderSelect) {
          console.log('üìã Danh s√°ch ƒë∆°n h√†ng:');
          Array.from(orderSelect.options).forEach((opt, index) => {
            const customer = opt.getAttribute('data-customer-name') || opt.dataset.customer || '';
            console.log(`  ${index}: "${opt.textContent}" (customer: "${customer}")`);
          });
        }
      },

      forceReloadAndFilter: (customerName) => {
        console.log(`üîÑ B·ªò L·ªåC M·ªöI: Force reload v√† l·ªçc cho kh√°ch h√†ng: "${customerName}"`);
        loadOrdersForSelect();
      },
      debugOrdersData: async () => {
        console.log('üîç Debug d·ªØ li·ªáu ƒë∆°n h√†ng:');
        try {
          const r = await safeFetch('/api/orders/');
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const list = await r.json();
          const all = Array.isArray(list) ? list : [];
          
          console.log(`üìã T·ªïng s·ªë ƒë∆°n h√†ng: ${all.length}`);
          
          all.forEach((order, index) => {
            console.log(`  ${index + 1}: M√£: "${order.ma_don_hang || order.id}", Kh√°ch h√†ng: "${order.thong_tin_kh}", Tr·∫°ng th√°i: "${order.trang_thai}", T·ªïng ti·ªÅn: ${order.tong_tien}`);
          });
          
          // T√¨m ƒë∆°n h√†ng c√≥ m√£ "950"
          const order950 = all.find(o => (o.ma_don_hang || o.id || '').toString() === '950');
          if (order950) {
            console.log(`‚úÖ T√¨m th·∫•y ƒë∆°n h√†ng 950:`, order950);
          } else {
            console.log(`‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng c√≥ m√£ "950"`);
          }
          
        } catch (err) {
          console.error('‚ùå L·ªói khi debug d·ªØ li·ªáu ƒë∆°n h√†ng:', err);
        }
      },

      debugCustomerDropdown: () => {
        console.log('üîç Debug dropdown kh√°ch h√†ng:');
        const customerSelect = document.getElementById('tai_khoan_select');
        if (customerSelect) {
          console.log('üìã Danh s√°ch kh√°ch h√†ng trong dropdown:');
          Array.from(customerSelect.options).forEach((opt, index) => {
            console.log(`  ${index}: "${opt.textContent}" (value: "${opt.value}")`);
          });
        } else {
          console.log('‚ùå Kh√¥ng t√¨m th·∫•y dropdown kh√°ch h√†ng');
        }
      },
      debugChangeState: () => {
        console.log('üîç Debug tr·∫°ng th√°i thay ƒë·ªïi:');
        console.log(`  - addChanged: ${addChanged}`);
        console.log(`  - addInitialState: ${addInitialState ? 'C√≥' : 'Kh√¥ng'}`);
        console.log(`  - viewChanged: ${viewChanged}`);
        console.log(`  - viewInitialState: ${viewInitialState ? 'C√≥' : 'Kh√¥ng'}`);
      },
      resetAllChangeStates: () => {
        console.log('üîÑ Reset t·∫•t c·∫£ tr·∫°ng th√°i thay ƒë·ªïi:');
        resetAddChangeState();
        resetViewChangeState();
      }
    };
    console.log('üîß Debug functions available:');
    console.log('  - window.debugInvoices.checkDuplicates()');
    console.log('  - window.debugInvoices.removeDuplicates()');
    console.log('  - window.debugInvoices.reloadOrders()');
    console.log('  - window.debugInvoices.filterByCustomer("t√™n kh√°ch h√†ng")');

    console.log('  - window.debugInvoices.debugCustomerDropdown() (xem dropdown kh√°ch h√†ng)');
    console.log('  - window.debugInvoices.debugChangeState() (xem tr·∫°ng th√°i thay ƒë·ªïi)');
    console.log('  - window.debugInvoices.resetAllChangeStates() (reset t·∫•t c·∫£ tr·∫°ng th√°i)');
  }
  // √Åp d·ª•ng ph√¢n quy·ªÅn UI to√†n c·ª•c ngay khi trang t·∫£i
  if (window.checkUserPermissions) { window.checkUserPermissions(); }
});


// Modal functions
function openAddInvoiceModal() {
  // Reset form tr∆∞·ªõc khi hi·ªÉn th·ªã
  document.getElementById('invoice-form').reset();
  document.getElementById('tai_khoan_moi_div').style.display = 'none';
  generateInvoiceNumber();
  const m = document.getElementById('add-invoice-modal');
  if (m) m.style.display = 'flex';
  
  // Load l·∫°i danh s√°ch ƒë∆°n h√†ng (ƒë√£ c√≥ b·ªô l·ªçc t√≠ch h·ª£p)
  loadOrdersForSelect();
  
  console.log('üîÑ B·ªò L·ªåC M·ªöI: ƒê√£ m·ªü modal t·∫°o h√≥a ƒë∆°n v√† load l·∫°i danh s√°ch ƒë∆°n h√†ng');
}

function closeInvoiceModal() {
  document.getElementById('add-invoice-modal').style.display = 'none';
  // Reset form khi ƒë√≥ng modal
  document.getElementById('invoice-form').reset();
  document.getElementById('tai_khoan_moi_div').style.display = 'none';
}

// M·ªü modal xem chi ti·∫øt h√≥a ƒë∆°n
function openViewInvoiceModal(invoiceId) {
  // Reset form tr∆∞·ªõc khi ƒëi·ªÅn d·ªØ li·ªáu m·ªõi
  document.getElementById('view-invoice-form').reset();
  document.getElementById('view_tai_khoan_moi_div').style.display = 'none';
  document.getElementById('view_nguoi_mua_hidden').value = '';
  
  // L·∫•y th√¥ng tin h√≥a ƒë∆°n t·ª´ server
  safeFetch(`/api/invoices/${invoiceId}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        if (window.showErrorModal) { showErrorModal('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h√≥a ƒë∆°n')); } else { alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h√≥a ƒë∆°n')); }
        return;
      }
      
      // ƒêi·ªÅn th√¥ng tin v√†o form
      document.getElementById('view_invoice_id').value = data.id;
      document.getElementById('view_so_hd').value = data.so_hd || '';
      document.getElementById('view_ngay_hd').value = data.ngay_hd || '';
      
      // X·ª≠ l√Ω th√¥ng tin ng∆∞·ªùi mua
      if (data.nguoi_mua) {
        // T√¨m t√†i kho·∫£n ph√π h·ª£p trong dropdown
        const select = document.getElementById('view_tai_khoan_select');
        let found = false;
        
        for (let i = 0; i < select.options.length; i++) {
          const option = select.options[i];
          const optionText = option.text;
          if (optionText === data.nguoi_mua) {
            select.value = option.value;
            found = true;
            break;
          }
        }
        
        // N·∫øu kh√¥ng t√¨m th·∫•y, ch·ªçn "Kh√°c" v√† ƒëi·ªÅn th√¥ng tin
        if (!found) {
          select.value = 'khac';
          document.getElementById('view_ten_tk_moi').value = data.nguoi_mua;
          document.getElementById('view_tai_khoan_moi_div').style.display = 'block';
        }
        
        // C·∫≠p nh·∫≠t hidden input
        document.getElementById('view_nguoi_mua_hidden').value = data.nguoi_mua;
      }
      
      // T·ªïng ti·ªÅn hi·ªÉn th·ªã d·∫°ng c√≥ d·∫•u ph·∫©y
      const vt = document.getElementById('view_tong_tien');
      const vtd = document.getElementById('view_tong_tien_display');
      if (vt){ vt.value = data.tong_tien || ''; }
      if (vtd){ vtd.value = (parseInt(data.tong_tien||0,10)||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
      document.getElementById('view_loai_hd').value = data.loai_hd || '';
      document.getElementById('view_trang_thai').value = data.trang_thai || 'ƒê√£ thanh to√°n';
      
      document.getElementById('view-invoice-modal').style.display = 'block';
      // B·∫≠t theo d√µi thay ƒë·ªïi ƒë·ªÉ ƒëi·ªÅu khi·ªÉn n√∫t C·∫≠p nh·∫≠t
      bindViewChangeWatcher();
      // √Åp d·ª•ng ph√¢n quy·ªÅn UI to√†n c·ª•c (ƒë√£ ƒë·ªãnh nghƒ©a ·ªü base.html)
      if (window.applyPermissionsToUI) { window.applyPermissionsToUI(); }
    })
    .catch(error => {
      console.error('Error:', error);
      if (window.showErrorModal) { showErrorModal('L·ªói khi t·∫£i th√¥ng tin h√≥a ƒë∆°n!'); } else { alert('L·ªói khi t·∫£i th√¥ng tin h√≥a ƒë∆°n!'); }
    });
}

// ƒê√≥ng modal xem chi ti·∫øt h√≥a ƒë∆°n
function closeViewInvoiceModal() {
  document.getElementById('view-invoice-modal').style.display = 'none';
  // Reset form khi ƒë√≥ng modal
  document.getElementById('view-invoice-form').reset();
  document.getElementById('view_tai_khoan_moi_div').style.display = 'none';
}

// C·∫≠p nh·∫≠t h√≥a ƒë∆°n
function updateInvoice() {
  const form = document.getElementById('view-invoice-form');
  const fd = new FormData(form);

  const id = (fd.get('invoice_id') || '').toString().trim();
  if (!id) { if (window.showErrorModal) { showErrorModal('Thi·∫øu m√£ h√≥a ƒë∆°n.'); } else { alert('Thi·∫øu m√£ h√≥a ƒë∆°n.'); } return; }

  // X√°c ƒë·ªãnh ng∆∞·ªùi mua cu·ªëi c√πng
  let nguoiMuaFinal = fd.get('nguoi_mua') || '';
  const viewSelect = document.getElementById('view_tai_khoan_select');
  if (viewSelect && viewSelect.value === 'khac') {
    const tenMoi = (document.getElementById('view_ten_tk_moi')?.value || '').trim();
    if (!tenMoi) { if (window.showErrorModal) { showErrorModal('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng m·ªõi!'); } else { alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng m·ªõi!'); } return; }
    nguoiMuaFinal = tenMoi;
  }

  const payload = {
    so_hd: fd.get('so_hd'),
    ngay_hd: fd.get('ngay_hd'),
    nguoi_mua: nguoiMuaFinal,
    tong_tien: parseFloat(fd.get('tong_tien') || '0'),
    loai_hd: fd.get('loai_hd'),
    trang_thai: fd.get('trang_thai')
  };

  safeFetch(`/api/invoices/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
      if (data && (data.success || data.id)) {
        // RESET TR·∫†NG TH√ÅI THAY ƒê·ªîI SAU KHI C·∫¨P NH·∫¨T TH√ÄNH C√îNG
        viewChanged = false;
        viewInitialState = null;
        
        if (window.showSuccessModal) { showSuccessModal('C·∫≠p nh·∫≠t h√≥a ƒë∆°n th√†nh c√¥ng!', function(){ location.reload(); }); } else { alert('C·∫≠p nh·∫≠t h√≥a ƒë∆°n th√†nh c√¥ng!'); }
        closeViewInvoiceModal();
        location.reload();
      } else {
        if (window.showErrorModal) { showErrorModal('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t h√≥a ƒë∆°n')); } else { alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t h√≥a ƒë∆°n')); }
      }
    })
  .catch(error => {
    console.error('Error:', error);
    if (window.showErrorModal) { showErrorModal('L·ªói khi c·∫≠p nh·∫≠t h√≥a ƒë∆°n!'); } else { alert('L·ªói khi c·∫≠p nh·∫≠t h√≥a ƒë∆°n!'); }
  });
}

// In h√≥a ƒë∆°n
function printInvoice(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return;
  const data = {
    so_hd: f.so_hd.value,
    ngay_hd: f.ngay_hd.value,
    nguoi_mua: f.nguoi_mua.value,
    tong_tien: f.tong_tien.value,
    loai_hd: f.loai_hd.value,
    trang_thai: f.trang_thai.value,
  };
  const tongStr = (parseInt(data.tong_tien||0,10)||0).toLocaleString('vi-VN');
  const win = window.open('', '_blank');
  const html = `<!doctype html><html lang="vi"><head><meta charset="utf-8"><title>In h√≥a ƒë∆°n</title>
    <style>
      body{ font-family: Arial, Helvetica, sans-serif; }
      .sheet{ width: 794px; margin:0 auto; }
      .title{ text-align:center; font-weight:bold; font-size:18px; margin:10px 0; }
      table{ width:100%; border-collapse:collapse; }
      td,th{ border:1px dotted #000; padding:6px; font-size:13px; }
      .no-border td{ border:none; }
    </style>
  </head><body onload="window.print(); setTimeout(()=>window.close(), 300);">
  <div class="sheet">
    <div style="display:flex; justify-content:space-between;">
      <div>
        <div><strong>C√îNG TY TNHH MTV TM-DV TIN H·ªåC PHAN HUY·ªÄN</strong></div>
        <div>S·ªë 188/49 T√¢n K·ª≥ T√¢n Qu√Ω, P.S∆°n K·ª≥, Q.T√¢n Ph√∫, TP.HCM</div>
      </div>
      <div style="text-align:right;">Ng√†y ${data.ngay_hd || ''}</div>
    </div>
    <div class="title">H√ìA ƒê∆†N B√ÅN L·∫∫</div>
    <div style="margin-bottom:8px;">S·ªë Hƒê: ${data.so_hd || ''}</div>
    <table class="no-border">
      <tr class="no-border"><td style="width:100px; border:none;">Kh√°ch h√†ng :</td><td style="border:none;">${data.nguoi_mua || ''}</td></tr>
      <tr class="no-border"><td style="border:none;">ƒê·ªãa ch·ªâ :</td><td style="border:none;">............................................................</td></tr>
    </table>
    <table>
      <tr><th>STT</th><th>T√™n S·∫£n Ph·∫©m</th><th>ƒêVT</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr>
      <tr style="height:260px;"><td colspan="6">&nbsp;</td></tr>
      <tr><td colspan="5" style="text-align:right; font-weight:bold;">C·ªông</td><td style="text-align:right; font-weight:bold;">${tongStr}</td></tr>
    </table>
    <div style="margin-top:10px;">B·∫±ng ch·ªØ: ...............................................................</div>
    <div style="margin-top:10px;">H√¨nh th·ª©c thanh to√°n: .................................................</div>
    <table class="no-border" style="margin-top:40px; text-align:center;">
      <tr class="no-border"><td style="border:none;">Kh√°ch h√†ng</td><td style="border:none;">Nh√¢n vi√™n</td></tr>
    </table>
  </div>
  </body></html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
}

function openApproveModal(invoiceId) {
  // Load invoice details for approval
  document.getElementById('approve-invoice-modal').style.display = 'block';
  // In real implementation, fetch invoice details by ID
}

function closeApproveModal() {
  document.getElementById('approve-invoice-modal').style.display = 'none';
}

function approveInvoice() {
  // Implement invoice approval logic
  if (window.showSuccessModal) { showSuccessModal('H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!'); } else { alert('H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát!'); }
  closeApproveModal();
}

function rejectInvoice() {
  // Implement invoice rejection logic
  if (window.showErrorModal) { showErrorModal('H√≥a ƒë∆°n ƒë√£ b·ªã t·ª´ ch·ªëi!'); } else { alert('H√≥a ƒë∆°n ƒë√£ b·ªã t·ª´ ch·ªëi!'); }
  closeApproveModal();
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
  const invoiceModal = document.getElementById('add-invoice-modal');
  const viewInvoiceModal = document.getElementById('view-invoice-modal');
  const approveModal = document.getElementById('approve-invoice-modal');
  const confirmDeleteModal = document.getElementById('confirm-delete-invoice');
  if (event.target === invoiceModal) {
    closeInvoiceModal();
  }
  if (event.target === viewInvoiceModal) {
    closeViewInvoiceModal();
  }
  if (event.target === approveModal) {
    closeApproveModal();
  }
  if (event.target === confirmDeleteModal) {
    closeDeleteInvoiceModal();
  }
});

// Close modals when clicking X
document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
    if (this.closest('#add-invoice-modal')) {
      closeInvoiceModal();
    } else if (this.closest('#view-invoice-modal')) {
      closeViewInvoiceModal();
    } else if (this.closest('#approve-invoice-modal')) {
      closeApproveModal();
    } else if (this.closest('#confirm-delete-invoice')) {
      closeDeleteInvoiceModal();
    }
  }
});

// X·ª≠ l√Ω thay ƒë·ªïi t√†i kho·∫£n trong modal t·∫°o h√≥a ƒë∆°n
function handleTaiKhoanChange() {
  const select = document.getElementById('tai_khoan_select');
  const moiDiv = document.getElementById('tai_khoan_moi_div');
  const hiddenInput = document.getElementById('nguoi_mua_hidden');
  
  if (select.value === 'khac') {
    moiDiv.style.display = 'block';
    hiddenInput.value = '';
    // Khi ch·ªçn "Kh√°c", hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng ho√†n th√†nh
    filterOrdersByCustomer('');
    
    // Th√™m event listener cho input t√™n kh√°ch h√†ng m·ªõi
    const tenTkMoiInput = document.getElementById('ten_tk_moi');
    if (tenTkMoiInput) {
      tenTkMoiInput.addEventListener('input', function() {
        const customerName = this.value.trim();
        filterOrdersByCustomer(customerName);
      });
    }
  } else if (select.value) {
    moiDiv.style.display = 'none';
    const selectedOption = select.options[select.selectedIndex];
    const tenTk = selectedOption.getAttribute('data-ten-tk');
    hiddenInput.value = `${tenTk}`;
    // Khi ch·ªçn kh√°ch h√†ng c·ª• th·ªÉ, l·ªçc ƒë∆°n h√†ng theo kh√°ch h√†ng ƒë√≥
    filterOrdersByCustomer(tenTk);
    // C·∫≠p nh·∫≠t l·∫°i dropdown ƒë∆°n h√†ng
    loadOrdersForSelect();
  } else {
    moiDiv.style.display = 'none';
    hiddenInput.value = '';
    // Khi kh√¥ng ch·ªçn g√¨, hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng ho√†n th√†nh
    filterOrdersByCustomer('');
    // C·∫≠p nh·∫≠t l·∫°i dropdown ƒë∆°n h√†ng
    loadOrdersForSelect();
  }
}

// X·ª≠ l√Ω thay ƒë·ªïi t√†i kho·∫£n trong modal xem chi ti·∫øt
function handleViewTaiKhoanChange() {
  const select = document.getElementById('view_tai_khoan_select');
  const moiDiv = document.getElementById('view_tai_khoan_moi_div');
  const hiddenInput = document.getElementById('view_nguoi_mua_hidden');
  
  if (select.value === 'khac') {
    moiDiv.style.display = 'block';
    hiddenInput.value = '';
  } else if (select.value) {
    moiDiv.style.display = 'none';
    const selectedOption = select.options[select.selectedIndex];
    const tenTk = selectedOption.getAttribute('data-ten-tk');
    hiddenInput.value = `${tenTk}`;
  } else {
    moiDiv.style.display = 'none';
    hiddenInput.value = '';
  }
}

// ƒê·ªãnh d·∫°ng ti·ªÅn: th√™m d·∫•u ',' khi nh·∫≠p v√† ƒë·ªìng b·ªô hidden
function formatMoneyTypingInvoice(displayEl, hiddenEl){
  const raw = (displayEl.value || '').replace(/[^0-9]/g, '');
  if (!raw){ displayEl.value=''; if(hiddenEl) hiddenEl.value=''; return; }
  if (hiddenEl) hiddenEl.value = raw;
  displayEl.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

(function(){
  const d = document.getElementById('invoice_tong_tien_display');
  const h = document.getElementById('invoice_tong_tien');
  if (d && h){
    const sanitize = ()=>{ d.value = d.value.replace(/[^0-9,]/g,''); };
    d.addEventListener('input', sanitize);
    d.addEventListener('blur', sanitize);
  }
  const vd = document.getElementById('view_tong_tien_display');
  const vh = document.getElementById('view_tong_tien');
  if (vd && vh){
    vd.addEventListener('input', function(){ formatMoneyTypingInvoice(vd,vh); });
    vd.addEventListener('blur', function(){ formatMoneyTypingInvoice(vd,vh); });
  }
})();

// Khi ch·ªçn ƒë∆°n h√†ng t·ª´ dropdown ho·∫∑c g·ª£i √Ω -> set t·ªïng ti·ªÅn c√≥ d·∫•u ph·∫©y
function setInvoiceTotalFromOrder(amount){
  const d = document.getElementById('invoice_tong_tien_display');
  const h = document.getElementById('invoice_tong_tien');
  if (d && h){
    const raw = String(parseInt(amount||0,10));
    h.value = raw;
    d.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
}

// Handle form submissions (create invoice)
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('invoice-form');
  if (!form) return;
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(form);
    const taiKhoanId = fd.get('tai_khoan_id');
    let nguoiMuaFinal = fd.get('nguoi_mua') || '';
    if (taiKhoanId === 'khac') {
      const tenMoi = (fd.get('ten_tk_moi') || '').trim();
      if (!tenMoi) { if (window.showErrorModal) { showErrorModal('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng m·ªõi!'); } else { alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng m·ªõi!'); } return; }
      nguoiMuaFinal = tenMoi;
    }
    const payload = {
      so_hd: document.getElementById('auto-so-hd').value,
      ngay_hd: fd.get('ngay_hd'),
      nguoi_mua: nguoiMuaFinal,
      tong_tien: parseFloat(fd.get('tong_tien') || '0'),
      loai_hd: fd.get('loai_hd'),
      trang_thai: fd.get('trang_thai') || 'checking',
      order_id: parseInt(fd.get('order_id') || '0') || null
    };
    if (!payload.so_hd || !payload.ngay_hd || !payload.nguoi_mua || !payload.tong_tien || !payload.loai_hd) {
    if (window.showErrorModal) { showErrorModal('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!'); } else { alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!'); }
    return;
  }
    safeFetch('/api/invoices/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
      .then(r=>r.json())
      .then(data=>{
        if (data && (data.success || data.id)) {
          // RESET TR·∫†NG TH√ÅI THAY ƒê·ªîI SAU KHI T·∫†O TH√ÄNH C√îNG
          addChanged = false;
          addInitialState = null;
          
          if (window.showSuccessModal) { showSuccessModal('T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng!', function(){ location.reload(); }); }
          closeInvoiceModal();
          currentInvoiceNumber++;
          location.reload();
        } else {
          if (window.showErrorModal) { showErrorModal('C√≥ l·ªói x·∫£y ra khi t·∫°o h√≥a ƒë∆°n'); } else { alert('C√≥ l·ªói x·∫£y ra khi t·∫°o h√≥a ƒë∆°n'); }
        }
      })
      .catch(()=> { if (window.showErrorModal) { showErrorModal('C√≥ l·ªói x·∫£y ra khi t·∫°o h√≥a ƒë∆°n'); } else { alert('C√≥ l·ªói x·∫£y ra khi t·∫°o h√≥a ƒë∆°n'); } });
    });
    
    // √Åp d·ª•ng ph√¢n quy·ªÅn cho trang invoices
    if (window.checkUserPermissions) {
      window.checkUserPermissions();
    }
});

function deleteInvoice() {
  const id = document.getElementById('view_invoice_id').value;
  if (!id) { closeDeleteInvoiceModal(); return; }
  safeFetch(`/api/invoices/${id}`, { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
      if (data && data.success) {
        closeDeleteInvoiceModal();
        closeViewInvoiceModal();
        if (window.showSuccessModal) { showSuccessModal('X√≥a h√≥a ƒë∆°n th√†nh c√¥ng!', function(){ location.reload(); }); } else { location.reload(); }
      } else {
        if (window.showErrorModal) { showErrorModal('Kh√¥ng th·ªÉ x√≥a h√≥a ƒë∆°n'); } else { alert('Kh√¥ng th·ªÉ x√≥a h√≥a ƒë∆°n'); }
      }
    })
    .catch(() => { if (window.showErrorModal) { showErrorModal('L·ªói khi x√≥a h√≥a ƒë∆°n'); } else { alert('L·ªói khi x√≥a h√≥a ƒë∆°n'); } });
}

// Hi·ªÉn th·ªã/ƒë√≥ng popup x√°c nh·∫≠n x√≥a h√≥a ƒë∆°n
function confirmDeleteInvoice(){
  const modal = document.getElementById('confirm-delete-invoice');
  if (modal) modal.style.display = 'flex';
}
function closeDeleteInvoiceModal(){
  const modal = document.getElementById('confirm-delete-invoice');
  if (modal) modal.style.display = 'none';
}

let viewInitialState = null;
let viewChanged = false;
function getViewState(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return '';
  const data = {
    so_hd: f.so_hd.value,
    ngay_hd: f.ngay_hd.value,
    nguoi_mua: f.nguoi_mua.value,
    tong_tien: f.tong_tien.value,
    loai_hd: f.loai_hd.value,
    trang_thai: f.trang_thai.value,
  };
  return JSON.stringify(data);
}
function bindViewChangeWatcher(){
  const f = document.getElementById('view-invoice-form');
  if (!f) return;
  const btn = f.parentElement.querySelector('.save-btn');
  viewChanged = false;
  
  const check = ()=>{
    const currentState = getViewState();
    const hasChanged = currentState !== viewInitialState;
    viewChanged = hasChanged;
    if (btn) btn.disabled = !hasChanged;
    console.log('üîÑ Tr·∫°ng th√°i thay ƒë·ªïi (view):', hasChanged ? 'C√ì THAY ƒê·ªîI' : 'KH√îNG THAY ƒê·ªîI');
  };
  
  f.querySelectorAll('input,select,textarea').forEach(el=>{ 
    el.addEventListener('input', check); 
    el.addEventListener('change', check); 
  });
  
  // set initial
  viewInitialState = getViewState();
  if (btn) btn.disabled = true;
  console.log('üîÑ ƒê√£ kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu cho modal xem h√≥a ƒë∆°n');
}

// G·∫Øn s·ª± ki·ªán cho c√°c n√∫t trong popup xem h√≥a ƒë∆°n
 (function(){
  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'btnUpdateInvoice'){ updateInvoice(); }
    if (e.target && e.target.id === 'btnPrintInvoice'){ printInvoice(); }
    if (e.target && e.target.id === 'btnDeleteInvoice'){ confirmDeleteInvoice(); }
  });
})();

// ===================== C·∫£nh b√°o khi tho√°t n·∫øu d·ªØ li·ªáu thay ƒë·ªïi =====================
let addInitialState = null;
let addChanged = false;
function getAddState(){
  const f = document.getElementById('invoice-form');
  if (!f) return '';
  const data = {
    so_hd: f.so_hd?.value || document.getElementById('auto-so-hd')?.value || '',
    ngay_hd: f.ngay_hd?.value || '',
    nguoi_mua: document.getElementById('nguoi_mua_hidden')?.value || '',
    tong_tien: f.tong_tien?.value || document.getElementById('invoice_tong_tien')?.value || '',
    loai_hd: f.loai_hd?.value || '',
    trang_thai: f.trang_thai?.value || ''
  };
  return JSON.stringify(data);
}

function bindAddChangeWatcher(){
  const f = document.getElementById('invoice-form');
  if (!f) return;
  addChanged = false;
  
  const update = ()=>{
    const currentState = getAddState();
    const hasChanged = currentState !== addInitialState;
    addChanged = hasChanged;
    console.log('üîÑ Tr·∫°ng th√°i thay ƒë·ªïi:', hasChanged ? 'C√ì THAY ƒê·ªîI' : 'KH√îNG THAY ƒê·ªîI');
  };
  
  f.querySelectorAll('input,select,textarea').forEach(el=>{ 
    el.addEventListener('input', update); 
    el.addEventListener('change', update); 
  });
  
  addInitialState = getAddState();
  console.log('üîÑ ƒê√£ kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu cho modal t·∫°o h√≥a ƒë∆°n');
}

// Wrap openAddInvoiceModal to capture initial state
const __openAddInvoiceModal = openAddInvoiceModal;
openAddInvoiceModal = function(){
  __openAddInvoiceModal();
  bindAddChangeWatcher();
};

// H√†m reset tr·∫°ng th√°i thay ƒë·ªïi
function resetAddChangeState() {
  addChanged = false;
  addInitialState = null;
  console.log('üîÑ ƒê√£ reset tr·∫°ng th√°i thay ƒë·ªïi cho modal t·∫°o h√≥a ƒë∆°n');
}

function resetViewChangeState() {
  viewChanged = false;
  viewInitialState = null;
  console.log('üîÑ ƒê√£ reset tr·∫°ng th√°i thay ƒë·ªïi cho modal xem h√≥a ƒë∆°n');
}

function openConfirmExit(cb){
  const m = document.getElementById('confirm-exit-invoice');
  if (!m) return cb && cb();
  m.style.display = 'flex';
  const yes = document.getElementById('btnConfirmExitYes');
  const no = document.getElementById('btnConfirmExitNo');
  const cleanup = ()=>{ m.style.display='none'; yes.onclick=null; no.onclick=null; };
  yes.onclick = ()=>{ cleanup(); if (cb) cb(); };
  no.onclick = ()=>{ cleanup(); };
}

const __closeInvoiceModal = closeInvoiceModal;
closeInvoiceModal = function(){
  const f = document.getElementById('invoice-form');
  if (f && addChanged === true){
    return openConfirmExit(()=>{ 
      resetAddChangeState(); 
      __closeInvoiceModal(); 
    });
  }
  resetAddChangeState();
  __closeInvoiceModal();
};

// Click outside add modal
window.addEventListener('click', function(e){
  const m = document.getElementById('add-invoice-modal');
  if (e.target === m){
    const f = document.getElementById('invoice-form');
    if (f && addChanged === true){
      openConfirmExit(()=>{ addInitialState=null; __closeInvoiceModal(); });
    } else {
      __closeInvoiceModal();
    }
  }
});

// B·ªò L·ªåC M·ªöI: L·ªçc ƒë∆°n h√†ng theo kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn
function filterOrdersByCustomer(customerName) {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  console.log(`üéØ B·ªò L·ªåC M·ªöI: B·∫Øt ƒë·∫ßu l·ªçc cho kh√°ch h√†ng "${customerName}"`);
  
  const allOptions = orderSelect.querySelectorAll('option');
  
  // Reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu - hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
  allOptions.forEach(option => {
    if (option.value && option.value !== 'khac') {
      option.style.display = '';
    }
  });
  
  // N·∫øu c√≥ ch·ªçn kh√°ch h√†ng c·ª• th·ªÉ, ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng ƒë√≥
  if (customerName && customerName.trim() !== '' && customerName !== 'Ch·ªçn t√†i kho·∫£n kh√°ch h√†ng') {
    let shown = 0;
    let hidden = 0;
    
    allOptions.forEach(option => {
      if (option.value && option.value !== 'khac') {
        const optionCustomer = option.getAttribute('data-customer-name') || option.dataset.customer || '';
        
        // SO S√ÅNH CH√çNH X√ÅC: ch·ªâ hi·ªÉn th·ªã n·∫øu t√™n kh√°ch h√†ng kh·ªõp ho√†n to√†n
        const isMatch = optionCustomer === customerName;
        
        if (isMatch) {
          shown++;
          console.log(`‚úÖ Hi·ªÉn th·ªã: "${option.textContent}" (kh√°ch h√†ng: "${optionCustomer}")`);
        } else {
          option.style.display = 'none';
          hidden++;
          console.log(`‚ùå ·∫®n: "${option.textContent}" (kh√°ch h√†ng: "${optionCustomer}")`);
        }
      }
    });
    
    console.log(`üìä B·ªò L·ªåC M·ªöI: ${shown} hi·ªÉn th·ªã, ${hidden} ·∫©n`);
    
    // N·∫øu kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o, hi·ªÉn th·ªã t·∫•t c·∫£
    if (shown === 0) {
      console.log(`‚ö†Ô∏è B·ªò L·ªåC M·ªöI: Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng cho "${customerName}", hi·ªÉn th·ªã t·∫•t c·∫£`);
      allOptions.forEach(option => {
        if (option.value && option.value !== 'khac') {
          option.style.display = '';
        }
      });
    }
  } else {
    console.log(`‚úÖ B·ªò L·ªåC M·ªöI: Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng (kh√¥ng c√≥ b·ªô l·ªçc)`);
  }
  
  // Reset selection
  orderSelect.value = '';
  
  console.log(`‚úÖ B·ªò L·ªåC M·ªöI: Ho√†n th√†nh l·ªçc cho kh√°ch h√†ng "${customerName}"`);
}

// X·ª≠ l√Ω khi ch·ªçn ƒë∆°n h√†ng t·ª´ dropdown
function handleOrderSelectChange() {
  const orderSelect = document.getElementById('order-select');
  const selectedOption = orderSelect.options[orderSelect.selectedIndex];
  
  console.log('Order selected:', orderSelect.value);
  console.log('Selected option:', selectedOption);
  
  if (orderSelect.value === 'khac') {
    // Hi·ªÉn th·ªã √¥ nh·∫≠p th·ªß c√¥ng
    document.getElementById('order-search').style.display = 'block';
    document.getElementById('order-results').style.display = 'none';
    
    // Reset c√°c tr∆∞·ªùng kh√°c
    document.getElementById('nguoi_mua_hidden').value = '';
    document.getElementById('invoice_tong_tien').value = '';
    document.getElementById('selected_order_id').value = '';
    
    // Reset customer name v√† total amount
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = '';
    if (totalInput) totalInput.value = '';
    
  } else if (orderSelect.value) {
    console.log('üéØ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Ch·ªçn ƒë∆°n h√†ng t·ª´ dropdown:', orderSelect.value);
    
    // ·∫®n √¥ nh·∫≠p th·ªß c√¥ng
    document.getElementById('order-search').style.display = 'none';
    document.getElementById('order-results').style.display = 'none';
    
    // L·∫•y th√¥ng tin t·ª´ option ƒë∆∞·ª£c ch·ªçn
    const customer = selectedOption.getAttribute('data-customer');
    const amount = selectedOption.getAttribute('data-amount');
    const orderId = selectedOption.getAttribute('data-order-id');
    
    console.log(`üéØ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Th√¥ng tin ƒë∆°n h√†ng - Kh√°ch h√†ng: "${customer}", T·ªïng ti·ªÅn: ${amount}`);
    
    // T·ª∞ ƒê·ªòNG ƒêI·ªÄN T√äN KH√ÅCH H√ÄNG V√ÄO DROPDOWN
    const customerSelect = document.getElementById('tai_khoan_select');
    if (customerSelect && customer) {
      console.log(`üéØ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: T√¨m kh√°ch h√†ng "${customer}" trong dropdown kh√°ch h√†ng`);
      
      // T√¨m option kh√°ch h√†ng ph√π h·ª£p
      let found = false;
      for (let i = 0; i < customerSelect.options.length; i++) {
        const option = customerSelect.options[i];
        if (option.textContent.trim() === customer.trim()) {
          customerSelect.selectedIndex = i;
          console.log(`‚úÖ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: ƒê√£ ch·ªçn kh√°ch h√†ng "${customer}" trong dropdown`);
          found = true;
          break;
        }
      }
      
      if (!found) {
        console.log(`‚ö†Ô∏è T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng "${customer}" trong dropdown`);
      }
    }
    
    // ƒêi·ªÅn th√¥ng tin v√†o form
    document.getElementById('nguoi_mua_hidden').value = customer;
    document.getElementById('invoice_tong_tien').value = amount;
    document.getElementById('selected_order_id').value = orderId;
    
    // ƒêi·ªÅn customer name v√† total amount
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = customer;
    if (totalInput) totalInput.value = amount;
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i form ƒë·ªÉ theo d√µi thay ƒë·ªïi
    if (typeof addChanged !== 'undefined') {
      addChanged = true;
    }
    
    console.log('‚úÖ T·ª∞ ƒê·ªòNG ƒêI·ªÄN: Ho√†n th√†nh ƒëi·ªÅn th√¥ng tin t·ª´ dropdown');
  } else {
    // Kh√¥ng ch·ªçn g√¨ - ·∫©n √¥ nh·∫≠p th·ªß c√¥ng
    document.getElementById('order-search').style.display = 'none';
    document.getElementById('order-results').style.display = 'none';
    
    // Reset c√°c tr∆∞·ªùng
    document.getElementById('nguoi_mua_hidden').value = '';
    document.getElementById('invoice_tong_tien').value = '';
    document.getElementById('selected_order_id').value = '';
    
    const customerInput = document.querySelector('input[name="nguoi_mua"]');
    const totalInput = document.querySelector('input[name="tong_tien"]');
    if (customerInput) customerInput.value = '';
    if (totalInput) totalInput.value = '';
  }
}

// H√†m debug ƒë·ªÉ ki·ªÉm tra ƒë∆°n h√†ng tr√πng l·∫∑p
function debugCheckDuplicates() {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  const options = Array.from(orderSelect.options);
  const codes = options.map(opt => opt.value).filter(v => v && v !== 'khac');
  const duplicates = codes.filter((code, index) => codes.indexOf(code) !== index);
  
  if (duplicates.length > 0) {
    console.warn('‚ö†Ô∏è Ph√°t hi·ªán ƒë∆°n h√†ng tr√πng l·∫∑p:', duplicates);
    // T·ª± ƒë·ªông x√≥a tr√πng l·∫∑p
    removeDuplicateOptions();
  } else {
    console.log('‚úÖ Kh√¥ng c√≥ ƒë∆°n h√†ng tr√πng l·∫∑p');
  }
  
  console.log(`üìä T·ªïng s·ªë options: ${options.length}, S·ªë ƒë∆°n h√†ng: ${codes.length}`);
}

// H√†m x√≥a c√°c option tr√πng l·∫∑p kh·ªèi dropdown
function removeDuplicateOptions() {
  const orderSelect = document.getElementById('order-select');
  if (!orderSelect) return;
  
  const options = Array.from(orderSelect.options);
  const seen = new Set();
  const toRemove = [];
  
  options.forEach((option, index) => {
    if (option.value && option.value !== 'khac') {
      if (seen.has(option.value)) {
        toRemove.push(index);
        console.log(`üóëÔ∏è S·∫Ω x√≥a option tr√πng l·∫∑p: ${option.textContent}`);
      } else {
        seen.add(option.value);
      }
    }
  });
  
  // X√≥a t·ª´ cu·ªëi l√™n ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn index
  toRemove.reverse().forEach(index => {
    orderSelect.remove(index);
  });
  
  if (toRemove.length > 0) {
    console.log(`‚úÖ ƒê√£ x√≥a ${toRemove.length} option tr√πng l·∫∑p`);
  }
}

// For view modal (edit): reuse viewInitialState/getViewState
const __closeViewInvoiceModal = closeViewInvoiceModal;
closeViewInvoiceModal = function(){
  const f = document.getElementById('view-invoice-form');
  if (f && viewChanged === true){
    return openConfirmExit(()=>{ 
      resetViewChangeState(); 
      __closeViewInvoiceModal(); 
    });
  }
  resetViewChangeState();
  __closeViewInvoiceModal();
};

window.addEventListener('click', function(e){
  const m = document.getElementById('view-invoice-modal');
  if (e.target === m){
    const f = document.getElementById('view-invoice-form');
    if (f && viewChanged === true){
      openConfirmExit(()=>{ viewInitialState=null; __closeViewInvoiceModal(); });
    } else {
      __closeViewInvoiceModal();
    }
  }
});

</script>
{% endblock %}